"use strict";var arloApp=angular.module("arloApp",["ngAnimate","arloApp.filters","ui.bootstrap","ui.bootstrap.tooltip","ui.router","arloApp.services","arloApp.directives","arloApp.controllers","localization","arloPartials"]).constant("appProperties",{passwordHelpContext:"/passwordHelp",logoutContext:"/logout",devicesContext:"/users/devices",syncBaseStationContext:"/users/devices/update",notifyContext:"/users/devices/notify",notifyResponsesPushServiceContext:"/client/subscribe",claimDeviceContext:"/users/devices/claimDevice",streamContext:"/users/devices/startStream",stopStreamContext:"/users/devices/stopStream",startRecordContext:"/users/devices/startRecord",stopRecordContext:"/users/devices/stopRecord",takeSnapshotContext:"/users/devices/takeSnapshot",takeFullFrameSnapshotContext:"/users/devices/fullFrameSnapshot",takeUserFrameSnapshotContext:"/users/devices/userSnapshot",metadataContext:"/users/library/metadata",recordingsContext:"/users/library",libraryStateContext:"/users/library/state/v1",editContext:"/users/media",favoriteContext:"/users/library/favorite",profileContext:"/users/profile",registerContext:"/register",ssoRegisterContext:"/ssoregister",friendsContext:"/users/friends",friendsDeleteContext:"/users/friends/remove",queryPresentDevicesContext:"/locateDevice",updateNameContext:"/user",updatePasswordContext:"/users/changePassword",requestPasswordResetContext:"/requestPasswordReset",resetPasswordContext:"/resetPassword",updateUserIdContext:"/users/changeEmail",confirmUserIdContext:"/users/resend/confirm/email",jsonContext:"/json",staticContext:"/static",recycleContext:"/users/library/recycle",getOffersContext:"/users/payment/offers",getOffersV1Context:"/users/payment/offers/v1",getOffersDetailsContext:"/users/payment/offersdetail",createPaymentAccountContext:"/users/payment/accounts",paymentQuotationContext:"/users/payment/quotations",paymentBillingContext:"/users/payment/billing",paymentRenewContext:"/users/payment/autoRenew",servicePlanContext:"/users/serviceLevel",servicePlansPaymentContext:"/users/payment/plans",upgradeContext:"/upgrade",checkEmailUsage:"/checkEmailUsage",checkAccountUsage:"/checkAccountUsage",cameraOrderContext:"/users/devices/displayOrder",deleteAccountContext:"/users/closeAccount",removeDeviceContext:"/users/devices/removeDevice",renameDeviceContext:"/users/devices/renameDevice",restartDeviceContext:"/users/devices/restart",preferencesContext:"/users/preferences",storageQuotaContext:"/users/quota",termsContext:"/termsAndConditions",policyContext:"/policy/v1",updateTermsContext:"/users/termsAndConditions",updatePolicyContext:"/users/policy",renewContext:"/renew",cancelContext:"/cancel",changeContext:"/change",allContext:"/all",_RESOURCE_UPDATE_:"_RESOURCE_UPDATE_",DEVICE_UPDATE:"DEVICE_UPDATE",BILLING_EVENT:"BILLING_EVENT",urlTld:".com",portNo:":8080",registerTokenText:"registrationtoken",resetPasswordTokenText:"passwordresetcode=",loginRoute:"/login",claimBaseStationRoute:"/claimBaseStation",accountRegistrationRoute:"/accountRegistration",billingInformationRoute:"/billingInformation",syncHardwareRoute:"/syncHardware",calendarRoute:"/calendar",camerasRoute:"/cameras",dayRoute:"/day",recordingRoute:"/recording",recordingSharedRoute:"/viewShared",settingsRoute:"/settings",cameraSettingsRoute:"/settings/camera",listFriendsRoute:"/friends/list",editFriendRoute:"/friends/edit/",personalInfoRoute:"/settings/personalInfo",modesRoute:"/modes",editModeRoute:"/modes/edit",rulesRoute:"/rules",editRuleRoute:"/rule",alertEmailsRoute:"/alerts/emails",editAlertsRoute:"/alerts",scheduleRoute:"/schedule",dailyScheduleRoute:"/schedule/daily",weeklyScheduleRoute:"/schedule/weekly",servicePlanRoute:"/plans/select",upgradeServicePlanRoute:"/plans/select/upgrade",upgradeStoragePlanRoute:"/plans/storage/upgrade",FREE_PLAN_TYPE:"BASIC",PAID_PLAN_TYPE:"SERVICE",STORAGE_PLAN_TYPE:"STORAGE",ONE_MEGA:1048576,videoFormat:"video/mp4",HTML5:"HTML5",JWPLAYER:"JWPLAYER",FLOWPLAYER:"FLOWPLAYER",REGISTRATION_TOKEN:"registrationToken",ACCEPTANCE_PENDING:"pending",BASE_STATION_DEVICE_TYPE:"basestation",CAMERA_DEVICE_TYPE:"camera",FAVORITE_STATE:"favorite",NEW_STATE:"new",REMOVED_STATE:"removed",DEACTIVATED_STATE:"deactivated",RECYCLE_STATE:"recycle",PROVISIONED_STATE:"provisioned",SYNCED_STATE:"synced",AVAILABLE_STATE:"available",UNAVAILABLE_STATE:"unavailable",DEVICE_ACTIONS:["recordActiveMotionVideo","recordSnapshot","sendEmailAlert"],DEVICE_TRIGGERS:["motionDetect","lowBattery","lowSignalStrength"],DEVICE_TRANSACTION_PREFIX:"basestation",WEB_TRANSACTION_PREFIX:"web",DEVICE_SETTINGS_ACTIVE:"active",DEVICE_SCHEDULE:"schedule",CAMERA_SETTINGS_ACTIVITYSTATE:"activityState",CAMERA_SETTINGS_ACTIVITYSTATE_POSITION_MODE:"startPositionStream",CAMERA_ACTIVITYSTATE_START_ALERT_STREAM:"startAlertStream",CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE:"alertStreamActive",CAMERA_ACTIVITYSTATE_ALERT_SNAPSHOT:"alertSnapshot",CAMERA_ACTIVITYSTATE_ALERT_WATCH:"alertStreamActiveWatchAlong",CAMERA_ACTIVITYSTATE_FULLFRAMESNAPSHOT:"fullFrameSnapshot",CAMERA_SETTINGS_ACTIVITYSTATE_MOTION_DETECTION_MODE:"setupMotionStart",CAMERA_SETTINGS_ACTIVITYSTATE_IDLE:"idle",CAMERA_SETTINGS_ACTIVITYSTATE_STREAM:"startUserStream",CAMERA_SETTINGS_ACTIVITYSTATE_ACTIVESTREAM:"userStreamActive",CONNECTION_STATE:"connectionState",CAMERA_CONNECTION_STATE:"connectionState",CAMERA_CONNECTION_STATE_AVAILABLE:"available",CAMERA_CONNECTION_STATE_BATTERY_CRITICAL:"batteryCritical",CAMERA_CONNECTION_STATE_UNAVAILABLE:"unavailable",CAMERAS_ALL_SELECTED:"all",POSITION_MODE_DURATION:3e5,CAMERA_SETTINGS_POWERSAVEMODE:"powerSaveMode",CAMERA_SETTINGS_POWERSAVEMODE_BEST_VIDEO:3,CAMERA_SETTINGS_POWERSAVEMODE_OPTIMIZED:2,CAMERA_SETTINGS_POWERSAVEMODE_BATTERY_LIFE:1,CAMERA_SETTINGS_BRIGHTNESS:"brightness",CAMERA_SETTINGS_MIRROR:"mirror",CAMERA_SETTINGS_FLIP:"flip",CAMERA_SETTINGS_ZOOM:"zoom",CAMERA_STATUS_BATTERY_LEVEL:"batteryLevel",CAMERA_STATUS_SIGNAL_STRENGTH:"signalStrength",CAMERA_STATUS_MOTION:"motion",SENSOR_MOTION_DETECTION_STATE:"pirMotionActive",CSS_CAMERA_MOTION_DISABLED:"0",CSS_CAMERA_MOTION_ACTIVE:"1",CSS_CAMERA_MOTION_ARMED:"2",USER_ROLE_OWNER:"OWNER",USER_ROLE_ADMIN:"ADMIN",USER_ROLE_USER:"USER",favoritesOptions:[{value:"all",text:"filter_label_all"},{value:"only",text:"filter_label_favorites"},{value:"non",text:"filter_label_non_favorites"}],timeZoneHash:[{offset:"660",id:"WST11"},{offset:"600",id:"HST10"},{offset:"540",id:"AKST9AKDT,M3.2.0,M11.1.0"},{offset:"480",id:"PST8PDT,M3.2.0,M11.1.0"},{offset:"420",id:"MST7MDT,M3.2.0,M11.1.0"},{offset:"420",id:"MST7"},{offset:"360",id:"CST6CDT,M3.2.0,M11.1.0"},{offset:"300",id:"EST5EDT,M3.2.0,M11.1.0"},{offset:"270",id:"VET4:30"},{offset:"240",id:"CLT"},{offset:"210",id:"NST3:30NDT,M3.2.0/0:01,M11.1.0/0:01"},{offset:"180",id:"BRT3BRST,M10.3.0/0,M2.3.0/0"},{offset:"60",id:"CVT1"},{offset:"0",id:"GMT0BST,M3.5.0/1,M10.5.0"},{offset:"-60",id:"CET-1CEST,M3.5.0,M10.5.0/3"},{offset:"-120",id:"EET-2EEST,M3.5.0/3,M10.5.0/4"},{offset:"-180",id:"MSK-4"},{offset:"-210",id:"IRST"},{offset:"-240",id:"GST-4"},{offset:"-270",id:"AFT-4:30"},{offset:"-300",id:"PKT-5"},{offset:"-330",id:"IST-5:30"},{offset:"-360",id:"BDT-6"},{offset:"-390",id:"MMT-6:30"},{offset:"-420",id:"WIT-7"},{offset:"-480",id:"CST-8"},{offset:"-540",id:"JST-9"},{offset:"-570",id:"CST-9:30CST,M10.1.0,M4.1.0/3"},{offset:"-600",id:"EST-10EST,M10.1.0,M4.1.0/3"},{offset:"-660",id:"NCT-11"},{offset:"-720",id:"NZST-12NZDT,M9.5.0,M4.1.0/3"},{offset:"-780",id:"TOT-13"}],appEvents:{BODY_CLICK:"body_click",TAKE_SNAPSHOT:"take_snapshot",SNAPSHOT_LOADED:"snapshot_loaded",SHOW_ERROR:"show_error",HIDE_ERROR:"hide_error",CAMERA_BUSY:"camera_busy",CAMERA_ERROR:"camera_error",SCROLL_TOP:"scrollTop",BRIGHTNESS_UPDATED:"brightness_updated",BS_REBOOTED:"bs_rebooted",MEDIA_UPLOAD_NOTIFICATION:"mediaUploadNotification"}}).value("localStorage",window.localStorage).value("sessionStorage",window.sessionStorage).config(["$sceProvider","$locationProvider","$compileProvider","$httpProvider","$logProvider",function(e,t,r,n,i){r.aHrefSanitizationWhitelist(/^\s*(https?|mailto|file):/),n.defaults.useXDomain=!0,delete n.defaults.headers.common["X-REQUESTED-WITH"],e.enabled(!1),window._DEBUG_&&i.debugEnabled(_DEBUG_),n.interceptors.push("authInterceptor")}]).config(["$stateProvider","$urlRouterProvider","appProperties",function(e,t,r){e.state("login",{url:"/login",templateUrl:"partials/loginView.html",controller:"LoginCtrl",authenticate:!1,viewName:"Login",accViewName:"AcctMgr_Login"}).state("useMobile",{url:"/useMobile",templateUrl:"partials/useMobileView.html",authenticate:!1,viewName:"UseMobile"}).state("oldBrowser",{url:"/oldBrowser",templateUrl:"partials/oldBrowserView.html",controller:"ShutdownCtrl",authenticate:!1,viewName:"OldBrowser"}).state("otherTab",{url:"/otherTab",templateUrl:"partials/otherTabView.html",controller:"ShutdownCtrl",authenticate:!1,viewName:""}).state("gettingStarted",{url:"/gettingStarted",templateUrl:"partials/gettingStartedView.html",authenticate:!1,viewName:"NewSystemSetup_GettingStarted"}).state("claimBaseStation",{url:"/claimBaseStation",templateUrl:"partials/claimBaseStationView.html",controller:"ClaimBaseStationCtrl",authenticate:!1,viewName:"NewSystemSetup_LocateDevices"}).state("passwordHelp",{url:r.passwordHelpContext,templateUrl:"partials/passwordHelpView.html",controller:"PasswordHelpCtrl",authenticate:!1,viewName:"PasswordHelp"}).state("accountRegistration",{url:"/accountRegistration",templateUrl:"partials/accountRegistrationView.html",controller:"AccountRegistrationCtrl",authenticate:!1,viewName:"NewSystemSetup_AccountSetup"}).state("servicePlan",{url:r.servicePlanRoute,templateUrl:"partials/selectServicePlanView.html",controller:"SelectServicePlanCtrl",authenticate:!1,viewName:"NewSystemSetup_GetOffers"}).state("billingInformation",{url:r.billingInformationRoute,templateUrl:"partials/billingInformationView.html",controller:"BillingInformationCtrl",authenticate:!1,viewName:"NewSystemSetup_PaymentMethod"}).state("syncHardware",{url:r.syncHardwareRoute,templateUrl:"partials/syncHardwareView.html",controller:"SyncHardwareCtrl",authenticate:!1,viewName:"NewSystemSetup_SyncCameras"}).state("modes",{url:r.modesRoute,templateUrl:"partials/footerModesView.html",controller:"FooterModesCtrl",authenticate:!0,viewName:"Mode_Manual"}).state("cameras",{url:r.camerasRoute,templateUrl:"partials/camerasView.html",controller:"CamerasCtrl",authenticate:!0,viewName:"Cameras"}).state("calendar",{url:r.calendarRoute+"/:month/:favorites/:cameraIds/:day",templateUrl:"partials/calendarView.html",controller:"CalendarCtrl",authenticate:!0,viewName:""}).state("calendar.day",{url:"/day",templateUrl:"partials/dayView.html",controller:"DayCtrl",authenticate:!0,viewName:""}).state("calendar.recycled",{url:"/recycled",templateUrl:"partials/recycleView.html",controller:"RecycledCtrl",authenticate:!0,viewName:"Library_Recycled"}).state("recording",{url:r.recordingRoute+"/:favorites/:cameraIds/:recordingNumber",templateUrl:"partials/recordingView.html",controller:"RecordingCtrl",authenticate:!0,viewName:"Library_Carousel"}).state("recordingShared",{url:r.recordingSharedRoute+"/:token",templateUrl:"partials/sharedRecordingView.html",controller:"SharedRecordingCtrl",authenticate:!1,viewName:"Library_SharedCarousel"}).state("recordingShared2",{url:"/shared/:token",templateUrl:"partials/sharedRecordingView.html",controller:"SharedRecordingCtrl",authenticate:!1,viewName:"Library_SharedCarousel"}).state("settings",{url:r.settingsRoute,templateUrl:"partials/settingsView.html",controller:"SettingsCtrl",authenticate:!0,viewName:"Settings"}).state("settings.camera",{url:"/camera/:deviceId",templateUrl:"partials/cameraSettingsView.html",controller:"CameraSettingsCtrl",authenticate:!0,viewName:"CameraSettings_Main"}).state("settings.personalInfo",{url:"/personalInfo",templateUrl:"partials/personalInfoView.html",controller:"PersonalInfoCtrl",authenticate:!0,viewName:"PersonalInformation",accViewName:"AcctMgr_PersonalInformation"}).state("settings.friends",{url:"/friends",templateUrl:"partials/friendsView.html",controller:"FriendsCtrl",authenticate:!0,viewName:"Friends"}).state("settings.editFriend",{url:"/friends/edit/:email",templateUrl:"partials/editFriendView.html",controller:"EditFriendCtrl",authenticate:!0,viewName:"Friends_Edit"}).state("settings.addFriend",{url:"/friends/add",templateUrl:"partials/editFriendView.html",controller:"EditFriendCtrl",authenticate:!0,viewName:"Friends_Add"}).state("settings.modes",{url:"/modes/:deviceId",templateUrl:"partials/modesView.html",controller:"ModesCtrl",authenticate:!0,viewName:"BaseStationModes"}).state("settings.editMode",{url:"/modes/edit/:deviceId/:modeId",templateUrl:"partials/editModeView.html",controller:"EditModeCtrl",authenticate:!0,viewName:"BaseStationModes_Edit"}).state("settings.addMode",{url:"/modes/edit/:deviceId",templateUrl:"partials/editModeView.html",controller:"EditModeCtrl",authenticate:!0,viewName:"BaseStationModes_Add"}).state("settings.rules",{url:"/rules/:deviceId",templateUrl:"partials/rulesView.html",controller:"RulesCtrl",authenticate:!0,viewName:"BaseStationRules"}).state("settings.editRule",{url:"/modes/rule/edit/:baseStationId/:ruleId",templateUrl:"partials/editRuleView.html",controller:"EditRuleCtrl",authenticate:!0,viewName:"BaseStationRules_Edit"}).state("settings.addRule",{url:"/modes/rule/add/:baseStationId",templateUrl:"partials/editRuleView.html",controller:"EditRuleCtrl",authenticate:!0,viewName:"BaseStationRules_Add"}).state("settings.cameraOrder",{url:"/cameraOrder",templateUrl:"partials/cameraOrderView.html",controller:"CameraOrderCtrl",authenticate:!0,viewName:"SystemSettings_CameraOrder"}).state("settings.help",{url:"/help",templateUrl:"partials/helpView.html",authenticate:!0,viewName:"SystemSettings_Help"}).state("settings.about",{url:"/about",templateUrl:"partials/settingsAboutView.html",controller:"AboutCtrl",authenticate:!0,viewName:"SystemSettings_About"}).state("settings.baseStation",{url:"/baseStation/:baseStationId",templateUrl:"partials/settingsBaseStationView.html",controller:"BaseStationCtrl",authenticate:!0,viewName:"BaseStationSettings_Main"}).state("settings.baseStation.update",{url:"/update",templateUrl:"partials/settingsBaseStationUpdateView.html",controller:"BaseStationUpdateCtrl",authenticate:!0,viewName:"BaseStationSettings_Update"}).state("settings.subscription",{url:"/subscription",templateUrl:"partials/settingsSubscriptionView.html",controller:"SubscriptionCtrl",reload:!0,authenticate:!0,viewName:"Subscription",accViewName:"AcctMgr_Subscription"}).state("settings.plans",{url:"/subscription/plans",templateUrl:"partials/settingsSelectPlanView.html",controller:"SubscriptionPlansCtrl",reload:!0,authenticate:!0,viewName:"Subscription_UpgradeOffers",accViewName:"AcctMgr_Subscription_UpgradeOffers"}).state("settings.billingInformation",{url:r.billingInformationRoute,templateUrl:"partials/billingInformationView.html",controller:"BillingInformationCtrl",authenticate:!0,viewName:"Subscription_PaymentMethod",accViewName:"AcctMgr_Subscription_PaymentMethod"}).state("settings.preferences",{url:"/preferences",templateUrl:"partials/settingsPreferencesView.html",controller:"PreferencesCtrl",authenticate:!0,viewName:"SystemSettings_Preferences"}).state("settings.positionMode",{url:"/positionMode/:deviceId",templateUrl:"partials/positionModeView.html",controller:"CamerasCtrl",authenticate:!0,viewName:"CameraSettings_PositionMode"}).state("settings.motionTest",{url:"/motionTest/:deviceId",templateUrl:"partials/motionTestView.html",controller:"motionTestCtrl",authenticate:!0,viewName:"CameraSettings_MotionDetectionTest"}),t.otherwise("/login")}]).run(["$rootScope","$state","$http","urlService","calendarService","libraryService","appProperties","userService","appStateService","pushHandlerService","utilService","sessionExpire","offlineService","loginService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g){n.setWebUrl(),c.loadSessionData(),i.setDefaultMonth(),a.setFavorites(o.favoritesOptions[0]);var p=timezoneJS.timezone;p.loadingScheme=p.loadingSchemes.MANUAL_LOAD,p.transport=function(e){r.get(e.url).then(function(t){e.success(t.data)})},p.loadZoneJSONData("/json/tz_cities.json?v=VERSION",!1),e.$on("$stateChangeStart",function(e,r,n,i){return r.authenticate&&!s.isLoggedIn()?(e.preventDefault(),t.go("login"),!1):r.authenticate&&s.isLoggedIn()&&l.checkMobile()?(e.preventDefault(),r.accViewName?l.gaSend(r.accViewName):r.viewName&&l.gaSend(r.viewName),!1):(i["abstract"]&&s.isLoggedIn()&&s.settings&&g.checkCredentials(s.userName,s.getSettings()),r.authenticate&&s.isLoggedIn()&&!d.notifyResponsesSource&&(f.init(),d.init()),void(r.accViewName?l.gaSend(r.accViewName):r.viewName&&l.gaSend(r.viewName)))}),u.init()}]);angular.module("arloApp.services.calendarNamesService",[]).factory("calendarNamesService",["appProperties","$location","utilService",function(e,t,r){return{getCalendar:function(){if(this.calendar)return this.calendar;var e=r.getLang();return this.calendar=this.cal[e],this.calendar||(this.calendar=this.cal.en),this.calendar},cal:{en:{AMPMS:["AM","PM"],DAY:["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],MONTH:["January","February","March","April","May","June","July","August","September","October","November","December"],SHORTDAY:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],SHORTMONTH:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},de:{AMPMS:["vorm.","nachm."],DAY:["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"],MONTH:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],SHORTDAY:["So.","Mo.","Di.","Mi.","Do.","Fr.","Sa."],SHORTMONTH:["Jan.","Feb.","März","Apr.","Mai","Juni","Juli","Aug.","Sep.","Okt.","Nov.","Dez."]},fr:{AMPMS:["AM","PM"],DAY:["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"],MONTH:["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"],SHORTDAY:["dim.","lun.","mar.","mer.","jeu.","ven.","sam."],SHORTMONTH:["janv.","févr.","mars","avr.","mai","juin","juil.","août","sept.","oct.","nov.","déc."]},it:{AMPMS:["AM","PM"],DAY:["lunedì","martedì","mercoledì","giovedì","venerdì","sabato","domenica"],MONTH:["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"],SHORTDAY:["dom","lun","mar","mer","gio","ven","sab"],SHORTMONTH:["gen","feb","mar","apr","mag","giu","lug","ago","set","ott","nov","dic"]},ru:{AMPMS:["AM","PM"],DAY:["понедельник","вторник","среда","четверг","пятница","суббота","воскресенье"],MONTH:["январь","февраль","март","апрель","мая","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],SHORTDAY:["вс","пн","вт","ср","чт","пт","сб"],SHORTMONTH:["янв.","февр.","марта","апр.","мая","июня","июля","авг.","сент.","окт.","нояб.","дек."]},ja:{AMPMS:["午前","午後"],DAY:["日曜日","月曜日","火曜日","水曜日","木曜日","金曜日","土曜日"],MONTH:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],SHORTDAY:["日","月","火","水","木","金","土"],SHORTMONTH:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"]},sv:{AMPMS:["fm","em"],DAY:["söndag","måndag","tisdag","onsdag","torsdag","fredag","lördag"],MONTH:["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"],SHORTDAY:["sön","mån","tis","ons","tors","fre","lör"],SHORTMONTH:["jan.","feb.","mars","apr.","maj","juni","juli","aug.","sep.","okt.","nov.","dec."]}}}}]),angular.module("arloApp.services",["arloApp.services.calendarNamesService"]).factory("urlService",["appProperties","$location",function(e,t){return{ssoToken:null,webUrl:null,getLoginUrl:function(){return this.webUrl+e.loginRoute},getNotifyResponsesPushServiceUrl:function(){return this.webUrl+e.notifyResponsesPushServiceContext},getCountryCodesUrl:function(){return this.webUrl+e.staticContext+"/countrycodes"},getStatesCodesUrl:function(t){return this.webUrl+e.staticContext+"/"+t},getTimeZonesUrl:function(){return this.webUrl+e.staticContext+"/timezones"},getSecretQuestionsUrl:function(){return this.webUrl+e.staticContext+"/secretquestions"},getProfileUrl:function(){return this.webUrl+e.profileContext},getQueryPresentDevicesUrl:function(){return this.webUrl+e.queryPresentDevicesContext},getRegisterUserUrl:function(){return this.webUrl+e.registerContext},getSsoRegisterUserUrl:function(){return this.webUrl+e.ssoRegisterContext},getOffersUrl:function(){return this.webUrl+e.getOffersContext},getOffersV1Url:function(){return this.webUrl+e.getOffersV1Context},getOffersDetailsUrl:function(){return this.webUrl+e.getOffersDetailsContext},getCreatePaymentAccountUrl:function(){return this.webUrl+e.createPaymentAccountContext},getModifyBillingUrl:function(t){return this.webUrl+e.paymentBillingContext+"/"+t},getCreateQuotationUrl:function(t){return this.webUrl+e.paymentQuotationContext+"/"+t},getChangeQuotationUrl:function(t){return this.webUrl+e.paymentQuotationContext+"/"+t+e.changeContext},getRenewQuotationUrl:function(t){return this.webUrl+e.paymentQuotationContext+"/"+t+e.renewContext},getCancelQuotationUrl:function(t){return this.webUrl+e.paymentQuotationContext+"/"+t+e.cancelContext},getCreatePlanUrl:function(t){return this.webUrl+e.servicePlansPaymentContext+"/"+t},getChangePlanUrl:function(t){return this.webUrl+e.servicePlansPaymentContext+"/"+t},getRenewPlanUrl:function(t){return this.webUrl+e.servicePlansPaymentContext+"/"+t+e.renewContext},getCancelPlanUrl:function(t){return this.webUrl+e.servicePlansPaymentContext+"/"+t+e.cancelContext},getPaymentBillingUrl:function(t){return this.webUrl+e.paymentBillingContext+"/"+t},getPaymentRenewUrl:function(t){return this.webUrl+e.paymentRenewContext+"/"+t},getClaimDeviceUrl:function(){return this.webUrl+e.claimDeviceContext},getFriendsUrl:function(){return this.webUrl+e.friendsContext},getFriendsDeleteUrl:function(){return this.webUrl+e.friendsDeleteContext},getUpdateUserIdUrl:function(){return this.webUrl+e.updateUserIdContext},getConfirmUserIdUrl:function(){return this.webUrl+e.confirmUserIdContext},getUpdatePasswordUrl:function(){return this.webUrl+e.updatePasswordContext},getRequestPasswordResetUrl:function(){return this.webUrl+e.requestPasswordResetContext},getResetPasswordUrl:function(){return this.webUrl+e.resetPasswordContext},getUpdateNameUrl:function(){return this.webUrl+e.updateNameContext},getLogoutUrl:function(){return this.webUrl+e.logoutContext},setWebUrl:function(){this.staticAssetsUrl=t.protocol()+"://"+t.host(),this.webUrl="https://arlodev.netgear.com/hmsweb"},getDevicesUrl:function(t){return this.webUrl+e.devicesContext+(t?"/"+t:"")},getSyncBaseStationUrl:function(t){return this.webUrl+e.syncBaseStationContext+"/"+t},getNotifyUrl:function(t){return this.webUrl+e.notifyContext+"/"+t},getFullFrameSnapshotUrl:function(){return this.webUrl+e.takeFullFrameSnapshotContext},getUserFrameSnapshotUrl:function(){return this.webUrl+e.takeUserFrameSnapshotContext},getStartStreamUrl:function(){return this.webUrl+e.streamContext},getStopStreamUrl:function(){return this.webUrl+e.stopStreamContext},getStartRecordUrl:function(){return this.webUrl+e.startRecordContext},getStopRecordUrl:function(){return this.webUrl+e.stopRecordContext},getTakeSnapshotUrl:function(){return this.webUrl+e.takeSnapshotContext},getMetadataUrl:function(){return this.webUrl+e.metadataContext},getRecordingsUrl:function(){return this.webUrl+e.recordingsContext},getDeviceUrl:function(t){return this.webUrl+e.devicesContext+"/"+t},getEditUrl:function(){return this.webUrl+e.editContext},getFavoriteUrl:function(){return this.webUrl+e.favoriteContext},getCheckEmailUrl:function(){return this.webUrl+e.checkEmailUsage},getCheckAccountUrl:function(){return this.webUrl+e.checkAccountUsage},getRecycleUrl:function(){return this.webUrl+e.recycleContext},getShareUrl:function(){return this.webUrl+"/users/library/share"},getRecycleAllUrl:function(){return this.webUrl+e.recycleContext+e.allContext},getCameraOrderUrl:function(){return this.webUrl+e.cameraOrderContext},getDeleteAccountUrl:function(){return this.webUrl+e.deleteAccountContext},getRemoveDeviceUrl:function(){return this.webUrl+e.removeDeviceContext},getRenameDeviceUrl:function(){return this.webUrl+e.renameDeviceContext},getRestartDeviceUrl:function(){return this.webUrl+e.restartDeviceContext},getPreferencesUrl:function(){return this.webUrl+e.preferencesContext},getServicePlanUrl:function(){return this.webUrl+e.servicePlanContext},getStorageQuotaUrl:function(){return this.webUrl+e.storageQuotaContext},getLibraryStateUrl:function(){return this.webUrl+e.libraryStateContext},getTermsUrl:function(){return this.webUrl+e.termsContext},getPolicyUrl:function(){return this.webUrl+e.policyContext}}}]).factory("authInterceptor",["$q","$injector","$log","$cacheFactory","$rootScope","$filter",function(e,t,r,n,i,a){return{response:function(i){if(t.get("offlineService").isOffline=!1,401==i.status){r.info("Got 401 status from server"),t.get("gatewayPollingService").shutdown(),t.get("pushHandlerService").shutdown();var a=t.get("userService");a.setSsoToken(""),a.settings||(t.get("loginService").redirectError="Session expired. Please relog-in."),t.get("$state").go("login"),t.get("appStateService").clearSessionData(),n.get("$http").removeAll()}return i||e.when(i)},responseError:function(o){switch(o.status){case 0:o.data||t.get("offlineService").checkOffline();break;case 401:t.get("offlineService").isOffline=!1,r.info("Got 401 status from server on response error"),t.get("gatewayPollingService").shutdown(),t.get("pushHandlerService").shutdown();var s=t.get("userService");s.setSsoToken(""),t.get("$state").go("login"),t.get("appStateService").clearSessionData(),n.get("$http").removeAll(),s.settings||(t.get("loginService").redirectError="Session expired. Please relog-in.");break;case 500:case 501:case 502:case 503:i.$broadcast("show_error",{data:{message:a("i18n")("error_http_"+o.status)}});break;default:return r.error("Error from server: "+JSON.stringify(o)),e.reject(o.data)}return e.reject(o)}}}]).factory("utilService",["$state",function(e){return{id:0,isMobile:navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/Silk/i),previousState:{},s4:function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},guid:function(){return this.s4()+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+"-"+this.s4()+this.s4()+this.s4()},nextId:function(){return this.id++},checkMobile:function(){return!window._ACCOUNT_&&this.isMobile?(e.go("useMobile"),!0):!1},getLang:function(){if(this.lang)return this.lang;var e,t,r=["de","fr","it","ru","en","ja","sv"];return e=navigator&&navigator.userAgent&&(t=navigator.userAgent.match(/android.*\W(\w\w)-(\w\w)\W/i))?t[1]:navigator.userLanguage||navigator.language,this.lang=-1!=r.indexOf(e.split("-")[0])?e.split("-")[0]:"en",this.lang},gaSend:function(e){ga("send",{hitType:"pageview",page:"/"+e+"_web",title:e+"_web"})}}}]).factory("loginService",["$http","$window","$timeout","$log","$q","urlService","userService","localStorage","appProperties",function(e,t,r,n,i,a,o,s,c){return{reLoggedIn:!1,checkCredentials:function(t,r,s){var c={email:t,password:r};s&&(c.registrationToken=s);var d={method:"POST",url:a.getLoginUrl(),data:c,timeout:3e5},l=this,u=e(d).then(function(e){if(1==e.data.success)n.debug("got result:"+JSON.stringify(e)),o.setSsoToken(e.data.data.token),l.ssoToken=e.data.data.token,o.setUserId(e.data.data.userId),o.setUserName(e.data.data.email),o.setPaymentId(e.data.data.paymentId),o.setCountryCode(e.data.data.countryCode),o.setValidEmail(e.data.data.validEmail),l.loginError=!1;else if(t!=r&&"undefined"!=t&&null!=t&&""!=t)return n.warn("login not successful"),i.reject(e.data);return e.data});return u},updatePassword:function(t,r){var s={currentPassword:t,newPassword:r},c={method:"POST",url:a.getUpdatePasswordUrl(),data:s,timeout:3e4,headers:{Authorization:this.ssoToken||o.ssoToken}};n.debug("calling updatePassword with config:"+JSON.stringify(c));var d=e(c).then(function(e){return 1!=e.data.success?(n.warn("update password error: "+JSON.stringify(e)),i.reject(e.data)):(o.settings&&o.setSettings(r),void n.debug("update password result: "+JSON.stringify(e)))});return d},requestPasswordReset:function(t){var r={email:t},i={method:"POST",url:a.getRequestPasswordResetUrl(),data:r,timeout:3e4};n.debug("calling requestPasswordReset with config: "+JSON.stringify(i));var o=e(i).then(function(e){1==e.data.success?n.debug("Request password reset success:"+JSON.stringify(e)):n.warn("server returned error:"+r.code+r.message)});return o},resetPassword:function(t,r){var i={newPassword:t,passwordResetCode:r},o={method:"POST",url:a.getResetPasswordUrl(),data:i,timeout:3e4};n.debug("calling resetPassword with config:"+JSON.stringify(o));var s=e(o).then(function(e){1==e.data.success?n.debug("Reset password success:"+JSON.stringify(e)):n.warn("server returned error:"+i.code+i.message)});return s},updateTosVersion:function(t){var r={method:"POST",url:a.webUrl+c.updateTermsContext,data:{acceptedTermConditionVersion:t},timeout:3e4,headers:{Authorization:o.ssoToken}};n.debug("calling updateTosVersion with config:"+JSON.stringify(r));var s=e(r).then(function(e){return e.data&&e.data.success?e.data:i.reject(e.data)});return s},updatePolicyVersion:function(t){var r={method:"POST",url:a.webUrl+c.updatePolicyContext,data:{acceptedPolicyVersion:t},timeout:3e4,headers:{Authorization:o.ssoToken}};n.debug("calling updatePolicyVersion with config:"+JSON.stringify(r));var s=e(r).then(function(e){return e.data&&e.data.success?e.data:i.reject(e.data)});return s}}}]).factory("logoutService",["$rootScope","$http","$log","$injector","$modalStack","$q","urlService","appStateService","userService","recordingsService","calendarService","servicePlanService","cameraSettingsService","uiService","baseStationService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p){return{logoutError:null,logout:function(m){if(n.get("pushHandlerService").shutdown(),n.get("gatewayPollingService").shutdown(),i.dismissAll(),s.clearSessionData(),d.selectMode=!1,l.stateParams=null,u.purchasedPlans=null,u.billingInfo=null,f.gettingCameraSettings=null,g.scope=e.$new(!0),p.rebootingBS=[],n.get("gatewayPollingService").baseStationAlerts={},m)return s.clearSessionData(),c.ssoToken=null,a.when(1);var v={method:"PUT",url:o.getLogoutUrl(),timeout:3e5,headers:{Authorization:c.ssoToken}},h=this,S=t(v).then(function(e){r.debug("got result:"+JSON.stringify(e)),s.clearSessionData(),h.logoutError=!1,c.ssoToken=null},function(e){r.debug("got result:"+JSON.stringify(e)),s.clearSessionData(),h.logoutError=!0,c.ssoToken=null});return S}}}]).factory("jsonService",["$http","$q","urlService",function(e,t,r){return{getData:function(r){return e.get(r).then(function(e){return e.data&&e.data.success?e.data:t.reject(e.data)},function(e){return t.reject(e&&e.data)})},countryCodes:function(){return this.getData(r.getCountryCodesUrl())},stateCodes:function(e){return this.getData(r.getStatesCodesUrl(e))},timeZones:function(){return this.getData(r.getTimeZonesUrl())},secretQuestions:function(){return this.getData(r.getSecretQuestionsUrl())}}}]).factory("userService",["$http","$log","$window","$q","$location","localStorage","setupService","urlService","appProperties",function(e,t,r,n,i,a,o,s,c){return{userName:null,ssoToken:null,userId:null,firstName:null,lastName:null,password:null,preferences:null,fromLogout:null,validEmail:null,ignoreUpdates:null,calendarSessionPopup:null,calendarClientPopup:null,rulesSessionPopup:null,rulesClientPopup:null,paymentId:null,setCalendarSessionPopup:function(e){this.calendarSessionPopup=e,this.persistCalendarSessionPopup()},setCalendarClientPopup:function(e){this.calendarClientPopup=e,this.persistСalendarClientPopup()},setRulesSessionPopup:function(e){this.rulesSessionPopup=e,this.persistRulesSessionPopup()},setRulesClientPopup:function(e){this.rulesClientPopup=e,this.persistRulesClientPopup()
},setUserId:function(e){this.userId=e,this.persistUserId()},setUserName:function(e){this.userName=e,this.persistUserName()},clearSettings:function(){this.settings=null,a.settings&&a.removeItem("settings")},setPaymentId:function(e){this.paymentId=e,this.persistPaymentId()},setFirstName:function(e){this.firstName=e,this.persistFirstName()},setLastName:function(e){this.lastName=e,this.persistLastName()},setSsoToken:function(e){this.ssoToken=e,this.persistSsoToken()},setCountryCode:function(e){this.countryCode=e,a.setItem("countryCode",this.countryCode)},clearFromLogout:function(){this.fromLogout=!1,a.fromLogout&&a.removeItem("fromLogout")},setFromLogout:function(){this.fromLogout=!0,a.setItem("fromLogout",this.fromLogout)},setValidEmail:function(e){this.validEmail=e.toString(),a.setItem("validEmail",this.validEmail)},setIgnoreUpdates:function(e){this.ignoreUpdates=e,e?a.setItem("ignoreUpdates","1"):a.ignoreUpdates&&a.removeItem("ignoreUpdates")},isLoggedIn:function(){return this.ssoToken&&!0},updateUserId:function(r,i){var a={email:r,currentPassword:i},o={method:"POST",url:s.getUpdateUserIdUrl(),data:a,timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling updateUserId with config:"+JSON.stringify(o));var c=e(o).then(function(e){return 1!=e.data.success?(t.warn("update userId error: "+JSON.stringify(e)),n.reject(e.data)):void t.debug("got result: "+JSON.stringify(e))});return c},updateName:function(r,i){var a={firstName:r,lastName:i},o={method:"PUT",url:s.getProfileUrl(),data:a,timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling updateName with config:"+JSON.stringify(o));var c=this,d=e(o).then(function(e){return 1!=e.data.success?(t.warn("server returned error:"+a.code+a.message),n.reject(e.data)):(t.debug("got result:"+JSON.stringify(e)),c.setFirstName(r),c.setLastName(i),void 0)});return d},getProfile:function(){var r={method:"GET",url:s.getProfileUrl(),headers:{Authorization:this.ssoToken}};t.debug("accessing get profile with config:"+JSON.stringify(r));var n=this,i=e(r).then(function(e){1==e.data.success?(t.debug("got result:"+JSON.stringify(e)),"undefined"!=typeof e.data.data.userId&&n.setUserId(e.data.data.userId),n.setFirstName(e.data.data.firstName),n.setLastName(e.data.data.lastName),e.data.data.hasOwnProperty("validEmail")&&n.setValidEmail(e.data.data.validEmail)):t.warn("server returned error:"+e.data.code+e.data.message)});return i},register:function(r){var a;if(o.selectedBaseStation)a=o.selectedBaseStation.registrationToken;else{o.friendUser=!0;var d=i.absUrl(),l=d.split("?")[1];0===l.indexOf(c.REGISTRATION_TOKEN)&&-1===l.indexOf("&")&&(a=l.split("=")[1],a=a.split("#")[0],a=a.split("/")[0])}r.timeZone&&r.timeZone.ui&&delete r.timeZone.ui;var u={method:"POST",url:s.getRegisterUserUrl(),data:r,timeout:3e4,headers:{registrationToken:a}},f=this;t.debug("calling register user with config:"+JSON.stringify(u));var g=e(u).then(function(e){return 1!=e.data.success?(t.warn("server returned error:"+e.data.data.error+e.data.data.message),f.registerUserError=!0,n.reject(e.data)):(t.debug("got POST result:"+JSON.stringify(e)),f.setSsoToken(e.data.data.token),f.setUserId(e.data.data.userId),f.setUserName(r.email),e.data.data.paymentId&&f.setPaymentId(e.data.data.paymentId),f.setCountryCode(e.data.data.country),f.registerUserError=!1,o.accountRegistered=!0,o.baseStationClaimed=!0,void 0)},function(e){var t="",r=e.data.data;return r&&r.validationErrors?angular.forEach(r.validationErrors.items,function(e){t+=e.message+"\n"}):t=e.data||"You are not connected to the internet",f.registerUserError=!0,n.reject(t)});return g},ssoRegister:function(r){var a;if(o.selectedBaseStation)a=o.selectedBaseStation.registrationToken;else{o.friendUser=!0;var d=i.absUrl(),l=d.split("?")[1];0===l.indexOf(c.REGISTRATION_TOKEN)&&-1===l.indexOf("&")&&(a=l.split("=")[1],a=a.split("#")[0],a=a.split("/")[0])}r.timeZone&&r.timeZone.ui&&delete r.timeZone.ui;var u={method:"POST",url:s.getSsoRegisterUserUrl(),data:r,timeout:3e4,headers:{registrationToken:a}},f=this;t.debug("calling register user with config:"+JSON.stringify(u));var g=e(u).then(function(e){return 1!=e.data.success?(t.warn("server returned error:"+e.data.data.error+e.data.data.message),f.registerUserError=!0,n.reject(e.data)):(t.debug("got POST result:"+JSON.stringify(e)),f.setSsoToken(e.data.data.token),f.setUserId(e.data.data.userId),f.setUserName(r.email),e.data.data.paymentId&&f.setPaymentId(e.data.data.paymentId),f.setCountryCode(e.data.data.country),f.registerUserError=!1,o.accountRegistered=!0,o.baseStationClaimed=!0,void 0)},function(e){var t="",r=e.data.data;return r&&r.validationErrors?angular.forEach(r.validationErrors.items,function(e){t+=e.message+"\n"}):t=e.data||"You are not connected to the internet",f.registerUserError=!0,n.reject(t)});return g},persistCalendarSessionPopup:function(){a.setItem("calendarSessionPopup",this.calendarSessionPopup)},"persistСalendarClientPopup":function(){a.setItem("calendarClientPopup",this.calendarClientPopup)},persistRulesSessionPopup:function(){a.setItem("rulesSessionPopup",this.rulesSessionPopup)},persistRulesClientPopup:function(){a.setItem("rulesClientPopup",this.rulesClientPopup)},persistUserId:function(){a.setItem("userId",this.userId)},persistPaymentId:function(){a.setItem("paymentId",this.paymentId)},persistUserName:function(){a.setItem("userName",this.userName)},setSettings:function(e){var t=_.times(e.length,function(t){return e.charCodeAt(t)+20});this.settings=!0,a.setItem("settings",JSON.stringify(t))},persistFirstName:function(){a.setItem("firstName",this.firstName)},persistLastName:function(){a.setItem("lastName",this.lastName)},persistSsoToken:function(){a.setItem("ssoToken",this.ssoToken)},loadSessionData:function(){_.each(["userId","userName","settings","firstName","lastName","ssoToken","paymentId","fromLogout","countryCode","validEmail","ignoreUpdates","calendarClientPopup","rulesClientPopup"],function(e){this[e]=a[e]||null},this)},clearSessionData:function(){_.each(["userId","firstName","lastName","ssoToken","paymentId","countryCode","validEmail","ignoreUpdates"],function(e){this[e]=null,a[e]&&a.removeItem(e)},this)},checkEmailUsage:function(r){var i={email:r},a={method:"POST",url:s.getCheckEmailUrl(),data:i,timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling checkEmailUsage with config:"+JSON.stringify(a));var o=e(a).then(function(e){return t.debug("got result checkEmailUsage:"+JSON.stringify(e)),1==e.data.success?e.data:n.reject(e.data)});return o},checkAccountUsage:function(r,i){var a={email:r,password:i},o={method:"POST",url:s.getCheckAccountUrl(),data:a,headers:{Authorization:this.ssoToken}};t.debug("calling checkAccountUsage: "+r);var c=e(o).then(function(e){return t.debug("got result checkAccountUsage:"+JSON.stringify(e)),1==e.data.success?e.data:n.reject(e.data)});return c},deleteAccount:function(){var r={method:"POST",url:s.getDeleteAccountUrl(),headers:{Authorization:this.ssoToken}};t.debug("calling delete Account with config:"+JSON.stringify(r));var n=e(r).then(function(e){return 1==e.data.success&&t.debug("got result delete Account:"+JSON.stringify(e)),e});return n},updatePreferences:function(){var r={method:"GET",url:s.getPreferencesUrl(),headers:{Authorization:this.ssoToken}};t.debug("getting preferences with config:"+JSON.stringify(r));var n=this,i=e(r).then(function(e){1==e.data.success&&(t.debug("got result:"+JSON.stringify(e)),n.preferences=e.data.data)});return i},getPreferences:function(){return this.preferences},setPreferences:function(r){var n={method:"POST",url:s.getPreferencesUrl(),data:r,timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling setPreferences with config:"+JSON.stringify(n));var i=e(n).then(function(e){1==e.data.success&&t.debug("got result:"+JSON.stringify(e))});return i},updateStorageQuota:function(){var r={method:"GET",url:s.getStorageQuotaUrl(),headers:{Authorization:this.ssoToken}};t.debug("getting storage quota with config:"+JSON.stringify(r));var n=this,i=e(r).then(function(e){1==e.data.success&&(t.debug("got result:"+JSON.stringify(e)),n.storageQuota=e.data.data)});return i},getSettings:function(){var e=a.settings;return e?_.reduce(JSON.parse(e),function(e,t){return e+String.fromCharCode(t-20)},""):null},confirmEmail:function(){var r={method:"GET",url:s.getConfirmUserIdUrl(),timeout:3e4,headers:{Authorization:this.ssoToken}};t.debug("calling confirmEmail with config: "+JSON.stringify(r));var i=e(r).then(function(e){return 1!=e.data.success?n.reject(e.data):void t.debug("got result: "+JSON.stringify(e))});return i}}}]).factory("friendsService",["$http","$log","$window","$q","userService","appProperties","localStorage","urlService",function(e,t,r,n,i,a,o,s){return{friends:null,addFriend:function(r){var n=(_.findWhere(this.friends,{email:r.email}),{method:"POST",url:s.getFriendsUrl(),data:r,timeout:3e4,headers:{Authorization:i.ssoToken}});t.debug("calling add friend with config:"+JSON.stringify(n));var a=this,o=e(n).then(function(e){1==e.data.success?(a.friends.push(r),t.debug("got POST result:"+JSON.stringify(e))):t.warn("server returned error:"+e.data.data.error+e.data.data.message)});return o},editFriend:function(r){var n={method:"PUT",url:s.getFriendsUrl(),data:r,timeout:3e4,headers:{Authorization:i.ssoToken}};t.debug("calling edit friend with config:"+JSON.stringify(n));var a=this,o=e(n).then(function(e){if(1==e.data.success){var n=_.findWhere(a.friends,{email:r.email});"undefined"===n&&a.friends.push(r),t.debug("got PUT result:"+JSON.stringify(e))}else t.warn("server returned error:"+e.data.data.error+e.data.data.message)});return o},deleteFriend:function(r){var n={method:"POST",url:s.getFriendsDeleteUrl(),data:{email:r.email},timeout:3e4,headers:{Authorization:i.ssoToken}};t.debug("calling delete friend with config:"+JSON.stringify(n));var a=e(n).then(function(e){1==e.data.success?t.debug("got DELETE friend result:"+JSON.stringify(e)):t.warn("server returned error:"+e.data.data.error+e.data.data.message)});return a},getFriends:function(){var r={method:"GET",url:s.getFriendsUrl(),timeout:3e4,headers:{Authorization:i.ssoToken}};t.debug("calling get friends with config:"+JSON.stringify(r));var n=this,a=e(r).then(function(e){1==e.data.success?(t.debug("got get friends result:"+JSON.stringify(e)),n.friends=e.data.data):t.warn("server returned error:"+e.data.data.error+e.data.data.message)});return a},createFriendObject:function(e,t,r,n){return{email:e,firstName:t,lastName:r,devices:n,acceptanceState:a.ACCEPTANCE_PENDING}}}}]).factory("appStateService",["userService","devicesService","calendarService","metadataService","libraryService","dayService","recordingsService",function(e,t,r,n,i,a,o){return{loadSessionData:function(){e.loadSessionData(),t.loadSessionData(),n.loadSessionData(),i.loadSessionData(),a.loadSessionData(),o.loadSessionData()},clearSessionData:function(){e.clearSessionData(),t.clearSessionData(),n.clearSessionData(),i.clearSessionData(),a.clearSessionData(),o.clearSessionData()}}}]).factory("transactionService",function(){return{createTransactionId:function(){var e=Math.random()*Math.pow(2,32),t=new Date;return"web!"+e.toString(16)+"!"+t.getTime().toString()}}}).factory("pushHandlerService",["$interval","$log","$state","$rootScope","$injector","$filter","urlService","notifyService","devicesService","baseStationService","cameraSettingsService","userService","logoutService","camerasService","loginService","appProperties","offlineService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,m,v){return{notifyResponsesSource:null,cleanResponsesHandlersPromise:null,sseErrors:[],init:function(){if(!window._ACCOUNT_){this.notifyResponsesSource&&(this.notifyResponsesSource.close(),t.warn("Attempt to reinitialize the notifyResponsesSource subscribing twice"));var r=o.getNotifyResponsesPushServiceUrl()+"?token="+u.ssoToken;this.notifyResponsesSource=new EventSource(r);var n=this;this.notifyResponsesSource.addEventListener("message",function(e){n.notifyResponsesCallback(e)},!1),this.notifyResponsesSource.addEventListener("error",function(e){n.notifyResponsesErrorCallback(e)},!1);var n=this;this.cleanResponsesHandlersPromise=e(function(){n.cleanResponsesHandlerQueue()},s.cleanHandlerQueueInterval)}},shutdown:function(){this.notifyResponsesSource&&(this.notifyResponsesSource.close(),this.notifyResponsesSource=null),this.responseHandlers=null,e.cancel(this.cleanResponsesHandlersPromise)},notifyResponsesCallback:function(e){if("connected"!=e.data){var i=JSON.parse(e.data);if("logout"==i.action)return t.info("Got server logout event"),u.setFromLogout(),p.redirectError="You have been logged out because you have logged in on another device or browser.",f.logout(!0),void r.go("login");if(v.checkTransId(i)){t.debug("got sse message in notify response callback:"+e.data);var o;if(o="mediaUploadNotification"==i.resource?_.findWhere(c.allDevices,{deviceId:i.deviceId}):"diagnostics"==i.resource?_.findWhere(c.allDevices,{deviceId:i.from}):i.transId&&i.transId.split("!").length>1&&(_.findWhere(c.allDevices),{deviceId:i.transId.split("!")[0]}),o||i.transId||i.deviceId){if(i.properties&&i.properties.stateChangeReason){var l=i.resource.split("/")[1];if(i.properties.activityState){var g=c.getCameraById(l);g&&(g.properties.activityState=i.properties.activityState)}return void(4200!=i.properties.stateChangeReason.code&&n.$broadcast(m.appEvents.CAMERA_ERROR,{deviceId:l,code:i.properties.stateChangeReason.code,message:i.properties.stateChangeReason.message}))}if(i.error)if(i.transId&&s.responseHandlers[i.transId])s.responseHandlers[i.transId].failureHandler.call(d,i),t.debug("removing response handlers for transaction:"+i.transId),delete s.responseHandlers[i.transId];else if(0==i.resource.indexOf("cameras"))n.$broadcast(m.appEvents.CAMERA_ERROR,{deviceId:i.resource.split("/")[1],code:i.error.code,message:i.error.message});else{switch(i.error.code){case 4e3:case 4003:case 4006:case 4009:case 4011:case 4013:case 4014:case 4015:case 4016:case 4017:i.error.message=a("i18n")("base_station_error_"+i.error.code)}n.$broadcast("show_error",{data:i.error})}else{if("mediaUploadNotification"==i.resource&&!o)return;if("mediaUploadNotification"==i.resource){for(var h in i){var S=i[h];"deviceId"!=h&&"resource"!=h&&S&&(o[h]=S,"presignedLastImageUrl"==h&&c.updateLastDate(o))}n.$broadcast(m.appEvents.MEDIA_UPLOAD_NOTIFICATION)}else"diagnostics"==i.resource&&"reboot"==i.action?(d.rebootingBS[i.from]=!0,n.$broadcast(m.appEvents.BS_REBOOTED,i.from)):s.responseHandlers[i.transId]?(s.responseHandlers[i.transId].successHandler.call(d,i),t.debug("removing response handlers for transaction:"+i.transId),delete s.responseHandlers[i.transId]):(0===i.transId.indexOf(m.DEVICE_TRANSACTION_PREFIX)||o)&&(t.debug("got sse message from device, transaction id:"+i.transId),this.deviceEventsCallback(e))}}else t.error("SSE message transaction id missing or null")}}},notifyResponsesErrorCallback:function(){t.warn("Restarting SSE on error."),this.sseErrors.push((new Date).getTime()),v.checkOffline(),3==this.sseErrors.length&&this.sseErrors[2]-this.sseErrors[0]<4e4&&!v.isOffline?r.go("otherTab"):3==this.sseErrors.length&&(this.sseErrors=[])},cleanResponsesHandlerQueue:function(){var e=_.keys(s.responseHandlers),t=Date.now(),r=_.filter(e,function(e){var r=s.responseHandlers[e].notifyTime+s.responseHandlers[e].timeout;return t>r?!0:!1});_.each(r,function(e){s.responseHandlers[e].failureHandler(s.responseHandlers[e].query),delete s.responseHandlers[e]})},deviceEventsCallback:function(e){var t=JSON.parse(e.data);if(t.from){var r=c.getDeviceById(t.from);r&&(r.properties||(r.properties={}))}if(t.resource){var i=t.resource.split("/")[1]||t.from;if(t.action&&"new"==t.action&&"OWNER"==r.userRole){if(_.findWhere(c.devices,{deviceId:i}))return;var o=_.findWhere(c.allDevices,{deviceId:i});return o?(o.state="",c.devices.push(o)):(o={deviceId:i,parentId:t.from,properties:{connectionState:"available"}},c.devices.push(o),c.allDevices.push(o)),this.devices=a("orderBy")(this.devices,"displayOrder"),c.uiStateHash[i]={play:!1,record:!1,micLevel:0,showBright:!1},void c.getDevice(i).then(function(){var e=c.getDeviceById(i);l.getBaseStationCameraSettings(e.parentId),d.getBaseStationResource(e.parentId,"modes"),d.getBaseStationResource(e.parentId,"rules"),n.$broadcast("new_camera",t)})}if(t.action&&("fullFrameSnapshotAvailable"==t.action||"userSnapshotAvailable"==t.action)){var o=_.findWhere(c.allDevices,{deviceId:i});for(var s in t.properties)o[s]=t.properties[s];return void n.$broadcast(m.appEvents.SNAPSHOT_LOADED,{deviceId:i,presignedSnapshotUrl:o.presignedSnapshotUrl})}if(t.properties){var u=t.resource.split("/")[0];switch(u){case"cameras":case"basestation":var i=t.resource.split("/")[1]||t.from,f=c.getDeviceById(i);if(f)for(var g in t.properties)t.properties.hasOwnProperty(g)&&(f.properties[g]=t.properties[g])}}"modes"==t.resource&&d.handleModesEvent(t)}}}}]).factory("notifyService",["$log","$window","$http","$q","urlService","userService","transactionService","devicesService",function(e,t,r,n,i,a,o,s){return{result:null,responseHandlers:{},failureHandlers:{},cleanHandlerQueueInterval:1e3,notifyBaseStation:function(t,o,c,d){if(e.debug("************** In notifyBaseStation, processing transaction:"+t.transId),t.to){var l,u=_.findWhere(s.devices,{deviceId:t.to});if(u)l=u.xCloudId;else{var f=s.findByParentId(t.to);if(!f&&window._DEBUG_)throw"Could not find friend device to notify";l=f[0].xCloudId}var g={method:"POST",url:i.getNotifyUrl(t.to),data:t,timeout:3e4,headers:{Authorization:a.ssoToken,xcloudId:l}},p=n.defer(),m=this;e.debug("setting response handlers for transaction:"+t.transId),m.responseHandlers[t.transId]={query:t,successHandler:o,failureHandler:c,notifyTime:Date.now(),timeout:d},e.debug("sending notify message:"+JSON.stringify(g));{r(g).then(function(r){m.result=r,1==r.data.success?e.debug("got notify result:"+JSON.stringify(r)):(e.debug("server returned false for subscribe"),delete m.responseHandlers[t.transId]),p.resolve(r)},function(r){m.result=r,e.error("Got notify error, server returned:"+JSON.stringify(r)),p.resolve(r),delete m.responseHandlers[t.transId]})}return p.promise}},createDeviceQuery:function(e,t,r,n){var i={from:a.userId,to:e,action:t,resource:r,responseUrl:"",publishResponse:!1,transId:o.createTransactionId()};if(n){i.properties={};for(var s in n)n.hasOwnProperty(s)&&(i.properties[s]=n[s])}return i},createResourceQuery:function(e,t,r,n){if(e){var i={from:a.userId,to:e,action:t,responseUrl:"",resource:r,transId:o.createTransactionId()};return i.publishResponse="get"===t?!1:!0,n&&(i.properties={},i.properties[r]=n),i}},createSubresourceQuery:function(e,t,r,n){var i={from:a.userId,to:e,action:t,responseUrl:"",resource:r,transId:o.createTransactionId()};if(i.publishResponse="get"===t?!1:!0,n){i.properties={};for(var s in n)n.hasOwnProperty(s)&&(i.properties[s]=n[s])}return i}}}]).factory("setupService",function(){return{isSetup:null,setupPending:null,accountRegistered:null,baseStationClaimed:null,servicePlanSelected:null,servicePlanPaidFor:null,billingInformationGiven:null,selectedBaseStation:null,timeZone:null,friendUser:!1,start:function(){return this.isSetup?!1:(this.setupPending=!0,this.accountRegistered||(this.accountRegistered=!1),this.baseStationClaimed||(this.baseStationClaimed=!1),this.servicePlanSelected||(this.servicePlanSelected=!1),this.billingInformationGiven||(this.billingInformationGiven=!1),this.accountRegistered&&this.baseStationClaimed?(this.setupPending=!1,!1):void 0)},updateSetupState:function(){this.accountRegistered&&this.friendUser?(this.isSetup=!0,this.setupPending=!1,this.friendUser=!1):this.baseStationClaimed&&this.accountRegistered&&this.servicePlanSelected&&(this.setupPending=!1,this.isSetup=!0)},persistSetupState:function(){localStorage.setItem("isSetup",this.isSetup)},setSetupState:function(){localStorage.setItem("isSetup",!0)},loadSessionData:function(){_.each(["isSetup"],function(e){this[e]=localStorage[e]||null},this)}}}).factory("scheduleValidationService",["$q","$state","$rootScope","$modal","$log","appProperties","baseStationService","devicesService","userService","servicePlanService",function(e,t,r,n,i,a,o,s,c,d){return{modeArmsSensor:function(e,t){var r=s.getDeviceById(e);if(!r&&window._DEBUG_)throw"Sensor:"+e+" cannot be found";var n=s.getBaseStationById(r.parentId);if(!n&&window._DEBUG_)throw"Base station:"+r.parentId+" cannot be found";var i=_.findWhere(n.modes,{id:t});if(!i&&window._DEBUG_)throw"Mode:"+t+" cannot be found";if(!i)return!1;var o,c=i.rules;return o=_.some(c,function(t){var r=_.findWhere(n.rules,{id:t});return r?_.some(r.triggers,function(t){return t&&t.deviceId===e&&t.type===a.SENSOR_MOTION_DETECTION_STATE}):!1})},getAllEmails:function(){var e=_.reduce(s.getBaseStations(),function(e,t){return t.rules?_.union(e,t.rules):e},[]),t=_.reduce(e,function(e,t){if(t&&t.actions){var r=_.find(t.actions,function(e){return"sendEmailAlert"===e.type});if(r&&r.recipients){var n=_.map(r.recipients,function(e){return e==c.userName?"__OWNER_EMAIL__":e});return _.union(e,n)}return e}return e},[]);return t.length?t:["__OWNER_EMAIL__"]},canAddMode:function(){var e=d.getServicePlan(),t=e&&e.maxSmartHomeModes?e.maxSmartHomeModes:0,r=_.reduce(s.getBaseStations(),function(e,t){return e+(t.modes?t.modes.length:0)},0);return t>r},createDefaultEmailAction:function(){return{type:"sendEmailAlert",recipients:[]}},fixRule:function(e){if(e.name=e.name.trim(),e.triggers&&e.triggers.length)for(var t=0;t<e.triggers.length;t++)e.triggers[t].sensitivity&&"string"==typeof e.triggers[t].sensitivity&&(e.triggers[t].sensitivity=parseInt(e.triggers[t].sensitivity));if(e.actions&&e.actions.length)for(var t=0;t<e.actions.length;t++)e.actions[t].stopCondition&&e.actions[t].stopCondition.sensitivity&&"string"==typeof e.actions[t].stopCondition.sensitivity&&(e.actions[t].stopCondition.sensitivity=parseInt(e.actions[t].stopCondition.sensitivity)),e.actions[t].stopCondition&&e.actions[t].stopCondition.timeout&&"string"==typeof e.actions[t].stopCondition.timeout&&(e.actions[t].stopCondition.timeout=parseInt(e.actions[t].stopCondition.timeout))},validateRule:function(e,t){var r=!0,n=s.getDeviceById(e);if(!n&&window._DEBUG_)throw"Base station:"+e+"not found to validate rule";if(t&&t.name){if(!n.rules&&window._DEBUG_)throw"Base station:"+n.deviceId+" does not have rules";var i=_.filter(n.rules,function(e){return t.name.toLowerCase()===e.name.toLowerCase()});if(i.length>0){if(i.length>1&&window._DEBUG_)throw"Invalid rules for base station:"+e;r=t.id?t.id===i[0].id:!1}}else r=!1;return t&&t.triggers&&t.triggers.length&&t.triggers[0].deviceId||(r=!1),t&&t.actions&&t.actions.length&&t.actions[0].deviceId||(r=!1),r},validateMode:function(e,t){var r=!0,n=s.getDeviceById(e);if(!n&&window._DEBUG_)throw"Base station:"+e+"not found to validate mode";if(t&&t.name){if(!n.modes&&window._DEBUG_)throw"Base station:"+n.deviceId+" does not have modes";var i=_.filter(n.modes,function(e){return t.name.toLowerCase()===e.name.toLowerCase()});if(i.length>0){if(i.length>1&&window._DEBUG_)throw"Invalid modes for base station:"+e;r=t.id?t.id===i[0].id:!1}}else r=!1;return r},validateSchedule:function(e,t){function r(e){var t=_.groupBy(_.pluck(e,"startTime"),function(e){return Math.floor(e/864e5)});return 7===_.size(t)}if(2===arguments.length){var n=s.getBaseStationById(t);if(!n||!n.schedule&&window._DEBUG_)throw"Invalid schedule, no baseStation or no base station schedule, deviceId:"+deviceId;e=n.schedule}var i=this;if(!_.every(e,function(e){return i.scheduleEntryValid(e)})||!r(e)&&window._DEBUG_)throw"Invalid schedule:"+JSON.stringify(e)+(t?", deviceId:"+t:"");return!0},scheduleEntryValid:function(e){function t(e,t,r){return e>=t&&r>=e}var r=!0,n=0,a=/[\d\w]{1,15}/,o=6048e5;for(var s in e)e.hasOwnProperty(s)&&n++;return 2!=n?r=!1:"string"!=typeof e.modeId?r=!1:"number"!=typeof e.startTime?r=!1:a.test(e.modeId)?t(e.startTime,0,o)||(i.debug("invalid schedule, startTime invalid"+startTime),r=!1):(i.debug("invalid schedule, modeId invalid:"+modeId),r=!1),r||i.debug("invalid schedule, invalid entry:"+JSON.stringify(e)),r}}}]).factory("schedulingService",["$q","$state","$rootScope",function(e,t,r){return{editingModeInfo:null,editingRuleInfo:null,editingScheduleInfo:null,broadcastRuleAdded:function(){r.$broadcast("ruleAdded")},broadcastRuleDeleted:function(){r.$broadcast("ruleDeleted")},broadcastRuleEdited:function(){r.$broadcast("ruleEdited")},broadcastModeAdded:function(){r.$broadcast("modeAdded")},broadcastModeDeleted:function(){r.$broadcast("modeDeleted")},broadcastModeEdited:function(){r.$broadcast("modeEdited")},broadcastScheduleEdited:function(){r.$broadcast("scheduleEdited")}}}]).factory("camerasService",["$http","$window","$log","$q","devicesService","transactionService","userService","utilService","cameraSettingsService","urlService","appProperties","scheduleValidationService",function(e,t,r,n,i,a,o,s,c,d,l,u){return{refreshData:function(){i.getDevices()},isCameraOnline:function(e){return e.properties&&e.properties.connectionState==l.AVAILABLE_STATE},isMotionActive:function(e){var t=e.properties&&e.properties.motionDetected;return t},isCameraArmed:function(e){var t=i.getBaseStationById(e.parentId);if(t&&t.activeMode){var r=e.properties&&e.properties[l.CAMERA_CONNECTION_STATE]&&!(e.properties[l.CAMERA_CONNECTION_STATE]===l.CAMERA_CONNECTION_STATE_UNAVAILABLE||e.properties[l.CAMERA_CONNECTION_STATE]===l.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL),n=u.modeArmsSensor(e.deviceId,t.activeMode.id);return r&&n}return!1},cameraEvent:function(e,t){if(t.action&&"new"==t.action)i.getDevices().then(function(){});else if(t.properties)this.setPropertiesOnEvent(e,t.properties);else if(window._DEBUG_)throw"called cameraEvent with bad payload:"+JSON.stringify(t)},setPropertiesOnEvent:function(e,t){r.debug("Setting camera:"+e+"properties:"+JSON.stringify(t));var n=i.getDeviceById(e);if(n)for(var a in t)t.hasOwnProperty(a)&&(n.properties[a]=t[a])},getFullFrameSnapshot:function(t,a){var s=i.getDeviceById(t);if(s){var c={method:"POST",url:a?d.getFullFrameSnapshotUrl():d.getUserFrameSnapshotUrl(),timeout:35e3,data:this.createTakeFullFrameSnapshotPayload(s.parentId,t,a),headers:{Authorization:o.ssoToken,xcloudId:s.xCloudId}},l=e(c).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)):void r.debug("got full frame snapshot response:"+JSON.stringify(e.data))});return l}},startStream:function(t,a){var s=i.getDeviceById(t),c=n.defer(),l=function(){c.reject({canceled:!0})},u={method:"POST",url:d.getStartStreamUrl(),timeout:c.promise,data:this.createStartStreamingPayload(s.parentId,t,a),headers:{Authorization:o.ssoToken,xcloudId:s.xCloudId}},f=e(u).then(function(e){if(1==e.data.success){r.debug("got startStream response:"+JSON.stringify(e.data));for(var a=0;a<i.devices.length;a++)if(i.devices[a].deviceId==t){i.devices[a].liveStreamUrl=e.data.data.url;break}return e.data}return r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)},function(e){return r.debug("got startStream error:"+JSON.stringify(e.data)),n.reject(e.data)});return{promise:f,cancel:l}},stopStream:function(t){var n=i.getDeviceById(t),a={method:"POST",url:d.getStartStreamUrl(),timeout:15e3,data:this.createStopStreamingPayload(n.parentId,t),headers:{Authorization:o.ssoToken,xcloudId:n.xCloudId}},s=e(a).then(function(e){1==e.data.success?r.debug("got stopStream response:"+JSON.stringify(e.data)):r.warn("server returned error:"+e.data.data.error+e.data.data.message)});return s},startRecord:function(t){var a=_.findWhere(i.devices,{deviceId:t.parentId}),s={method:"POST",url:d.getStartRecordUrl(),timeout:35e3,data:{parentId:t.parentId,deviceId:t.deviceId,olsonTimeZone:a.properties?a.properties.olsonTimeZone:""},headers:{Authorization:o.ssoToken,xcloudId:t.xCloudId}},c=e(s).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)):void r.debug("got startRecord response:"+JSON.stringify(e.data))});return c},stopRecord:function(t){var a=i.getDeviceById(t),s={method:"POST",url:d.getStopRecordUrl(),timeout:35e3,data:{parentId:a.parentId,deviceId:t},headers:{Authorization:o.ssoToken,xcloudId:a.xCloudId}},c=e(s).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)):void r.debug("got stopRecording response:"+JSON.stringify(e.data))});return c},takeSnapshot:function(t){var a=_.findWhere(i.devices,{deviceId:t.parentId}),s={method:"POST",url:d.getTakeSnapshotUrl(),timeout:35e3,data:{parentId:t.parentId,deviceId:t.deviceId,olsonTimeZone:a.properties?a.properties.olsonTimeZone:""},headers:{Authorization:o.ssoToken,xcloudId:t.xCloudId}},c=e(s).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.error+e.data.data.message),n.reject(e.data)):void r.debug("got takeSnapshot response:"+JSON.stringify(e.data))});return c},createTakeFullFrameSnapshotPayload:function(e,t,r){return{to:e,from:o.userId,resource:"cameras/"+t,action:"set",responseUrl:"",publishResponse:!0,transId:a.createTransactionId(),properties:{activityState:r?"fullFrameSnapshot":"userSnapshot"}}},createStartStreamingPayload:function(e,t,r){var n=r?l.CAMERA_SETTINGS_ACTIVITYSTATE_POSITION_MODE:l.CAMERA_SETTINGS_ACTIVITYSTATE_STREAM;return{to:e,from:s.guid(),resource:"cameras/"+t,action:"set",responseUrl:"",publishResponse:!0,transId:a.createTransactionId(),properties:{activityState:n}}},createStopStreamingPayload:function(e,t){return{to:e,from:s.guid(),resource:"cameras/"+t,action:"set",responseUrl:"",publishResponse:!0,transId:a.createTransactionId(),properties:{activityState:l.CAMERA_SETTINGS_ACTIVITYSTATE_IDLE}}},getCameraOrder:function(){var t={method:"GET",url:d.getCameraOrderUrl(),timeout:3e4,headers:{Authorization:o.ssoToken}};r.debug("calling get camera order with config:"+JSON.stringify(t));var n=e(t).then(function(e){r.debug("got camera order result:"+JSON.stringify(e))});return n},setCameraOrder:function(t){for(var n={},i=0;i<t.length;i++)n[t[i].deviceId]=t[i].displayOrder;var a={method:"POST",url:d.getCameraOrderUrl(),timeout:3e4,headers:{Authorization:o.ssoToken},data:{devices:n}};r.debug("calling set camera order with config:"+JSON.stringify(a));var s=e(a).then(function(e){r.debug("got set camera order result:"+JSON.stringify(e))});return s},isPlayActivity:function(e){return-1!=[l.CAMERA_SETTINGS_ACTIVITYSTATE_ACTIVESTREAM,l.CAMERA_ACTIVITYSTATE_ALERT_WATCH,l.CAMERA_ACTIVITYSTATE_START_ALERT_STREAM,l.CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE].indexOf(e)}}}]).factory("gatewayPollingService",["$rootScope","$q","$log","$interval","$state","appProperties","devicesService","userService","notifyService","baseStationService","cameraSettingsService","pushHandlerService","offlineService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){function g(e){var t=e.deviceId;d.getBaseStationResource(t,"basestation"),l.getBaseStationCameraSettings(t);var r=i.current.name;-1!=r.indexOf("settings")?d.getBaseStationResource(t,"modes"):-1!=r.indexOf("cameras")&&(d.getBaseStationResource(t,"modes"),d.getBaseStationResource(t,"rules")),e.properties.connectionState=a.AVAILABLE_STATE,d.rebootingBS[t]=null}function p(e){var t=!1;_.each(_.where(o.devices,{parentId:e.deviceId}),function(e){o.uiStateHash[e.deviceId]&&o.uiStateHash[e.deviceId].play&&(t=!0)}),delete e.modes,delete e.activeMode,delete e.rules,delete e.schedule,delete e.scheduleOn,_.each(_.where(o.devices,{parentId:e.deviceId}),function(e){e.properties||(e.properties={}),e.properties.connectionState=a.UNAVAILABLE_STATE,o.uiStateHash[e.deviceId]={play:!1,record:!1,micLevel:0,showBright:!1}}),e.properties.connectionState=a.UNAVAILABLE_STATE}var m={pollingInterval:3e4,responseTimeout:2e4,gatewayPollingPromise:null,baseStationAlerts:{}};return m.start=function(){window._ACCOUNT_||(this.gatewayPollingPromise=n(function(){m.runPolling()},this.pollingInterval),m.runPolling())},m.runPolling=function(){var e="subscriptions/"+s.userId;
_.each(o.getBaseStations(),function(t){if(t.state==a.PROVISIONED_STATE){var r=[];r.push(t.deviceId);var n=c.createDeviceQuery(t.deviceId,"set",e,{devices:r});c.notifyBaseStation(n,m.processPollResponse,m.processPollFailure,m.responseTimeout).then(function(e){e.data&&e.data.data&&2059==e.data.data.error&&p(o.getBaseStationById(e.config.data.to))})}}),_.each(o.friendedBaseStations,function(t){var r=t.deviceId,n=o.findByParentId(r),i=_.pluck(n,"deviceId"),a=c.createDeviceQuery(r,"set",e,{devices:i});c.notifyBaseStation(a,m.processPollResponse,m.processPollFailure,m.responseTimeout).then(function(e){e.data&&e.data.data&&2059==e.data.data.error&&p(o.getBaseStationById(e.config.data.to))})})},m.shutdown=function(){n.cancel(m.gatewayPollingPromise)},m.processPollResponse=function(e){if(!e||!e.from&&window._DEBUG_)throw"No from property in poll response";if(f.checkTransId(e)){r.debug("Got poll response from device:"+e.from),m.baseStationAlerts[e.from]=null;var t=o.getDeviceById(e.from)||_.findWhere(o.friendedBaseStations,{deviceId:e.from});t.properties||(t.properties={}),t.properties.connectionState&&t.properties.connectionState==a.AVAILABLE_STATE||g(t)}},m.processPollFailure=function(e){if(!e.to&&window._DEBUG_)throw"Expected to in poll query:"+JSON.stringify(e);if(f.checkTransId(e))return r.info("Timed out waiting for device:"+e.to+" to respond, for tansaction:"+e.transId),_.find(m.baseStationAlerts,function(e){return e&&1==e.restarted})?m.baseStationAlerts={}:m.baseStationAlerts[e.to]||(m.baseStationAlerts[e.to]={failed:!0}),_.every(m.baseStationAlerts,_.isObject)&&_.findWhere(m.baseStationAlerts,{failed:!0})?(r.debug("Restarting SSE and Ping. Offline id: "+e.to),m.baseStationAlerts[e.to].restarted=!0,m.shutdown(),u.shutdown(),f.init(),u.init(),void m.start()):void p(o.getDeviceById(e.to)||_.findWhere(o.friendedBaseStations,{deviceId:e.to}))},m}]).factory("baseStationService",["$rootScope","$q","$http","$log","$window","$interval","$injector","$filter","devicesService","userService","schedulingService","transactionService","notifyService","appProperties","urlService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,m){return{rebootingBS:[],pollingInterval:3e4,responseTimeout:1e4,getAllCamerasOfBaseStation:function(e){return _.filter(c.getAllCameras(),function(t){return t.parentId==e})},isBaseStationAvailable:function(e){var t=c.getDeviceById(e);if(!t||!t.properties||!t.properties.connectionState||"available"!=t.properties.connectionState)return!1;var r=this.getAllCamerasOfBaseStation(e);return _.every(r,function(e){return!e.properties.activityState||"idle"===e.properties.activityState})},handleModesEvent:function(e){if(e.properties&&e.properties.activeMode){if(!e.from&&window._DEBUG_)throw"Payload has no from id:"+JSON.stringify(e);var t=c.getBaseStationById(e.from);if(!t&&window._DEBUG_)throw"Base station not found for id:"+e.from;var r=_.findWhere(t.modes,{id:e.properties.activeMode});if(!r&&window._DEBUG_)throw"Mode not found for id:"+e.properties.activeMode;t.activeMode=r}},isScheduleOn:function(e){return e.scheduleOn},syncBaseStation:function(e){var i,a=_.findWhere(c.devices,{deviceId:e});if(!a){n.error("Unable to sync "+e);var o=t.defer();return o.reject(),o.promise}i=a.xCloudId;var s={method:"POST",url:p.getSyncBaseStationUrl(e),timeout:3e4,headers:{Authorization:d.ssoToken,xcloudId:i}};n.debug("calling sync base station with config:"+JSON.stringify(s));var l=r(s).then(function(e){n.debug("got sync base station result:"+JSON.stringify(e))});return l},getAllResources:function(){var e=[],r=this.getResource("basestation");e.push(r),r=this.getResource("schedule"),e.push(r),r=this.getResource("rules"),e.push(r),r=this.getResource("modes"),e.push(r);return t.all(e).then(function(e){for(var t=0;t<e.length;t++);})},getBaseStationResource:function(e,t,r,i){var a=f.createResourceQuery(e,"get",t);n.debug("in getResource, query:"+JSON.stringify(a));var o;return o=arguments.length<=2?f.notifyBaseStation(a,this.attachResource,this.getResourceFailure,this.responseTimeout):f.notifyBaseStation(a,r,i,this.responseTimeout)},getResourceFailure:function(){},attachResource:function(t){var r=_.findWhere(c.devices,{deviceId:t.from});if(!r)return void _.each(t.properties,function(e){var t=c.getCameraById(e.serialNumber);t&&(t.properties=e)});switch("basestation"==t.resource?(r.properties?angular.extend(r.properties,t.properties):r.properties=t.properties,m.processBSUpdate(r)):r[t.resource]=t.properties[t.resource],t.resource){case"modes":_.each(r.modes,function(e){"*****_DEFAULT_MODE_ARMED_*****"==e.name?e.name=s("i18n")("default_mode_armed"):"*****_DEFAULT_MODE_DISARMED_*****"==e.name&&(e.name=s("i18n")("default_mode_disarmed"))}),r.activeMode=_.findWhere(r.modes,{id:t.properties.active});break;case"rules":_.each(r.rules,function(e){if(-1!=e.name.indexOf("**_DEFAULT_RULE_**")){var t=c.getDeviceName(e.triggers[0].deviceId);e.name=s("i18n")("default_rule_name").replace("{cameraName}",t)}});break;case"schedule":r.scheduleOn=t.properties.active}r.properties||(r.properties={}),r.properties.connectionState="available",e.$broadcast(g._RESOURCE_UPDATE_)},setResource:function(e,t,r,i,a){var o=f.createResourceQuery(e,"set",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;s.then(function(e){1==e.data.success?c.setResourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error setting modes, server status "+e.status),c.setResourceError=!0)})},setSubresource:function(e,t,r,i,a){var o=f.createSubresourceQuery(e,"set",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;return s.then(function(e){1==e.data.success?c.setSubresourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error setting modes, server status "+e.status),c.setSubresourceError=!0)}),s},addSubresource:function(e,t,r,i,a){var o=f.createSubresourceQuery(e,"add",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;return s.then(function(e){1==e.data.success?c.addSubresourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error adding sub resource, server status "+e.status),c.addSubresourceError=!0)}),s},addResource:function(e,t,r,i,a){var o=f.createResourceQuery(e,"add",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;s.then(function(e){1==e.data.success?c.addResourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error adding resource, server status "+e.status),c.addResourceError=!0)})},deleteResource:function(e,t,r,i,a){var o=f.createResourceQuery(e,"delete",t,r),s=f.notifyBaseStation(o,i,a,this.responseTimeout),c=this;s.then(function(e){1==e.data.success?c.deleteResourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error deleting resource, server status "+e.status),c.deleteResourceError=!0)})},rebootResource:function(e,t,r,i){var a=f.createResourceQuery(e,"reboot",t),o=f.notifyBaseStation(a,r,i,this.responseTimeout),s=this;o.then(function(e){1==e.data.success?s.rebootResourceError=!1:(e.data.data?n.warn("server returned error:"+e.data.data.error+e.data.data.message):n.error("Error rebooting resource, server status "+e.status),s.rebootResourceError=!0)})},createDefaultMode:function(){return{name:s("i18n")("add_mode_label_title_new"),rules:[]}},createDefaultRule:function(e){return{name:s("i18n")("rule_label_default_value"),id:"ruleNew",triggers:[{deviceId:e,type:"pirMotionActive",sensitivity:80}],actions:[{type:"recordVideo",deviceId:e,stopCondition:{type:"timeout",timeout:10}},{type:"sendEmailAlert",recipients:["__OWNER_EMAIL__"]}]}},setSchedule:function(e,t){n.debug("setting schedule on base station:"+e),this.setResource(e,"schedule",t,this.setScheduleResponseHandler,this.setScheduleErrorHandler)},setScheduleResponseHandler:function(e){if("is"!==e.action);else{var t=c.getBaseStationById(e.from);t.schedule=e.properties.schedule,l.broadcastScheduleEdited()}},setScheduleErrorHandler:function(){},toggleScheduleOn:function(e,t){return n.debug("setting schedule active property on base station:"+e),this.setSubresource(e,g.DEVICE_SCHEDULE,t,this.toggleScheduleOnResponseHandler,this.toggleScheduleOnErrorHandler)},toggleScheduleOnResponseHandler:function(e){if("is"!==e.action);else{var t=c.getBaseStationById(e.from);t.scheduleOn=e.properties[g.DEVICE_SETTINGS_ACTIVE]}},toggleScheduleOnErrorHandler:function(){},setActiveModeResponseHandler:function(e){if(!e.properties||!e.properties.active&&window._DEBUG_)throw"Base station set active mode response does't contain active property";var t=c.getBaseStationById(e.from);t.activeMode=_.findWhere(t.modes,{id:e.properties.active})},setActiveMode:function(e,t){n.debug("setting active mode: "+t[g.DEVICE_SETTINGS_ACTIVE]),this.setSubresource(e,"modes",t,this.setActiveModeResponseHandler,this.setActiveModeErrorHandler)},setActiveModeErrorHandler:function(){},setModeResponseHandler:function(e){if("is"!==e.action);else{var t=c.getDeviceById(e.from);t.modes=_.reject(t.modes,function(t){return t.id===e.properties.id}),t.modes.push(e.properties),l.broadcastModeEdited()}},setMode:function(e,t){n.debug("setting mode:"+t.id);var r=c.getDeviceById(e),i=_.findWhere(r.modes,{id:t.id});r.modes[r.modes.indexOf(i)]=t,this.setSubresource(e,"modes/"+t.id,t,this.setModeResponseHandler,this.setModeErrorHandler)},setModeErrorHandler:function(e){o.get("baseStationService").getBaseStationResource(e.to,"modes")},addMode:function(e,t){n.debug("adding mode:"+t.name),this.addSubresource(e,"modes",t,this.addModeResponseHandler,this.addModeErrorHandler)},addModeResponseHandler:function(e){if("new"!==e.action);else if(e.from)if(e.hasOwnProperty("error"))n.error("got error adding mode:"+JSON.stringify(e.error));else{var t=c.getDeviceById(e.from);_.findWhere(t.modes,{id:e.properties.id})||t.modes.push(e.properties),l.editingModeInfo&&(l.editingModeInfo.addingModeId=e.properties.id),l.broadcastModeAdded()}else;},addModeErrorHandler:function(){},deleteMode:function(e,r){return n.debug("deleting mode: "+JSON.stringify(r)),this.deleteModePromise=t.defer(),this.deleteResource(e,"modes/"+r,null,this.deleteModeResponseHandler,this.deleteModeErrorHandler),this.deleteModePromise.promise},deleteModeResponseHandler:function(e){"deleted"!==e.action?this.deleteModePromise.reject("unexpected action in delete mode response"):e.from?e.error?this.deleteModePromise.reject(e.error):this.deleteModePromise.resolve(e):this.deleteModePromise.reject("unexpected no 'from' property in delete mode response")},deleteModeErrorHandler:function(){this.deleteModePromise&&this.deleteModePromise.reject("unexpected response in delete mode")},setRule:function(e,t){n.debug("setting rule:"+t.id);var r=c.getDeviceById(e),i=_.findWhere(r.rules,{id:t.id});r.rules[r.rules.indexOf(i)]=t,this.setSubresource(e,"rules/"+t.id,t,this.setRuleResponseHandler,this.setRuleErrorHandler)},setRuleResponseHandler:function(e){if("is"!==e.action);else{var t=c.getDeviceById(e.from),r=_.findWhere(t.rules,{id:e.properties.id});t.rules[t.rules.indexOf(r)]=e.properties,l.broadcastRuleEdited()}},setRuleErrorHandler:function(e){o.get("baseStationService").getBaseStationResource(e.to,"rules")},addRule:function(e,t){n.debug("adding rule:"+t.name),this.addSubresource(e,"rules",t,this.addRuleResponseHandler,this.addRuleErrorHandler)},addRuleResponseHandler:function(e){if("new"!==e.action);else if(e.from)if(e.hasOwnProperty("error"))n.error("got error adding rule:"+JSON.stringify(e.error));else{var t=c.getDeviceById(e.from);_.findWhere(t.rules,{id:e.properties.id})||t.rules.push(e.properties),l.editingModeInfo&&(l.editingModeInfo.addingRuleId=e.properties.id),l.broadcastRuleAdded()}else;},addRuleErrorHandler:function(){},reboot:function(e){n.debug("rebooting BS: "+e),this.rebootResource(e,"basestation",this.rebootResponseHandler,this.rebootErrorHandler)},rebootResponseHandler:function(e){e.action},rebootErrorHandler:function(){},manualUpdate:function(e,t){var r=f.createResourceQuery(e,"manualUpgrade","basestation");r.properties={version:t};var n=f.notifyBaseStation(r,function(){},function(){},this.responseTimeout);n.then(function(e){1==e.data.success})},removeDevice:function(e,t){var i={method:"POST",url:p.getRemoveDeviceUrl(),data:{parentId:e,deviceId:t||e},timeout:3e4,headers:{Authorization:d.ssoToken}};n.debug("calling remove camera with config:"+JSON.stringify(i));var a=r(i).then(function(e){n.debug("got remove camera result:"+JSON.stringify(e))});return a},setTimeZone:function(e,t){n.debug("setting time zone:"+t.id),this.setSubresource(e,"basestation",{timeZone:t.id,olsonTimeZone:t.location},this.setTimeZoneResponseHandler,this.setTimeZoneErrorHandler)},setTimeZoneResponseHandler:function(e){"is"!==e.action},setTimeZoneErrorHandler:function(){},setAutoUpdate:function(e,t){n.debug("setting autoUpdateEnabled: "+t),this.setSubresource(e,"basestation",{autoUpdateEnabled:t},this.setAutoUpdateResponseHandler,this.setAutoUpdateErrorHandler)},setAutoUpdateResponseHandler:function(e){"is"!==e.action},setAutoUpdateErrorHandler:function(){},setAntiFlickerMode:function(e,t){this.setSubresource(e,"basestation",{antiFlicker:{mode:t}},this.setAntiFlickerResponseHandler,this.setAntiFlickerErrorHandler)},setAntiFlickerResponseHandler:function(e){"is"!==e.action},setAntiFlickerErrorHandler:function(){},deleteRule:function(e,t){n.debug("deleting rule: "+t),this.deleteResource(e,"rules/"+t,null,this.deleteRuleResponseHandler,this.deleteRuleErrorHandler)},deleteRuleResponseHandler:function(e){if("deleted"!==e.action);else if(e.from){{c.getDeviceById(e.from),e.resource.split("/")[1]}l.broadcastRuleDeleted()}else;},deleteRuleErrorHandler:function(){},renameDevice:function(e){var t={method:"PUT",url:p.getRenameDeviceUrl(),data:{deviceId:e.deviceId,deviceName:e.deviceName,parentId:e.parentId||e.deviceId},timeout:3e4,headers:{Authorization:d.ssoToken}};n.debug("calling rename device with config:"+JSON.stringify(t));var i=r(t).then(function(e){n.debug("got result:"+JSON.stringify(e))});return i},restartBaseStation:function(e){var i={method:"POST",url:p.getRestartDeviceUrl(),data:{deviceId:e},headers:{Authorization:d.ssoToken}};n.debug("calling restart base station with config:"+JSON.stringify(i));var a=r(i).then(function(e){return n.debug("got restart base station result: "+JSON.stringify(e)),e.data&&e.data.success?void 0:t.reject(e.data)});return a}}}]).factory("cameraSettingsService",["$rootScope","$http","$window","$log","$timeout","devicesService","transactionService","baseStationService","userService","utilService","urlService","appProperties","offlineService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){return{positionModeActive:{},gettingCameraSettings:null,refreshData:function(){a.getDevices()},getAllCameraSettingsResponseHandler:function(t){if(this.gettingCameraSettings=!1,"is"!==t.action);else{if(!f.checkTransId(t))return;try{_.each(t.properties,function(e){var t=a.getCameraById(e.serialNumber);t&&(t.properties=e)})}catch(r){var i=a.getDeviceById(t.from);s.syncBaseStation(i.deviceId).then(function(){a.getDevices().then(function(){_.each(t.properties,function(e){var t=a.getCameraById(e.serialNumber);t?(n.info("Base station synced with backend"),t.properties=e):n.error("No camera found in list from web server corresponding to device from base station with deviceId: "+e.deviceId)})})})}e.$broadcast(u._RESOURCE_UPDATE_)}},getAllCameraSettingsErrorHandler:function(e){n.debug("Timeout getting camera settings"),this.gettingCameraSettings=!1;var t=e&&e.to;t&&f.checkTransId(e)&&_.each(a.devices,function(e){e&&e.deviceType==u.CAMERA_DEVICE_TYPE&&e.parentId==t&&(e.properties||(e.properties={}),e.properties.connectionState="unavailable")})},updateSettingsResponseHandler:function(t){if("is"!==t.action);else if(t.from)if(t.hasOwnProperty("error"))n.error("got error updating settings:"+JSON.stringify(t.error)),e.$broadcast("show_error",{data:4006==t.error.code?{message:"The camera is busy and can not perform requested action."}:t.error});else{var r="cameras/";if(t.resource.match(/^cameras\//)){var i=a.getDeviceById(t.resource.substring(r.length));for(var o in t.properties)i.properties[o]=t.properties[o];t.properties&&angular.isNumber(t.properties.brightness)&&e.$broadcast(u.appEvents.BRIGHTNESS_UPDATED,i.deviceId)}e.$broadcast(u._RESOURCE_UPDATE_)}else;},getBaseStationCameraSettings:function(e){n.info("Base station came on line, getting all camera settings"),s.getBaseStationResource(e,"cameras",this.getBaseStationCameraSettingsResponseHandler,this.getBaseStationCameraSettingsErrorHandler)},getBaseStationCameraSettingsResponseHandler:function(t){if("is"!==t.action);else{try{_.each(t.properties,function(e){var t=a.getCameraById(e.serialNumber);t&&(t.properties=e)})}catch(r){var i=a.getDeviceById(t.from);s.syncBaseStation(i.deviceId).then(function(){a.getDevices().then(function(){_.each(t.properties,function(e){var t=a.getCameraById(e.serialNumber);t?(n.info("Base station synced with backend"),t.properties=e):n.error("No camera found in list from web server corresponding to device from base station with deviceId: "+e.deviceId)})})})}e.$broadcast(u._RESOURCE_UPDATE_)}},getBaseStationCameraSettingsErrorHandler:function(){},updateSettings:function(e,t,r){n.debug("updating camera settings");var i=s.setSubresource(e,"cameras/"+t,r,this.updateSettingsResponseHandler,this.updateSettingsErrorHandler);return i},updateSettingsErrorHandler:function(){},isPositionMode:function(e){return this.positionModeActive[e]},togglePositionMode:function(e){if(this.isPositionMode(e))i.cancel(this.positionModeActive[e]),this.positionModeActive[e]=null;else{var t=this;this.positionModeActive[e]=i(function(){t.positionModeActive[e]=null},3e5)}}}}]).factory("billingFlowService",["$q","$state","$rootScope","$modal","$log","appProperties","servicePlanService","setupService","utilService",function(e,t,r,n,i,a,o,s,c){return{params:null,inProgress:!1,processBillingEvent:function(t){var r=!0,n=e.defer();this.params=t;var a=this;return this.inProgress=r,this.makePayment().then(function(){return a.params=null,a.inProgress=!1,n.resolve()},function(e){i.debug("Billing error: "+JSON.stringify(e)),a.inProgress=!1;var t;return e&&e.error&&(t={data:e}),e&&e.data&&(t=e),n.reject(t)}),n.promise},makePayment:function(){var t=e.defer(),r=this;return this.handleQuotation().then(function(){o.changePlan(r.params).then(function(){return i.info("payment or refund successful"),t.resolve()},function(e){return i.info("payment or refund FAILED"),t.reject(e.data)})},function(e){return s.setupPending&&(s.servicePlanSelected=null),t.reject(e)}),t.promise},handleQuotation:function(){var t=e.defer(),r=this;return o.getQuotation(this.params).then(function(e){var a=e.html.match(/<\s*style[^>]*>.*?<\s*\/style>/)[0],o=e.html.match(/<\s*body[^>]*>(.*?)<\s*\/body>/)[1],s="partials/confirmPaymentDialog.html";r.params.cancel&&(s="partials/confirmCancelPlanDialog.html");var d=window._ACCOUNT_?"AcctMgr_":"";c.gaSend(d+(r.params.cancel?"Subscription_CancelServiceQuote_web":"Subscription_ChangeServiceQuote_web"));var l=n.open({template:a+o,windowTemplateUrl:s,backdrop:"static"});l.result.then(function(r){return i.info("Quotation confirm closed"),"ok"==r?t.resolve(e):t.reject({cancel:!0})},function(){return r.inProgress=!1,t.reject()})},function(e){return t.reject(e)}),t.promise}}}]).factory("servicePlanService",["$log","$window","$http","$q","$filter","appProperties","urlService","userService","setupService",function(e,t,r,n,i,a,o,s){return{servicePlans:null,freePlanId:null,selectedServicePlan:null,purchasedPlans:null,getOffersPromise:null,billingInfo:null,paymentId:null,coupons:[],isFreePlan:function(e){return e.planType===a.FREE_PLAN_TYPE},isPaidServicePlan:function(e){return e.planType===a.PAID_PLAN_TYPE},isStoragePlan:function(e){return e.planType===a.STORAGE_PLAN_TYPE},getOffers:function(){var t={method:"GET",url:o.getOffersUrl(),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling get service plan offers with config:"+JSON.stringify(t));var a=this,c=r(t).then(function(t){if(1!=t.data.success)return console.log("  get offers  result  =",t),e.warn("Get offers error:"+t.data.data.code+t.data.data.message),n.reject(t.data);a.servicePlans=i("orderBy")(t.data.data,["-groupNumber","-amount"]);var r=_.find(a.servicePlans,function(e){return a.isFreePlan(e)});a.freePlanId=r.planId});return c},getOffersV1:function(){var t={method:"GET",url:o.getOffersV1Url(),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling get service plan offers with config:"+JSON.stringify(t));var i=r(t).then(function(t){return 1==t.data.success?t.data:(e.warn("Get offers error:"+t.data.data.code+t.data.data.message),n.reject(t.data))});return i},getOffersDetails:function(){var t={method:"GET",url:o.getOffersDetailsUrl(),headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("get offers detail with config: "+JSON.stringify(t));var i=r(t).then(function(e){return 1==e.data.success?e.data:n.reject(e.data)});return i},getPurchasedPlans:function(){var t={method:"GET",url:o.getServicePlanUrl(),timeout:3e4,headers:{Authorization:s.ssoToken}};e.debug("calling get service plan with config:"+JSON.stringify(t));var i=this,a=r(t).then(function(e){return 1!=e.data.success?n.reject(e.data):void(i.purchasedPlans=e.data.data)});return a},getServicePlan:function(){if(!this.purchasedPlans)return null;var e=_.filter(this.purchasedPlans,function(e){return e.planType&&(e.planType===a.FREE_PLAN_TYPE||e.planType===a.PAID_PLAN_TYPE)});return 0==e.length?null:e.length>1?_.findWhere(e,{planType:a.PAID_PLAN_TYPE}):e[0]},getStorageServicePlan:function(){if(!this.purchasedPlans)return null;var t=_.filter(this.purchasedPlans,function(e){return e.planType&&e.planType===a.STORAGE_PLAN_TYPE});return 0==t.length?null:t.length>1?(e.warn("More than one storage plan returned from get purchased plans"),_.findWhere(t,{planType:a.STORAGE_PLAN_TYPE})):t[0]},getBilling:function(){var t={method:"GET",url:o.getPaymentBillingUrl(this.paymentId||s.paymentId),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:"","Content-Type":"application/json"}};e.debug("calling get billing with config:"+JSON.stringify(t));var i=this,a=r(t).then(function(t){return 1==t.data.success?(i.billingInfo=t.data.data,t.data.data):(e.warn("server returned error:"+t.data.code+t.data.message),n.reject(t.data))});return a},modifyBilling:function(t){var i={method:"PUT",data:t,url:o.getModifyBillingUrl(this.paymentId||s.paymentId),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:"","Content-Type":"application/json"}};e.debug("calling modify billing with config:"+JSON.stringify(i));var a=r(i).then(function(t){return 1!=t.data.success?(e.warn("server returned error:"+t.data.data.code+t.data.data.message),n.reject(t.data)):(e.info("Successfully modified billing data"),t)});return a},createAccount:function(t,n){var i={planId:t,modelId:n},a={method:"POST",url:o.getCreatePaymentAccountUrl(),data:i,timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling create free service plan with config:"+JSON.stringify(a));var c=r(a).then(function(t){return 1==t.data.success?t.data.data:void e.warn("server returned error:"+t.data.code+t.data.message)});return c},getQuotation:function(t){var i,a={};t.cancel?i=o.getCancelQuotationUrl(this.paymentId||s.paymentId):(t.setupPlan?(a.planIds=[t.setupPlan.planId],t.setupPlan.couponCode&&(a.coupons=[t.setupPlan.couponCode])):a={planIds:t.toPlanId,coupons:this.coupons},i=o.getChangeQuotationUrl(this.paymentId||s.paymentId));var c={method:"POST",url:i,data:a,timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling get quotation with config:"+JSON.stringify(c));var d=r(c).then(function(t){return 1==t.data.success?t.data.data:(e.warn("server returned error: "+JSON.stringify(t.data)),n.reject(t.data))});return d},changePlan:function(t){var i,a={};if(t.cancel)i=o.getCancelPlanUrl(this.paymentId||s.paymentId);else{if(t.setupPlan)a.planIds=[t.setupPlan.planId],t.setupPlan.couponCode&&(a.coupons=[t.setupPlan.couponCode]);else{if(!t.toPlanId.length){var c=[];c.push(t.toPlanId),t.toPlanId=c}a={planIds:t.toPlanId,coupons:this.coupons}}i=o.getChangePlanUrl(this.paymentId||s.paymentId)}var d={method:"PUT",url:i,data:a,timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:""}};e.debug("calling changePlan with config:"+JSON.stringify(d));var l=r(d).then(function(t){return 1==t.data.success?t.data.success:(e.warn("server returned error: "+JSON.stringify(t.data)),n.reject(t.data))});return l},changeRenew:function(t){var i={method:"PUT",data:{autoRenew:t},url:o.getPaymentRenewUrl(this.paymentId||s.paymentId),timeout:3e4,headers:{Authorization:s.ssoToken?s.ssoToken:"","Content-Type":"application/json"}};e.debug("calling modify renew with config:"+JSON.stringify(i));var a=r(i).then(function(t){return 1!=t.data.success?(e.warn("Modify renew error, server returned: "+t.data.data.code+t.data.data.message),n.reject(t.data)):(e.info("Successfully modified renew"),t)});return a}}}]).factory("devicesService",["$rootScope","$http","$log","$window","$q","$filter","$injector","localStorage","appProperties","setupService","urlService","loginService","userService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){return{devices:null,allDevices:[],friendedBaseStations:[],presentDevices:null,lastTimeHash:{},uiStateHash:{},getDevicesPromise:null,initDevicesPromise:null,queryPresentDevices:function(){var e={method:"GET",url:l.getQueryPresentDevicesUrl(),timeout:3e4,headers:{ContentType:"application/json"}};r.debug("calling query present devices with config:"+JSON.stringify(e));var n=this,a=t(e).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.data.code+e.data.data.message),i.reject(e.data)):void(n.presentDevices=e.data.data.items)});return a},claimDevice:function(e,n,a){var o=angular.copy(a);o.ui&&delete o.ui,d.timeZone&&d.timeZone.ui&&delete d.timeZone.ui;var s={method:"POST",url:l.getClaimDeviceUrl(),data:{xCloudId:e||d.selectedBaseStation._id,deviceId:n||d.selectedBaseStation.hardwareId,timeZone:o||d.timeZone},timeout:3e4,headers:{Authorization:f.ssoToken}};r.debug("calling claim device with config:"+JSON.stringify(s));var c=t(s).then(function(e){return 1!=e.data.success?(r.warn("server returned error:"+e.data.code+e.data.message),i.reject(e.data)):(d.baseStationClaimed=!0,void(f.paymentId||f.setPaymentId(e.data.data.paymentId)))});return c},getDevices:function(n){if(this.getDevicesPromise)return this.getDevicesPromise;var a={method:"GET",url:l.getDevicesUrl()+"?t="+(new Date).getTime().toString(),timeout:35e3,headers:{Authorization:f.ssoToken}};r.debug("getting devices, config:"+JSON.stringify(a));var o=this;return this.getDevicesPromise=t(a).then(function(t){return o.getDevicesPromise=null,t.data&&t.data.success?(o.parseGetDevicesResponse(t.data,n),void o.extractFriendedBaseStations()):(r.error("get devices error, server returned: "+JSON.stringify(t.data)),t&&t.data&&t.data.data.message&&e.$broadcast("show_error",t.data),i.reject(t.data))},function(e){return o.getDevicesPromise=null,i.reject(e.data)}),this.getDevicesPromise},initDevices:function(e){if(this.devices)return i.when(1);if(this.initDevicesPromise)return this.initDevicesPromise;var t=this;return this.initDevicesPromise=this.getDevices(e).then(function(){o.get("gatewayPollingService").start()})["finally"](function(){t.initDevicesPromise=null}),this.initDevicesPromise},getBaseStations:function(){return _.filter(this.devices,function(e){return e.deviceType==c.BASE_STATION_DEVICE_TYPE&&(e.state==c.PROVISIONED_STATE||e.state==c.SYNCED_STATE)})},getBaseStationById:function(e){return _.findWhere(this.devices,{deviceId:e})},extractFriendedBaseStations:function(){var e=this,t=_.reduce(this.devices,function(t,r){return!r.parentId||_.findWhere(e.devices,{deviceId:r.parentId})||_.contains(t,r.parentId)||t.push(r.parentId),t},[]);this.friendedBaseStations=_.map(t,function(e){return{deviceId:e,properties:{}}})},hasOwnDevices:function(){return _.some(this.devices,function(e){return e.userId===e.owner.ownerId})},isPureUser:function(){return _.every(this.devices,function(e){return"USER"===e.userRole})},updateLastDate:function(e){var r={method:"GET",url:e.presignedLastImageUrl,timeout:3e4},n=this;t(r).then(function(t){t.headers("Last-Modified")&&(n.lastTimeHash[e.deviceId]=new Date(t.headers("Last-Modified")).getTime())},function(){n.lastTimeHash[e.deviceId]=e.lastModified})},getDevice:function(e){var n={method:"GET",url:l.getDevicesUrl(e),timeout:5e3,headers:{Authorization:f.ssoToken}};r.debug("getting device, config:"+JSON.stringify(n));var i=this,a=t(n).then(function(e){i.parseGetDeviceResponse(e.data)});return a},getBaseStationDevices:function(e){return _.filter(this.devices,function(t){return t.parentId==e})},parseGetDevicesResponse:function(e,t){if(1==e.success){if(e.data.length&&_.each(e.data,function(e){e&&!e.properties&&(e.properties={}),e&&e.properties&&"basestation"==e.deviceType&&(delete e.properties.updateAvailable,delete e.properties.timeZone,delete e.properties.olsonTimeZone)}),e.data.length<this.allDevices.length&&(this.allDevices=_.filter(this.allDevices,function(t){return _.findWhere(e.data,{deviceId:t.deviceId})})),_.each(e.data,function(e){if("basestation"==e.deviceType&&e.state==c.DEACTIVATED_STATE){var t=_.findWhere(this.allDevices,{deviceId:e.deviceId});return void(t&&(t.state=c.DEACTIVATED_STATE))}var r=_.findWhere(this.allDevices,{deviceId:e.deviceId});if(r)for(var n in e)"properties"==n?(delete e[n].olsonTimeZone,angular.extend(r[n],e[n])):e.hasOwnProperty(n)&&(r[n]=e[n]);else this.allDevices.push(e)},this),this.devices=a("orderBy")(_.filter(this.allDevices,function(e){return e.state!=c.REMOVED_STATE&&e.state!=c.DEACTIVATED_STATE}),"displayOrder"),this.devices&&this.devices.length)for(var n=0;n<this.devices.length;++n)"camera"===this.devices[n].deviceType&&(this.uiStateHash[this.devices[n].deviceId]={play:!1,record:!1,micLevel:0,showBright:!1},t&&this.updateLastDate(this.devices[n]));r.debug("got devices:"+JSON.stringify(e))}else r.warn("Error:"+e.code+", "+e.message)},parseGetDeviceResponse:function(t){if(1==t.success){var n=this.getDeviceById(t.data.deviceId);if(n)for(var i in t.data)"properties"==i?angular.extend(n[i],t.data[i]):t.data.hasOwnProperty(i)&&(n[i]=t.data[i]);else r.warn("adding device which was not present!"),"camera"===t.data.deviceType&&(this.uiStateHash[t.data.deviceId]={play:!1,record:!1,micLevel:0,showBright:!1}),this.devices.push(t.data);this.updateLastDate(n||this.getDeviceById(t.data.deviceId)),r.debug("got device:"+JSON.stringify(t))}else r.warn("Error: "+t.data.code+", "+t.data.message),e.$broadcast("show_error",t)},getAllCameras:function(){return this.devices?_.where(this.devices,{deviceType:c.CAMERA_DEVICE_TYPE,state:c.PROVISIONED_STATE}):[]},getOwnCameras:function(){return _.filter(this.devices,function(e){return e.deviceType==c.CAMERA_DEVICE_TYPE&&e.userId===e.owner.ownerId})},getAllCameraIds:function(){var e=[];if(this.allDevices)for(var t=0;t<this.allDevices.length;t++)this.allDevices[t].deviceType==c.CAMERA_DEVICE_TYPE&&e.push(this.allDevices[t].deviceId);return e},getAvailableCameraIds:function(){var e=[];if(this.allDevices)for(var t=0;t<this.allDevices.length;t++)(this.allDevices[t].deviceType==c.CAMERA_DEVICE_TYPE&&this.allDevices[t].state==c.PROVISIONED_STATE||this.allDevices[t].deviceType==c.CAMERA_DEVICE_TYPE&&this.allDevices[t].mediaObjectCount)&&e.push(this.allDevices[t].deviceId);return e},getDeviceName:function(e){var t=this.getDeviceById(e);return t?t.deviceName:""},findByParentId:function(e){return _.where(this.devices,{parentId:e})},getDeviceById:function(e){return _.findWhere(this.allDevices,{deviceId:e})},getCameraById:function(e){return _.findWhere(this.allDevices,{deviceId:e,deviceType:c.CAMERA_DEVICE_TYPE})},getCameraOwner:function(e){for(var t=!1,r=0,n=null;!t&&r<this.allDevices.length;)this.allDevices[r].deviceId==e?(n=this.allDevices[r].userId,t=!0):r++;
return n},loadSessionData:function(){},clearSessionData:function(){this.devices=null,this.allDevices=[],this.friendedBaseStations=[]}}}]).factory("calendarService",["$state","appProperties","metadataService","libraryService","userService","localStorage","devicesService",function(e,t,r,n,i,a){return{month:null,calendarVals:null,weeks:null,setDefaultMonth:function(){var e=new Date,t=e.getMonth()+1,r=e.getFullYear();this.month=10>t?r.toString()+"0"+t.toString():r.toString()+t.toString(),this.persistMonth()},decrementMonth:function(){var e=new Number(this.month.substring(4))-1;if(0>=e){var t=new Number(this.month.substring(0,4))-1;this.month=t.toString()+"12"}else this.month=10>e?this.month.substring(0,4)+"0"+e.toString():this.month.substring(0,4)+e.toString()},incrementMonth:function(){var e=new Number(this.month.substring(4))+1;if(e>12){var t=new Number(this.month.substring(0,4))+1;this.month=t.toString()+"01"}else this.month=10>e?this.month.substring(0,4)+"0"+e.toString():this.month.substring(0,4)+e.toString()},getFromDate:function(e){var t=new Date(0);return e&&"string"==typeof e&&6===e.length&&(t.setUTCFullYear(new Number(e.substring(0,4))),t.setUTCMonth(new Number(e.substring(4,6))-1)),t.setUTCDate(1),t.setUTCHours(0),t.setUTCMinutes(0),t.setUTCSeconds(0),t.setUTCMilliseconds(0),t.getTime()+60*t.getTimezoneOffset()*1e3},getToDate:function(e){var t=new Date(0);return e&&"string"==typeof e&&6===e.length&&(t.setUTCFullYear(new Number(e.substring(0,4))),t.setUTCMonth(new Number(e.substring(4,6))-1),t.setUTCDate(this.getLastDayOfMonth(e))),t.setUTCHours(23),t.setUTCMinutes(59),t.setUTCSeconds(59),t.setUTCMilliseconds(999),t.getTime()+60*t.getTimezoneOffset()*1e3},getFirstDateOfMonth:function(e){e=null==e?this.month:e;var t=new Date(0);t.setUTCMonth(e.substring(4)-1),t.setUTCFullYear(e.substring(0,4));var r=new Date(t.getTime()+1e4);return r},refreshData:function(){if(i.ssoToken){var e=this,t=r.getMetadata(this.getStartOfMonthDateString(this.month),this.getEndOfMonthDateString(this.month));return t.then(function(){e.setCalendarVals(),e.setWeeks()}),t}this.setCalendarVals(),this.setWeeks()},getFirst:function(){if(i.ssoToken){var e=this,t=r.getFirstMetadata();return t.then(function(){var t=_.sample(_.keys(r.metadata));t&&8==t.length&&(e.month=t.substring(0,6)),e.setCalendarVals(),e.setWeeks()}),t}this.setCalendarVals(),this.setWeeks()},getStartOfMonthDateString:function(e){return e+"01"},getEndOfMonthDateString:function(e){return e+this.getLastDayOfMonth(e)},setCalendarVals:function(){for(var e=[],t=this.getLastDayOfMonth(this.month),r=this.getFirstDateOfMonth(),n=1;t>=n;n++){var i={dayOfMonth:n,dayOfWeek:r.getUTCDay(),numLibraryRecordings:this.getNumRecordingsOnDay(this.month+(10>n?"0"+n:n))};this.getNumRecordingsOnDay(this.month+(10>n?"0"+n:n))&&(this.lastRecordingDay=this.getDayDate(n)),e.push(i),r.setTime(r.getTime()+864e5)}this.calendarVals=e,this.persistCalendarVals()},getMostRecentRecordingsDay:function(){for(var e=(this.getLastDayOfMonth(this.month),this.getLastDayOfMonth(this.month)+1);--e;)if(this.getNumRecordingsOnDay(this.getDayDate(e)))return e;return e+1},getFirstRecordingsDay:function(){var e=1;do{var t=this.month+(10>e?"0"+e:e.toString());if(this.getNumRecordingsOnDay(t))return t;e++}while(32!=e);return this.month+"01"},getDayDate:function(e){return 10>e?this.month+"0"+e.toString():this.month+e.toString()},setWeeks:function(){for(var e=[],t=!1,r=!1,n=1,i=this.calendarVals.length;!r;){for(var a=[],o=0;7>o;o++)r||this.calendarVals[n-1].dayOfWeek!=o?a.push({dayOfMonth:null,dayOfWeek:o,numLibraryRecordings:null}):(a.push(this.calendarVals[n-1]),t=!0),t&&n++,n>i&&(r=!0);e.push(a)}this.weeks=e,this.persistWeeks()},getLastDayOfMonth:function(e){var t=0;switch(Number(e.substring(4))-1){case 1:t=Number(e.substring(0,4))%4==0?29:28;break;case 3:case 5:case 8:case 10:t=30;break;default:t=31}return t},getNumRecordingsOnDay:function(e){var t;if(null!=r.metadata&&(t=0,r.metadata[e]))for(var i in r.metadata[e])_.findWhere(n.selectedCameras,{deviceId:i})&&r.metadata[e].hasOwnProperty(i)&&(t+="all"==n.favorites.value?r.metadata[e][i].favorite+r.metadata[e][i].nonFavorite:"only"==n.favorites.value?r.metadata[e][i].favorite:r.metadata[e][i].nonFavorite);return t},persistMonth:function(){a.setItem("month",this.month)},persistCalendarVals:function(){a.setItem("calendarVals",JSON.stringify(this.calendarVals))},persistWeeks:function(){a.setItem("weeks",JSON.stringify(this.weeks))},loadSessionData:function(){a.month&&(this.month=a.month),a.calendarVals&&(this.calendarVals=JSON.parse(a.calendarVals)),a.weeks&&(this.weeks=JSON.parse(a.weeks))},clearSessionData:function(){this.month=null,this.calendarVals=null,this.weeks=null,a.month&&a.removeItem("month"),a.calendarVals&&a.removeItem("calendarVals"),a.weeks&&a.removeItem("weeks")},createStateParams:function(){this.setDefaultMonth(),this.stateParams={month:this.month,day:this.getDayDate((new Date).getDate()),favorites:t.favoritesOptions[0].value,cameraIds:t.CAMERAS_ALL_SELECTED}},gotoCalendarView:function(t){this.stateParams||this.createStateParams(),t?e.go("calendar.recycled",this.stateParams):e.go("calendar.day",this.stateParams)}}}]).factory("metadataService",["$http","$log","$window","urlService","localStorage","userService","dayService",function(e,t,r,n,i,a){return{metadata:null,getMetadata:function(r,i){var o={dateFrom:r,dateTo:i},s={method:"post",url:n.getMetadataUrl(),data:o,timeout:5e3,headers:{Authorization:a.ssoToken}},c=this;t.debug("config:"+JSON.stringify(s));var d=e(s).then(function(e){1==e.data.success?(t.debug("got metadata:"+JSON.stringify(e.data.data)),c.metadata=e.data.data.meta,c.persistMetadata()):t.warn("metadata query success false")});return d},getFirstMetadata:function(r){var i={method:"get",url:n.getMetadataUrl(),timeout:5e3,headers:{Authorization:a.ssoToken,ContentType:"application/json"}},o=this;t.debug("config:"+JSON.stringify(i));var s=e(i).then(function(e){if(1==e.data.success){if(t.debug("got metadata:"+JSON.stringify(e.data.data)),r)return e.data.data.dateFrom;o.metadata=e.data.data.meta,o.persistMetadata()}else t.warn("metadata query success false")});return s},persistMetadata:function(){i.setItem("metadata",JSON.stringify(this.metadata))},loadSessionData:function(){i.metadata&&(this.metadata=JSON.parse(i.metadata))},clearSessionData:function(){this.metadata=null,i.metadata&&i.removeItem("metadata")}}}]).factory("libraryService",["$window","devicesService","appProperties","localStorage",function(e,t,r,n){return{favorites:null,cameras:null,selectedCameras:[],setFavorites:function(e){if(e){if("string"==typeof e)for(var t=0;t<r.favoritesOptions.length;t++)r.favoritesOptions[t].value==e&&(this.favorites=r.favoritesOptions[t]);else this.favorites=e;"string"==typeof e&&"undefined"==typeof this.favorites&&(this.favorites=r.favoritesOptions[0]),this.persistFavorites()}},initialize:function(){this.favorites=r.favoritesOptions[0];var e=t.getAllCameraIds();this.setCameras(e),this.setSelectedCamerasFromIds(e)},setCameras:function(e){this.cameras=[];for(var r=0;r<e.length;r++)this.cameras.push({deviceId:e[r],cameraName:t.getDeviceName(e[r]),ownerId:t.getCameraOwner(e[r])});this.persistCameras()},setSelectedCameras:function(e){this.selectedCameras=e,this.persistSelectedCameras()},setSelectedCamerasFromIds:function(e){for(var n=[],i=_.where(t.allDevices,{deviceType:r.CAMERA_DEVICE_TYPE}),a=0;a<e.length;a++)for(var o=0;o<i.length;o++)i[o].deviceId==e[a]&&n.push(i[o]);this.selectedCameras=n,this.persistSelectedCameras()},getSelectedCameraIds:function(){for(var e=[],t=0;t<this.selectedCameras.length;t++)e.push(this.selectedCameras[t].deviceId);return e.join(",")},persistFavorites:function(){n.setItem("favorites",JSON.stringify(this.favorites))},persistCameras:function(){n.setItem("cameras",JSON.stringify(this.cameras))},persistSelectedCameras:function(){n.setItem("selectedCameras",JSON.stringify(this.selectedCameras))},loadSessionData:function(){n.favorites&&(this.favorites=JSON.parse(n.favorites)),n.cameras&&(this.cameras=JSON.parse(n.cameras)),n.selectedCameras&&(this.selectedCameras=JSON.parse(n.selectedCameras))},clearSessionData:function(){this.favorites=null,this.cameras=null,this.selectedCameras=null,n.favorites&&n.removeItem("favorites"),n.cameras&&n.removeItem("cameras"),n.selectedCameras&&n.removeItem("selectedCameras")}}}]).factory("dayService",["$filter","userService","libraryService","recordingsService","localStorage",function(e,t,r,n,i){return{day:null,millisecondsInDay:864e5,setDefaultDay:function(e){var t=new Date,r=t.getDate();this.setDay(e+(10>r?"0"+r:r)),this.persistDay()},setDay:function(e){this.day=e,this.persistDay()},getToday:function(){return e("date")(new Date,"yyyyMMdd")},decrementDay:function(){var e=new Number(this.day.substring(6))-1;if(0>=e){var t=new Number(this.day.substring(4,6))-1,r=new Number(this.day.substring(0,4));if(0>=t){r--,t=12;var n=r.toString()+t.toString();e=this.getLastDayOfMonth(n),this.day=n+e.toString()}else if(10>t){var n=r.toString()+"0"+t.toString();e=this.getLastDayOfMonth(n),this.day=n+e.toString()}else{var n=r.toString()+t.toString();e=this.getLastDayOfMonth(n),this.day=n+e.toString()}}else this.day=10>e?this.day.substring(0,6)+"0"+e.toString():this.day.substring(0,6)+e.toString();this.persistDay()},incrementDay:function(){var e=new Number(this.day.substring(6))+1,t=this.getLastDayOfMonth(this.day.substring(0,6));if(e>t){var r=new Number(this.day.substring(4,6))+1,n=new Number(this.day.substring(0,4));r>12?(n++,this.day=n.toString()+"0101"):this.day=10>r?n.toString()+"0"+r.toString()+"01":n.toString()+r.toString()+"01"}else this.day=10>e?this.day.substring(0,6)+"0"+e.toString():this.day.substring(0,6)+e.toString();this.persistDay()},refreshData:function(){return n.getRecordings(this.day,this.day)},persistDay:function(){i.setItem("day",this.day)},getLastDayOfMonth:function(e){var t=0;switch(Number(e.substring(4))-1){case 1:t=Number(e.substring(0,4))%4==0?29:28;break;case 3:case 5:case 8:case 10:t=30;break;default:t=31}return t},loadSessionData:function(){i.day&&(this.day=i.day)},clearSessionData:function(){this.day=null,i.day&&i.removeItem("day")}}}]).factory("recordingsService",["$http","$q","$log","$window","$filter","$injector","$rootScope","appProperties","libraryService","urlService","localStorage","baseStationService","userService","devicesService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g){return{recordings:null,recycled:null,current:null,libraryState:null,getLibraryState:function(){var n={method:"GET",url:d.getLibraryStateUrl(),timeout:3e4,data:"",headers:{Authorization:f.ssoToken,"Content-Type":"application/json; charset=UTF-8"}},i=this;i.recycled=[],r.debug("getting library info: "+JSON.stringify(n));var a=e(n).then(function(e){return 1!=e.data.success?(r.warn("library info query success false"),t.reject(e.data)):(r.debug("got library info: "+JSON.stringify(e.data.data)),void(i.libraryState=e.data.data))});return a},getRecordings:function(t,n){var a={dateFrom:t,dateTo:n},o={method:"POST",url:d.getRecordingsUrl(),data:a,timeout:3e4,headers:{Authorization:f.ssoToken}},s=this;r.debug("getting recordings, data:"+JSON.stringify(a));var c=e(o).then(function(e){if(1==e.data.success){r.debug("got recordings:"+JSON.stringify(e.data.data));var t=_.sortBy(e.data.data,function(e){return-i("toBSTime")(e.utcCreatedDate,e.timeZone)});s.recordings=t,s.persistRecordings()}else r.warn("recordings query success false")});return c},getRecycleRecordings:function(){var n={method:"GET",url:d.getRecycleUrl(),timeout:55e3,headers:{Authorization:f.ssoToken}},i=this;i.recycled=[],r.debug("getting recordings, data:"+JSON.stringify(n));var a=e(n).then(function(e){return 1!=e.data.success?(r.warn("recordings query success false"),o.$broadcast("show_error",{data:{message:"Request for recycled recordings failed!"}}),t.reject(e.data)):(r.debug("got recordings:"+JSON.stringify(e.data.data)),i.recycled=e.data.data,angular.forEach(i.recycled,function(e,t){i.recycled[t].recordingNumber=t}),void 0)});return a},createFavoriteObject:function(){var e={};return e.utcCreatedDate=null,e.createdDate=null,e.deviceId=null,e},favoriteRecordings:function(t,n){for(var i=[],a=0;a<t.length;a++)if(angular.isDefined(t[a])){var o=this.createFavoriteObject();o.createdDate=n[a].createdDate,o.deviceId=n[a].deviceId,o.utcCreatedDate=n[a].utcCreatedDate,i.push(o)}var s={};s.data=i;var c={method:"POST",url:d.getFavoriteUrl(),data:s,timeout:3e4,headers:{Authorization:f.ssoToken}};r.debug("setting favorites, sending data:"+JSON.stringify(c));var l=e(c).then(function(e){1==e.data.success?r.debug("favorites set successfully"):r.warn("favorites not sent")});return l},recycleRecordings:function(n){var i=[];angular.forEach(n,function(e){if(e.selected&&!this.isFavorite(e)){var t={createdDate:e.createdDate,deviceId:e.deviceId,utcCreatedDate:e.utcCreatedDate};i.push(t)}},this);var a={method:"POST",url:d.getRecycleUrl(),data:{data:i},headers:{Authorization:f.ssoToken}};r.debug("setting recycle, sending data:"+JSON.stringify(a));var o=e(a).then(function(e){return 1!=e.data.success?(r.warn("recycle operation not sent"),t.reject(e.data)):void r.debug("recycle settings successful")});return o},shareRecordings:function(){var n=[];this.selectMode?_.each(this.recordings,function(e){e.selected&&n.push({deviceId:e.deviceId,utcCreatedDate:e.utcCreatedDate,createdDate:e.createdDate,timeZone:e.timeZone,mediaDuration:e.mediaDuration,name:e.name,contentType:e.contentType})}):n.push({deviceId:this.current.deviceId,utcCreatedDate:this.current.utcCreatedDate,createdDate:this.current.createdDate,timeZone:this.current.timeZone,mediaDuration:this.current.mediaDuration,name:this.current.name,contentType:this.current.contentType});var i={method:"POST",url:d.getShareUrl(),data:{sharedMediaList:n},headers:{Authorization:f.ssoToken}};r.debug("setting share, sending data:"+JSON.stringify(i));var a=e(i).then(function(e){return 1==e.data.success?(r.debug("share settings successful"),e.data):(r.warn("share operation not sent"),t.reject(e.data))});return a},getSharedRecordings:function(n){var i={method:"GET",url:d.getShareUrl()+"/"+n,headers:{Authorization:f.ssoToken||""}};r.debug("setting share, sending data:"+JSON.stringify(i));var a=e(i).then(function(e){return 1==e.data.success?(r.debug("share settings successful"),e.data):(r.warn("share operation not sent"),t.reject(e.data))});return a},restoreRecordings:function(n){var i=[];angular.forEach(n,function(e){if(e.selected){var t={createdDate:e.createdDate,deviceId:e.deviceId,utcCreatedDate:e.utcCreatedDate};i.push(t)}});var a={method:"PUT",url:d.getRecycleUrl(),data:{data:i},headers:{Authorization:f.ssoToken}};r.debug("restore recycled, sending data:"+JSON.stringify(a));var o=e(a).then(function(e){return 1!=e.data.success?(r.warn("restore recycled operation not sent"),t.reject(e.data)):void r.debug("restore recycled successful")});return o},deleteAllRecordings:function(){var t={method:"DELETE",url:d.getRecycleAllUrl(),data:"",headers:{Authorization:f.ssoToken,"Content-Type":"application/json; charset=UTF-8"}};r.debug("delete all recordings, sending data:"+JSON.stringify(t));var n=e(t).then(function(e){1==e.data.success?r.debug("recycle all successful"):r.warn("recycle all operation not sent")});return n},getNextContent:function(e,t){for(var r=!1,n=e,i=null,a=t.cameraIds==s.CAMERAS_ALL_SELECTED?g.getAvailableCameraIds():t.cameraIds.split(",");e<this.recordings.length-1&&!r;)e++,i=this.recordings[e],i.recycle||"only"==c.favorites.value&&!this.isFavorite(i)||"non"==c.favorites.value&&this.isFavorite(i)||a&&-1==_.indexOf(a,i.deviceId)||(r=!0);return r?i:this.recordings[n]},getPreviousContent:function(e,t){for(var r=!1,n=e,i=null,a=t.cameraIds==s.CAMERAS_ALL_SELECTED?g.getAvailableCameraIds():t.cameraIds.split(",");e>0&&!r;)e--,i=this.recordings[e],i.recycle||"only"==c.favorites.value&&!this.isFavorite(i)||"non"==c.favorites.value&&this.isFavorite(i)||a&&-1==_.indexOf(a,i.deviceId)||(r=!0);return r?i:this.recordings[n]},persistRecordings:function(){for(var e=0;e<this.recordings.length;e++)this.recordings[e].recordingNumber=e;l.setItem("recordings",JSON.stringify(this.recordings))},loadSessionData:function(){l.recordings&&(this.recordings=JSON.parse(l.recordings))},clearSessionData:function(){this.recordings=null,this.selectMode=!1,l.recordings&&l.removeItem("recordings")},setCurrent:function(e){this.current=e},isFavorite:function(e){return e&&e.currentState==s.FAVORITE_STATE},toggleFavorite:function(e){return e.currentState=e.currentState==s.FAVORITE_STATE?s.NEW_STATE:s.FAVORITE_STATE,e}}}]).factory("uiService",["$rootScope","$modal","$state","userService",function(e,t,r,n){return{scope:e.$new(!0),info:function(e){this.scope.infoMessage=e;var r=t.open({templateUrl:"partials/infoDialog.html",backdrop:!0,scope:this.scope});return r.result},processBSUpdate:function(e){if(!this.scope.bs&&!n.ignoreUpdates&&"OWNER"==e.userRole&&e.properties&&e.properties.updateAvailable&&!e.properties.autoUpdateEnabled){this.scope.notifiedBS||(this.scope.notifiedBS=[]);var i=e.deviceId+e.properties.updateAvailable.version;if(-1!=this.scope.notifiedBS.indexOf(i))return;this.scope.bs=e,this.scope.notifiedBS.push(i);var a=this;this.scope.remindChanged||(this.scope.remindChanged=this.remindChanged),this.scope.remindUpdate=!0;var o=t.open({templateUrl:"partials/confirmBSUpgradeDialog.html",backdrop:"static",scope:this.scope});o.result.then(function(){r.go("settings.baseStation.update",{baseStationId:e.deviceId})})["finally"](function(){a.scope.bs=null})}},remindChanged:function(){n.setIgnoreUpdates(!this.remindUpdate)}}}]).factory("offlineService",["$rootScope","$http","$timeout","$state","$filter","$injector",function(e,t,r,n,i,a){return{isOffline:!1,startTime:(new Date).getTime(),init:function(){this.startTime=(new Date).getTime()},checkOffline:function(){var o="/img2/drag_header.png?t="+(new Date).getTime(),s=this;this.promise||(this.promise=t({method:"GET",url:o,timeout:3e4}).then(function(){s.isOffline=!1},function(){s.isOffline=!0,a.get("userService").setFromLogout(),a.get("logoutService").logout(!0).then(function(){n.go("login")}),r(function(){e.$broadcast("show_error",{data:{message:i("i18n")("error_no_internet_connection")}})},500)})["finally"](function(){s.promise=null}))},checkTransId:function(e){if(this.startTime){if("mediaUploadNotification"==e.resource||"diagnostics"==e.resource)return!0;var t=e.transId&&e.transId.split("!"),r=t&&parseInt(t[2],10);return r>this.startTime}return!1}}}]).factory("beforeUnload",["$window",function(e){var t="Arlo is processing your request.",r="Are you sure you want to leave without finishing?";return{init:function(n,i){t=n||t,r=i||r,e.onbeforeunload=function(){return t+"\n"+r}}}}]).factory("sessionExpire",["$rootScope","$state","$timeout","appProperties","userService","loginService","logoutService",function(e,t,r,n,i,a,o){var s={timeout:null,time:18e5,init:function(){s.timeout=r(s.checkExpire,s.time),e.$on(n.appEvents.BODY_CLICK,function(){r.cancel(s.timeout),s.timeout=r(s.checkExpire,s.time)})},checkExpire:function(){t.current.authenticate?i.isLoggedIn()&&(a.redirectError="Session expired. Please relog-in.",o.logout()["finally"](function(){i.setFromLogout(),t.go("login")})):(r.cancel(s.timeout),s.timeout=r(s.checkExpire,s.time))}};return s}]).factory("webRTC",["$rootScope","$state","$timeout","appProperties","userService","loginService","logoutService",function(){function e(){console.log("Success")}function t(e){console.log("Failure="+e.name+e.message)}var r={PeerConnection:window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,SessionDescription:window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,getUserMedia:navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,streamAudio:function(){var n={iceServers:[{url:"stun:stun.l.google.com:19302"}]},i=new r.PeerConnection(n);r.getUserMedia({audio:!0,video:!1},function(r){i.addStream(r),i.createOffer(function(r){i.setLocalDescription(r,e,t),console.log(i.localDescription.sdp)},t)},t)}};return r}]),angular.module("arloApp.controllers",[]).controller("LoginCtrl",["$scope","$rootScope","$location","$log","$state","$timeout","$modal","$q","$locale","$filter","appProperties","loginService","logoutService","setupService","devicesService","userService","urlService","cameraSettingsService","baseStationService","pushHandlerService","libraryService","calendarService","dayService","servicePlanService","appStateService","localStorage","utilService","offlineService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,m,v,h,S,y,I,E,T,b,A,C,_,w){e.init=function(){if(n.debug("Initializing login view"),e.notAccount=!window._ACCOUNT_,e.isFriendUser()||e.resettingPassword()||!_.checkMobile()){if(m.isLoggedIn()&&e.isFriendUser())m.ssoToken=null;else if(m.isLoggedIn())return void i.go(window._ACCOUNT_?"settings.subscription":"cameras");m.settings&&(e.userId=m.userName,e.rememberMe=!0,m.fromLogout?e.password=m.getSettings():e.attemptLogin(!0)),g.setupPending=!0,u.redirectError&&a(function(){t.$broadcast(l.appEvents.SHOW_ERROR,{data:{message:u.redirectError}}),u.redirectError=null})}},e.attemptLogin=function(r){if(!_.checkMobile()&&(e.loginError=null,e.userId&&e.password||r)){e.inProgress=!0,e.rememberMe||m.clearSettings();var n;if(e.isFriendUser()){var a=R().split("=")[1],c=a.search("#");c>-1&&(a=a.substr(0,c)),c=a.search("/"),c>-1&&(a=a.substr(0,c)),n=u.checkCredentials(e.userId,e.password,a)}else n=u.checkCredentials(e.userId,r?m.getSettings():e.password);n.then(function(n){if(m.isLoggedIn()){t.$broadcast(l.appEvents.HIDE_ERROR,null),e.inProgress=!0,e.viewMode=!1;var a,c=n.data.accountStatus;if(n.data.tocUpdate&&n.data.policyUpdate)a=o.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:n.data.tocLink,scope:e,backdrop:"static"}).result.then(function(t){return"ok"==t?u.updateTosVersion(n.data.tocVersion).then(function(){return o.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:n.data.policyLink,scope:e,backdrop:"static"}).result.then(function(e){return"ok"==e?u.updatePolicyVersion(n.data.policyVersion):s.reject()})},function(){return s.reject()}):s.reject()});else if(n.data.policyUpdate)a=o.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:n.data.policyLink,scope:e,backdrop:"static"}).result.then(function(e){return"ok"==e?u.updatePolicyVersion(n.data.policyVersion):s.reject()});else if(n.data.tocUpdate)a=o.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:n.data.tocLink,scope:e,backdrop:"static"}).result.then(function(e){return"ok"==e?u.updateTosVersion(n.data.tocVersion):s.reject()});else{var d=s.defer();a=d.promise,d.resolve()}a.then(function(){m.clearFromLogout(),g.setupPending=!1,e.rememberMe&&!r&&m.setSettings(e.password),w.init(),y.init(),i.go(window._ACCOUNT_?"settings.subscription":"verifyBilling"==c?"settings.billingInformation":"cameras")},function(e){m.setSsoToken(""),e&&t.$broadcast(l.appEvents.SHOW_ERROR,e)})["finally"](function(){e.inProgress=!1})}},function(t){e.inProgress=!1,e.loginError=t&&t.data&&t.data.message?t.data.message:d("i18n")("login_error_validation_username")})}},e.systemSetup=function(){A.clearSessionData();var e;if(g.start(),g.setupPending)if(g.baseStationClaimed){if(g.accountRegistered)throw"Unknown system setup state";e="accountRegistration"}else e="gettingStarted";else e="cameras";g.updateSetupState(),i.go(e)},e.createAccount=function(){var e=l.accountRegistrationRoute;r.path(e)},e.resetPassword=function(){var t=r.absUrl(),n=t.match(new RegExp("/[?&]"+l.resetPasswordTokenText+"([^&#]*)?[/#]","i")),i=n&&n[1]?n[1]:null,a=u.resetPassword(e.newPassword,i);a.then(function(){location.href=r.protocol()+"://"+r.host()+(r.port()?":"+r.port():"")})},e.isFriendUser=function(){var e=r.absUrl(),t=e.toLowerCase().indexOf(l.registerTokenText);return 0>t?!1:!0};var R=function(){var e=r.absUrl().toLowerCase(),t=e.indexOf(l.registerTokenText);return 0>t?"":e.substr(t)};e.resettingPassword=function(){var e=r.absUrl().toLowerCase(),t=e.indexOf(l.resetPasswordTokenText);return 0>t?!1:!0},e.gotoLogin=function(){location.href=r.protocol()+"://"+r.host()+(r.port()?":"+r.port():"")},e.gotoLogout=function(){m.setFromLogout();var e=f.logout();e.then(function(){i.go("login")})},e.isLoggedIn=function(){return m.isLoggedIn()}}]).controller("PasswordHelpCtrl",["$scope","loginService",function(e,t){e.submit=function(){e.inProgress=!0,e.error=null;var r=t.requestPasswordReset(e.email);r.then(function(){e.inProgress=!1,e.sent=!0},function(t){e.error=t.data.message})}}]).controller("CamerasCtrl",["$scope","$rootScope","$state","$stateParams","$log","$timeout","$q","$filter","appProperties","devicesService","camerasService","dayService","libraryService","calendarService","cameraSettingsService","servicePlanService","baseStationService","offlineService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,m,v,h,S){function y(){if(null!=navigator.plugins&&navigator.plugins.length>0)return navigator.plugins["Shockwave Flash"]&&!0;if(~navigator.userAgent.toLowerCase().indexOf("webtv"))return!0;if(~navigator.appVersion.indexOf("MSIE")&&!~navigator.userAgent.indexOf("Opera"))try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash")&&!0}catch(e){}return!1}function I(){$f()&&(angular.isArray($f().getVersion())||e.disableTimeout)||(e.disableTimeout=a(function(){if(!$f()||!angular.isArray($f().getVersion())){var r=!0;for(var n in e.uiStates){var i=e.uiStates[n];i.loading&&(i.loading=!1,r=!1,e.startErrors[n]="Adobe ShockwaveFlash plug-in disabled!")}!e.deviceId&&r&&t.$broadcast(c.appEvents.SHOW_ERROR,{data:{message:"Adobe ShockwaveFlash plug-in disabled!"}})}e.disableTimeout=null},2e4))}function E(){var t=s("i18n")("marketing_how_to_sync_camera_content"),r=t.split("\n");e.syncSteps=[],_.each(r,function(t){t&&e.syncSteps.push(0==t.indexOf("o ")?t.substr(2):t)})}function T(e){var t=d.getBaseStationById(e.parentId);return t&&!t.properties.olsonTimeZone?(S.info(s("i18n")("timezone_error")),!1):!0}var b={},A={},C={},w=0;e.sliderClick=function(t,r){var n=t.offsetX;if(!t.hasOwnProperty("offsetX"))var i=t.target||t.srcElement,a=i.getBoundingClientRect(),n=t.clientX-a.left;var o=100*(n-5)/angular.element(t.currentTarget).prop("offsetWidth");e.setPercent(o,r)},e.setPercent=function(t,r){e.uiStates[r].brightness=Math.round(t/25)-2},e.showBrightness=function(t){e.uiStates[t.deviceId].showBright?e.uiStates[t.deviceId].showBright=!1:angular.extend(e.uiStates[t.deviceId],{brightnessUpdating:!1,brightness:t.properties.brightness,showBright:!0})},e.getCameras=function(){return d.getAllCameras()},e.getCamera=function(){return d.getDeviceById(e.deviceId)},e.getSyncedCameras=function(){var e=_.findWhere(d.devices,{deviceType:c.CAMERA_DEVICE_TYPE,state:c.SYNCED_STATE});return e?[e]:[]},e.isCameraRecording=function(t){return e.uiStates[t.deviceId].record||-1!=[c.CAMERA_ACTIVITYSTATE_START_ALERT_STREAM,c.CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE,c.CAMERA_ACTIVITYSTATE_ALERT_WATCH].indexOf(t.properties.activityState)},e.getCameraState=function(t){return e.isCameraConnecting(t)?"connecting":"upgradeInProgress"==t.properties.activityState?"upgrade":t.properties.connectionState==c.UNAVAILABLE_STATE?"offline":t.properties.connectionState==c.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL?"critical":e.startErrors[t.deviceId]?"start_error":e.uiStates[t.deviceId].loading?"loading":e.stopTimeouts[t.deviceId]||e.uiStates[t.deviceId].play||-1==_.indexOf([c.CAMERA_SETTINGS_ACTIVITYSTATE_IDLE,c.CAMERA_SETTINGS_ACTIVITYSTATE_ACTIVESTREAM,c.CAMERA_ACTIVITYSTATE_START_ALERT_STREAM,c.CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE,c.CAMERA_SETTINGS_ACTIVITYSTATE_STREAM,c.CAMERA_ACTIVITYSTATE_ALERT_WATCH],t.properties.activityState)?null:t.properties.hasStreamed?"idle":"idle_new"},e.getOfflineMessage=function(e){if(h.isOffline)return s("i18n")("error_no_internet_connection");var t=d.getDeviceById(e.parentId)||_.findWhere(d.friendedBaseStations,{deviceId:e.parentId});if(t&&t.properties&&t.properties.connectionState){if(t.properties.connectionState==c.UNAVAILABLE_STATE)return s("i18n")("camera_state_gateway_offline");if(e.properties&&e.properties.connectionState==c.UNAVAILABLE_STATE)return s("i18n")("camera_state_offline")}return""},e.init=function(){if(i.debug("initializing cameras controller"),-1!=window.location.href.toLowerCase().indexOf(c.registerTokenText))return void(window.location.href="/#/cameras");if(e.scrollable=!1,e.isOfferShown=!1,e.stopTimeouts={},e.startErrors={},e.deviceId=n.deviceId||null,e.uiStates=d.uiStateHash,e.deviceId&&(e.positionMode=!0,!d.devices))return void r.go("settings");if(!e.deviceId){var o=d.initDevices();if(o.then(function(){_.each(e.getCameras(),function(t){e.lastTimeHash[t.deviceId]||d.updateLastDate(t),e.uiStates[t.deviceId].loading=!1,e.uiStates[t.deviceId].play=!1,e.uiStates[t.deviceId].zoom=!1}),_.each(d.getBaseStations(),function(e){e.properties&&e.properties.connectionState==c.AVAILABLE_STATE&&(e.modes||v.getBaseStationResource(e.deviceId,"modes"),e.rules||v.getBaseStationResource(e.deviceId,"rules"))})}),m.purchasedPlans)e.servicePlan=m.getServicePlan();else{var o=m.getPurchasedPlans();o.then(function(){e.servicePlan=m.getServicePlan()})}}if(e.ownDisplayed=[],e.isSafari=-1!=navigator.userAgent.indexOf("Safari/534.57.2"),e.isIE10=null!=navigator.userAgent.match(/MSIE [6789]/),e.isSafari||e.isIE10)return void r.go("oldBrowser");a(function(){y()||t.$broadcast(c.appEvents.SHOW_ERROR,{data:{message:s("i18n")("camera_player_plugin_not_installed")}}),e.deviceId&&(e.play(e.deviceId),e.positionTimeout=a(function(){e.stopPlay(e.deviceId)},3e5))});try{e.shutter=new Audio("/mp3/camera-shutter.mp3")}catch(l){}e.lastTimeHash=d.lastTimeHash,document.onkeyup=function(t){var r;if(!t)var t=window.event;t.keyCode?r=t.keyCode:t.which&&(r=t.which),27==r&&e.isOfferShown&&e.showOfferView()},s("i18n")("marketing_how_to_sync_camera_content")?E():e.$on("localizeResourcesUpdated",E)},e.$on(c.appEvents.BODY_CLICK,function(t,r){("cameraViews"==r.target.id||r.target.classList.contains("header")||r.target.classList.contains("footer"))&&e.isOfferShown&&e.showOfferView()}),e.canRecord=function(e){return"USER"!=e.userRole},e.canTakeSnapshot=function(e){return"USER"!=e.userRole},e.numOwnCameras=function(){return _.reduce(e.getCameras(),function(e,t){return e+(t.userId===t.owner.ownerId?1:0)},0)},e.isNoCameras=function(){return d.devices&&!_.findWhere(e.getCameras(),{state:c.PROVISIONED_STATE})},e.isScrollable=function(){return e.scrollable=!!(document.body.clientHeight-document.getElementById("cameraViews").scrollHeight-120)},e.showOfferView=function(){e.isOfferShown=!e.isOfferShown},e.hasServicePlan=function(){return e.servicePlan&&d.devices?!0:!1},e.servicePlanCameraCount=function(){return e.servicePlan?e.servicePlan.maxCameras:0};e.$on("$destroy",function(){R(),A={},e.go=!0,a.cancel(e.positionTimeout),a.cancel(e.disableTimeout);for(var t in e.uiStates){var r=e.uiStates[t];r.play&&e.stopPlay(t),r.loading&&(r.loading=!1)}});var R=e.$on(c.appEvents.CAMERA_ERROR,function(t,r){var n=r.deviceId;4015!=r.code?(e.startErrors[n]=r.message,e.uiStates[n].loading&&(e.uiStates[n].loading=!1),e.stopPlay(n)):(C[n]?C[n]+=1:C[n]=1,4==C[n]?(b[n]&&b[n].cancel(),b[n]=null):(b[n]&&b[n].cancel(),a(function(){e.play(n)},3e3))),b[n]&&(b[n].cancel(),b[n]=null)});e.$on(c.appEvents.BRIGHTNESS_UPDATED,function(t,r){w&&(e.uiStates[r].showBright=!1,e.uiStates[r].brightnessSaved=!0,a(function(){w--,e.uiStates[r].brightnessSaved=!1},4e3))}),e.clearStartError=function(t){e.startErrors[t]=null},e.setCameraBright=function(t){w++,p.updateSettings(t.parentId,t.deviceId,{brightness:e.uiStates[t.deviceId].brightness}),e.uiStates[t.deviceId].brightnessUpdating=!0},e.isCameraConnecting=function(e){return e.properties&&!e.properties.connectionState},e.isCameraOnline=function(e){var t=d.getDeviceById(e.parentId);return t?t.properties&&t.properties.connectionState==c.AVAILABLE_STATE&&e.properties&&(e.properties.connectionState==c.AVAILABLE_STATE||e.properties.connectionState==c.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL):e.properties&&(e.properties.connectionState==c.AVAILABLE_STATE||e.properties.connectionState==c.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL)
},e.play=function(t){if(i.debug("Start play pressed."),!y())return void(e.startErrors[t]=s("i18n")("camera_player_plugin_not_installed"));var r=d.getDeviceById(t);e.uiStates[r.deviceId].loading=!0,e.uiStates[r.deviceId].zoom=!1,A[t]={gettingUrl:!0},b[t]=l.startStream(t,e.positionMode),b[t].promise.then(function(n){if(b[t]=null,e.$$destroyed||!n.retried){if(e.$$destroyed||n.canceled)return void l.stopStream(t);r=d.getDeviceById(t),i.debug(new Date+": got live stream dynamically:"+r.liveStreamUrl),(e.isSafari||e.isIE10)&&(e.uiStates[r.deviceId].play=!0,e.uiStates[r.deviceId].loading=!1,e.clearStartError(r.deviceId),C[r.deviceId]=0),P(r)}},function(n){return b[t]=null,e.$$destroyed||e.uiStates[t].play?void l.stopStream(t):(r=d.getDeviceById(t),n&&!e.startErrors[r.deviceId]&&(e.startErrors[r.deviceId]="Error "+(n.data.error||"")+": "+n.data.message),e.uiStates[r.deviceId].play=!1,e.uiStates[r.deviceId].loading=!1,void(A[r.deviceId]&&!A[r.deviceId].stopped?(e.clearStartError(r.deviceId),e.play(r.deviceId)):A[r.deviceId]=null))})};var P=function(t){{var r={key:"#$47cc9f6a88604d203d3",debug:!1,log:{level:"error",filter:"*"},onBeforeFullscreen:function(){return this.isFullscreen()||e.maximizeId||e.deviceId?(this.isFullscreen()||(e.maximizeId=null),!0):(e.maximizeId=t.deviceId,!1)},play:{opacity:0},clip:{autoPlay:!0,autoBuffering:!0,url:t.liveStreamUrl.slice(-27),live:!0,provider:"influxis",connectionProvider:"secure",bufferLength:1,onBufferEmpty:function(){i.debug("flowplayer buffer empty on device:"+t.deviceId)},onStart:function(){i.debug(new Date+": flowplayer started on device: "+t.deviceId);var r=d.getDeviceById(t.deviceId);e.uiStates[r.deviceId].loading=!1,e.uiStates[r.deviceId].play=!0,e.clearStartError(r.deviceId),C[r.deviceId]=0},onStop:function(){i.debug("flowplayer onStop called on device:"+t.deviceId),this.stop(),this.isFullscreen()&&this.toggleFullscreen()},onBufferStop:function(){i.debug("flowplayer stop buffering called on device:"+t.deviceId)},onPause:function(){i.debug("flowplayer onPause called on device:"+t.deviceId),this.stop()}},plugins:{influxis:{url:"flowplayer/flowplayer.rtmp-3.2.13.swf",proxyType:"best",netConnectionUrl:encodeURIComponent(t.liveStreamUrl)},secure:{url:"flowplayer/flowplayer.securestreaming-3.2.9.swf",token:"PgtFksiOpsIyWZsfejCohmtqGszDkb8REbL3yZLOF6uSUIyFH9etV7QYuLuZ5MA"},controls:{url:"flowplayer/flowplayer.controls-3.2.16.swf",top:"10px",right:"25px",height:"34px",width:"34px",background:"transparent",backgroundGradient:"none",all:!1,fullscreen:!0,tooltips:{buttons:!1,fullscreen:"Enter fullscreen mode"}}},onError:function(r,n){return i.debug("Flowplayer error "+r+": "+n),this.stop(),"200"==r?void e.play(t.deviceId):(e.startErrors[t.deviceId]=n||"Flowplayer: unknown error",void e.stopPlay(t.deviceId))}};$f(t.deviceId,{src:"flowplayer/flowplayer.commercial-3.2.18.swf",wmode:"opaque",onFail:function(){e.uiStates[t.deviceId].loading=!1,e.startErrors[t.deviceId]=s("i18n")("camera_player_plugin_not_installed"),i.debug("Flash not installed.")}},r).play()}I()};e.stopPlay=function(t){if(!e.uiStates[t].recordRequest&&!e.uiStates[t].snapshotRequest){e.normalExit=!0,A[t].stopped=!0;var n=d.getDeviceById(t);if(n){e.uiStates[t].play=!1,e.uiStates[t].record=!1,e.uiStates[t].showBright=!1,e.uiStates[t].loading=!0,e.stopTimeouts[t]=!0,a(function(){e.stopTimeouts[t]=null},1e3);var o=$f(t);o&&(o.pause(),o.unload()),e.uiStates[n.deviceId].loading=!1,e.maximizeId=null,i.info("stream on camera:"+t+" successfully stopped"),e.deviceId&&!e.go&&r.go("settings.camera",{deviceId:e.deviceId})}}},e.startRecord=function(r){var n=d.getDeviceById(r);if(T(n)){e.uiStates[n.deviceId].recordRequest=!0;var a=l.startRecord(n);a.then(function(){i.debug("started recording"),n=d.getDeviceById(r),e.uiStates[n.deviceId].recordRequest=!1,e.uiStates[n.deviceId].record=!0},function(i){n=d.getDeviceById(r),e.uiStates[n.deviceId].recordRequest=!1,t.$broadcast(c.appEvents.SHOW_ERROR,i)})}},e.stopRecord=function(r){var n=d.getDeviceById(r);e.uiStates[n.deviceId].recordRequest=!0;var a=l.stopRecord(r);a.then(function(){i.debug("stop recording call returned "),n=d.getDeviceById(r),e.uiStates[n.deviceId].recordRequest=!1,e.uiStates[n.deviceId].record=!1},function(i){n=d.getDeviceById(r),e.uiStates[n.deviceId].recordRequest=!1,e.uiStates[n.deviceId].record=!1,t.$broadcast(c.appEvents.SHOW_ERROR,i)})},e.takeSnapshot=function(r){var n=d.getDeviceById(r);if(T(n)){e.shutter&&e.shutter.play(),e.uiStates[n.deviceId].snapshotRequest=!0;var a=l.takeSnapshot(n);a.then(function(){n=d.getDeviceById(r),e.uiStates[n.deviceId].snapshotRequest=!1,i.debug("snapshot taken")},function(i){n=d.getDeviceById(r),e.uiStates[n.deviceId].snapshotRequest=!1,t.$broadcast(c.appEvents.SHOW_ERROR,i)})}},e.filterByCamera=function(e){g.createStateParams(),g.stateParams.cameraIds=[e.deviceId],g.gotoCalendarView()},e.toggleFullscreen=function(t){e.maximizeId=e.maximizeId?null:t.deviceId},e.isRecording=function(t){return t.properties&&-1!=[c.CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE,c.CAMERA_ACTIVITYSTATE_ALERT_WATCH].indexOf(t.properties.activityState)?!0:e.uiStates[t.deviceId]&&e.uiStates[t.deviceId].record},e.getLastTime=function(t){if(!e.lastTimeHash[t.deviceId])return"";var r,n=d.getBaseStationById(t.parentId);return n&&n.properties&&n.properties.olsonTimeZone?r=n.properties.olsonTimeZone:t.properties.olsonTimeZone&&(r=t.properties.olsonTimeZone),r?s("date")(s("toBSTime")(e.lastTimeHash[t.deviceId],r),"short"):""}}]).controller("CalendarCtrl",["$scope","$rootScope","$stateParams","$state","$modal","$filter","$log","devicesService","calendarService","libraryService","appProperties","dayService","utilService","metadataService","recordingsService","calendarNamesService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,m){function v(t){e.todayDisable=e.firstDisable=e.prevDisable=e.nextDisable=!0,e.month=c.month,e.currentMonth=u.getToday().substring(0,6),e.lastMonth=c.month==e.currentMonth,c.decrementMonth(),e.nextMonth=c.month==e.currentMonth,c.incrementMonth(),e.isLastDayOfMonth=u.getToday()==e.month+c.getLastDayOfMonth(e.month),e.loading=!0;var r=c.refreshData();return r.then(function(){if(e.weeks=c.weeks,e.favorites=d.favorites,e.favoritesOptions=l.favoritesOptions,e.cameras=d.cameras,e.selectedCameras=d.selectedCameras,!c.stateParams.day||t||0==c.getNumRecordingsOnDay(c.stateParams.day)){var r=t?c.getFirstRecordingsDay():c.getDayDate(c.getMostRecentRecordingsDay());if(c.stateParams.day!=r)return c.stateParams.day=r,void c.gotoCalendarView(e.recycleModeEnable)}f.gaSend(e.isFiltered()?"Library_Filtered_web":"Library_web");var n=g.getFirstMetadata(!0);n.then(function(t){e.firstDisable=t?t.substring(0,6)==e.month:!0,e.todayDisable=t?e.month==a("date")(new Date,"yyyyMM"):!0,e.prevDisable=e.nextMonth?!1:t?+t.substring(0,6)>=+e.month:!0,e.nextDisable=e.nextMonth?!0:e.isLastDayOfMonth?!1:e.currentMonth==e.month?!0:!1})})["finally"](function(){e.loading=!1}),r}e.todayDisable=e.firstDisable=e.prevDisable=e.nextDisable=!0,e.init=function(){o.debug("entering init of calendar controller"),e.$parent.selectMode=!1,t.selectAllMode=!1,s.initDevices().then(function(){r.favorites&&d.setFavorites(r.favorites),e.favorites=d.favorites;var t=r.cameraIds.split(",")==l.CAMERAS_ALL_SELECTED?s.getAvailableCameraIds():r.cameraIds.split(",");e.deviceIds=r.cameraIds,d.setSelectedCamerasFromIds(t),e.month=r.month?c.month=r.month:c.month,v()}),this.names=m.getCalendar()},e.goToRecycle=function(){n.go("calendar.recycled",angular.copy(r))},e.getDay=function(t){var r=e.month+(10>t?"0"+t:t);return r},e.getDayType=function(t){var r="calendar-day";return t.numLibraryRecordings>0&&(e.isFiltered()&&(r+=" calendar-day-filter"),r+=" calendar-day-video"),r},e.getCameras=function(){return e.selectedCameras?e.selectedCameras:s.devices&&!e.isFiltered()?(e.cameras=_.filter(s.devices,function(e){return e.deviceType==l.CAMERA_DEVICE_TYPE&&(e.state==l.PROVISIONED_STATE||e.state==l.SYNCED_STATE)}),e.sortDevices(),e.cameras):[]},e.sortDevices=function(){e.cameras=a("orderBy")(e.cameras,"displayOrder")},e.reloadCalendar=function(){e.$parent.selectMode&&e.toggleSelectMode(),v()},e.getCellType=function(t,r){var n="";if(t.dayOfMonth){var i=u.getToday(),a=e.month+(t.dayOfMonth<10?"0":"")+t.dayOfMonth;t&&a==i?n+=" calendar-day-white calendar-day-today":(!e.lastMonth||parseInt(i)>parseInt(a))&&(n+=" calendar-day-white")}else e.lastMonth&&0!=r||(n+=" calendar-day-white");return n},e.getRecordings=function(){return p.recordings&&e.favorites&&e.selectedCameras?_.filter(p.recordings,function(t){return("all"==e.favorites.value||"only"==e.favorites.value&&t.currentState==l.FAVORITE_STATE||"non"==e.favorites.value&&t.currentState!=l.FAVORITE_STATE)&&_.findWhere(e.selectedCameras,{deviceId:t.deviceId})}):[]},e.toggleSelectMode=function(){if(e.$parent.selectMode=!e.$parent.selectMode,p.selectMode=e.$parent.selectMode,e.$parent.selectMode)f.gaSend("Library_Selection_web");else{for(var r=e.getRecordings(),n=0;n<r.length;n++)r[n].selected=!1;t.selectAllMode=!1}},e.isFiltered=function(){if(!e.favorites)return!1;if(d.selectedCameras){var t=s.getAvailableCameraIds().length;return e.favorites.value!=l.favoritesOptions[0].value||t!=d.selectedCameras.length}},e.isRecords=function(){return g.metadata&&g.metadata[c.stateParams.day]},e.prev=function(){if(!e.prevDisable){e.todayDisable=e.firstDisable=e.prevDisable=e.nextDisable=!0;var r=f.nextId();t.$broadcast("queueStatus",{id:r,type:"progress",text:"loading previous month"}),c.decrementMonth(),c.stateParams.month=c.month,c.stateParams.day="",v().then(function(){t.$broadcast("dequeueStatus",r)})}},e.next=function(){if(!e.nextDisable){if(e.todayDisable=e.firstDisable=e.prevDisable=e.nextDisable=!0,e.nextMonth)return;var r=f.nextId();t.$broadcast("queueStatus",{id:r,type:"info",text:"loading next month"}),c.incrementMonth(),c.stateParams.month=c.month,c.stateParams.day="",v().then(function(){t.$broadcast("dequeueStatus",r)})}},e.removeFilter=function(){c.stateParams.cameraIds="all",c.stateParams.favorites="all",c.gotoCalendarView()},e.first=function(){e.todayDisable=e.firstDisable=e.prevDisable=e.nextDisable=!0;var t=c.getFirst();t.then(function(){var e=c.getFirstRecordingsDay();c.month=c.stateParams.month=e.substring(0,6),c.stateParams.day=e,c.gotoCalendarView()})},e.today=function(){e.todayDisable=e.firstDisable=e.prevDisable=e.nextDisable=!0;var t=u.getToday();c.month=c.stateParams.month=t.substring(0,6),c.stateParams.day=t,c.gotoCalendarView()},e.getDayDisplay=function(e){return e?a("dayText")(e):"Please select date"},e.gotoDay=function(t){t.numLibraryRecordings>0&&(e.$parent.selectMode&&e.toggleSelectMode(),c.stateParams.day=e.getDay(t.dayOfMonth),c.gotoCalendarView())}}]).controller("DayCtrl",["$scope","$rootScope","$state","$stateParams","$modal","$log","appProperties","dayService","libraryService","calendarService","recordingsService","devicesService",function(e,t,r,n,i,a,o,s,c,d,l,u){var f;e.init=function(){a.debug("entering init of day controller"),d.stateParams=angular.copy(n),e.libraryMode=!0,s.day=d.stateParams.day,u.initDevices().then(function(){g()}),s.day==s.getToday()&&e.$on(o.appEvents.MEDIA_UPLOAD_NOTIFICATION,function(){s.refreshData()})};var g=function(){t.$broadcast("recycleModeDisable"),l.selectMode=!1,e.day=d.stateParams.day,c.setFavorites(n.favorites);var r=n.cameraIds.split(",")==o.CAMERAS_ALL_SELECTED?u.getAvailableCameraIds():n.cameraIds.split(",");if(c.setSelectedCamerasFromIds(r),e.favorites=c.favorites,e.favoritesOptions=o.favoritesOptions,e.month=d.month,0==r.length)e.selectedCameras=c.selectedCameras;else{var i=s.refreshData();i.then(function(){e.selectedCameras=c.selectedCameras,e.selectedRecordings=[];for(var t=l.recordings,r=0;r<t.length;r++)t[r].friendRecording=e.isFriendRecording(t[r])?!0:!1,e.selectedRecordings[r]=!1;f=!0})}};e.getRecordings=function(){return f&&l.recordings&&e.favorites&&e.selectedCameras?_.filter(l.recordings,function(t){return("all"==e.favorites.value||"only"==e.favorites.value&&t.currentState==o.FAVORITE_STATE||"non"==e.favorites.value&&t.currentState!=o.FAVORITE_STATE)&&_.findWhere(e.selectedCameras,{deviceId:t.deviceId})}):null},e.getSelectableRecordings=function(){var t=e.getRecordings();return _.filter(t,function(e){return 0==e.friendRecording})},e.getSelectedCount=function(){return _.reduce(l.recordings,function(e,t){return t.selected&&e++,e},0)},e.selectRecording=function(i){var a=l.recordings;e.$parent.selectMode?e.isFriendRecording(a[i])||(a[i].selected=!a[i].selected,e.getSelectableRecordings().length==e.getSelectedCount()&&(t.selectAllMode=!0),a[i].selected||(t.selectAllMode=!1)):r.go("recording",{recordingNumber:i,favorites:e.favorites.value,cameraIds:n.cameraIds})},e.canSelect=function(){return!u.isPureUser()},e.isVideo=function(e){return e.contentType==o.videoFormat},e.isFavorite=function(e){return e.currentState==o.FAVORITE_STATE},e.isFriendRecording=function(e){var t=_.findWhere(u.allDevices,{deviceId:e.deviceId});return!t||t.userRole==o.USER_ROLE_USER},e.isSelectMode=function(){return l.selectMode},e.showFilter=function(){i.open({templateUrl:"partials/calendarFilterView.html",controller:"CalendarFilterCtrl",backdrop:"static"})}}]).controller("SelectAllCtrl",["$scope","$rootScope","$state","$stateParams","$filter","$interval","appProperties","recordingsService","devicesService",function(e,t,r,n,i,a,o,s,c){e.getRecordings=function(){return s.recordings&&e.favorites&&e.selectedCameras?_.filter(s.recordings,function(t){return("all"==e.favorites.value||"only"==e.favorites.value&&t.currentState==o.FAVORITE_STATE||"non"==e.favorites.value&&t.currentState!=o.FAVORITE_STATE)&&_.findWhere(e.selectedCameras,{deviceId:t.deviceId})}):[]},e.getSelectableRecordings=function(){for(var t=e.getRecordings(),r=0;r<t.length;r++)t[r].friendRecording=e.isFriendRecording(t[r])?!0:!1;return _.filter(t,function(e){return 0==e.friendRecording})},e.toggleSelectAll=function(){if(e.getSelectableRecordings().length){t.selectAllMode=!t.selectAllMode;for(var r=e.getRecordings(),n=0;n<r.length;n++)e.isFriendRecording(r[n])||(r[n].selected=t.selectAllMode?!0:!1)}},e.isSelectMode=function(){return s.selectMode},e.isFriendRecording=function(e){var t=_.findWhere(c.allDevices,{deviceId:e.deviceId});return!t||t.userRole==o.USER_ROLE_USER}}]).controller("RecordingCtrl",["$scope","$rootScope","$state","$stateParams","$filter","$interval","appProperties","recordingsService","calendarService","libraryService","devicesService",function(e,t,r,n,i,a,o,s,c,d,l){e.init=function(){(!Modernizr.video||-1!=navigator.userAgent.toLowerCase().indexOf("mac")&&-1!=navigator.userAgent.toLowerCase().indexOf("firefox"))&&(e.oldBrowser=!0),e.recordload=!1,e.recordings=s.recordings,e.recordingNumber=n.recordingNumber,e.recording=s.recordings[e.recordingNumber],e.time=0,e.duration=0,e.timePercent=0,e.playbackRate=1,e.isIE10=null!=navigator.userAgent.match(/MSIE 10/),s.setCurrent(e.recording),e.recordingImageUrl=e.recording.presignedThumbnailUrl,l.initDevices().then(function(){var t=i("toBSTime")(e.recording.utcCreatedDate,e.recording.timeZone);e.videoDate=i("dayText")(i("date")(t,"yyyyMMdd")),e.isLoadingVideo=e.loaded=!1,e.recordingNext=s.getNextContent(e.recordingNumber,n),e.recordingPrev=s.getPreviousContent(e.recordingNumber,n),e.playing=!1,e.pause(),e.recordload=!0,e.screenfull=screenfull})},e.$on("recording-deleted",function(t,i){t.stopPropagation(),e.playing=!1,e.pause(),e.setVideoPosition(0),i[1]-i[0]>1?r.go("recording",{recordingNumber:i[1]-1,favorites:d.favorites.value,cameraIds:n.cameraIds}):e.init()}),e.getCameras=function(){return _.filter(l.allDevices,function(e){return e.deviceType==o.CAMERA_DEVICE_TYPE&&e.state==o.PROVISIONED_STATE||e.deviceType==o.CAMERA_DEVICE_TYPE&&e.mediaObjectCount})},e.setSliderPosition=function(t){if(e.playing){var r=document.getElementById("recordedVideo");r.duration?(e.time=t*r.duration/100,e.timePercent=t):(e.time=0,e.timePercent=0),e.setVideoPosition(t)}},e.getRecordingDuration=function(){return e.duration?i("secToString")(e.duration):"00:00:00"},e.sliderClick=function(t){if(e.playing&&e.duration>0){var r=t.offsetX;if(!t.hasOwnProperty("offsetX"))var n=t.target||t.srcElement,i=n.getBoundingClientRect(),r=t.clientX-i.left;var a=100*(r-5)/angular.element(t.currentTarget).prop("offsetWidth");e.setSliderPosition(a);var o=document.getElementById("recordedVideo");o.currentTime=a*o.duration/100}},e.setVideoPosition=function(t){if(e.duration>0){var r=document.getElementById("recordedVideo");r.currentTime=t*r.duration/100}},e.isVideo=function(){return e.recording.contentType==o.videoFormat},e.prevContent=function(){e.isVideo()&&e.playing&&e.pause();var t=s.getPreviousContent(e.recordingNumber,n);r.go("recording",{recordingNumber:t.recordingNumber})},e.play=function(){if(e.isIE10)return e.player||(e.player=$f("recordedVideo2",{src:"flowplayer/flowplayer.commercial-3.2.18.swf",wmode:"opaque",onFail:function(){$log.debug("Flash not installed.")}},{key:"#$47cc9f6a88604d203d3",debug:!1,log:{level:"error",filter:"*"},clip:{url:e.recording.presignedContentUrl.replace(/%/gi,"%25"),autoBuffering:!0,autoPlay:!0,bufferLength:1,metaData:!1},plugins:{controls:{volume:!1,mute:!1,tooltipTextColor:"#ffffff",callType:"default",sliderColor:"#d7d7d7",tooltipColor:"#000000",bufferGradient:"none",timeColor:"#333333",buttonColor:"#888888",backgroundColor:"#ffffff",buttonOverColor:"#888888",sliderBorder:"1px solid rgba(215, 215, 215, 1.0)",backgroundGradient:"none",buttonOffColor:"rgba(130,130,130,1)",timeBorder:"0px solid rgba(0, 0, 0, 0.3)",sliderGradient:"none",progressGradient:"none",borderRadius:"0",timeBgColor:"rgb(0, 0, 0, 0)",timeSeparator:" ",durationColor:"#333333",disabledWidgetColor:"#555555",autoHide:"never",progressColor:"#06a94e",bufferColor:"#d7d7d7",height:42,opacity:1}}})),e.player.play(),void(e.playing=e.loaded=!0);var t=document.getElementById("recordedVideo");if(!e.loaded){e.isLoadingVideo=e.loaded=!0,t.innerHTML="";var r=document.createElement("source");r.src=e.recording.presignedContentUrl,r.type="video/mp4",t.appendChild(r),t.load()}e.playbackRate=1,t.playbackRate=e.playbackRate,t.play(),e.playing=!0},e.pause=function(){if(e.isIE10)e.player.stop();else{var t=document.getElementById("recordedVideo");t.pause()}e.playing=!1},e.nextContent=function(){e.isVideo()&&e.playing&&e.pause();var t=s.getNextContent(e.recordingNumber,n);r.go("recording",{recordingNumber:t.recordingNumber})},e.gotoCalendarView=function(){l.initDevices().then(function(){c.gotoCalendarView()})},e.fullScreen=function(){var e=document.getElementById("recordedVideo");screenfull.enabled&&screenfull.request(e)}}]).controller("SharedRecordingCtrl",["$scope","$rootScope","$stateParams","$filter","$timeout","appProperties","recordingsService",function(e,t,r,n,i,a,o){function s(){e.playing=!1,e.time=0,e.duration=0,e.timePercent=0,e.playbackRate=1,e.isLoadingVideo=e.loaded=!1,e.isVideo(e.recording)||(e.recordingImageUrl=e.recording.presignedContentUrl)}e.init=function(){e.loading=!0,(!Modernizr.video||-1!=navigator.userAgent.toLowerCase().indexOf("mac")&&-1!=navigator.userAgent.toLowerCase().indexOf("firefox"))&&(e.oldBrowser=!0),e.token=r.token,o.getSharedRecordings(e.token).then(function(t){e.recordings=t.data,e.recording=t.data[0],s()},function(r){e.error=!0,t.$broadcast(a.appEvents.SHOW_ERROR,r)})["finally"](function(){e.loading=!1}),e.screenfull=screenfull,e.isIE10=null!=navigator.userAgent.match(/MSIE 10/)},e.setSliderPosition=function(t){if(e.playing){var r=document.getElementById("recordedVideo");r.duration?(e.time=t*r.duration/100,e.timePercent=t):(e.time=0,e.timePercent=0),e.setVideoPosition(t)}},e.getRecordingDuration=function(){return e.duration?n("secToString")(e.duration):"00:00:00"},e.sliderClick=function(t){if(e.playing&&e.duration>0){var r=t.offsetX;if(!t.hasOwnProperty("offsetX"))var n=t.target||t.srcElement,i=n.getBoundingClientRect(),r=t.clientX-i.left;var a=100*(r-5)/angular.element(t.currentTarget).prop("offsetWidth");e.setSliderPosition(a);var o=document.getElementById("recordedVideo");o.currentTime=a*o.duration/100}},e.setVideoPosition=function(t){if(e.duration>0){var r=document.getElementById("recordedVideo");r.currentTime=t*r.duration/100}},e.isVideo=function(e){return e&&-1!=e.presignedContentUrl.indexOf(".mp4?")},e.play=function(){if(e.isIE10)return e.player||(e.player=$f("recordedVideo2",{src:"flowplayer/flowplayer.commercial-3.2.18.swf",wmode:"opaque",onFail:function(){$log.debug("Flash not installed.")}},{key:"#$47cc9f6a88604d203d3",debug:!1,log:{level:"error",filter:"*"},clip:{url:e.recording.presignedContentUrl.replace(/%/gi,"%25"),autoBuffering:!0,autoPlay:!0,bufferLength:1,onStart:function(){e.$apply(function(){e.loaded=!0,e.isLoadingVideo=!1,e.playing=!0})},onResume:function(){e.$apply(function(){e.playing=!0})},onBeforePause:function(){e.$apply(function(){e.playing=!1})},onFinish:function(){e.$apply(function(){e.playing=!1})}},plugins:{controls:{volume:!1,mute:!1,tooltipTextColor:"#ffffff",callType:"default",sliderColor:"#d7d7d7",tooltipColor:"#000000",bufferGradient:"none",timeColor:"#333333",buttonColor:"#888888",backgroundColor:"#ffffff",buttonOverColor:"#888888",sliderBorder:"1px solid rgba(215, 215, 215, 1.0)",backgroundGradient:"none",buttonOffColor:"rgba(130,130,130,1)",timeBorder:"0px solid rgba(0, 0, 0, 0.3)",sliderGradient:"none",progressGradient:"none",borderRadius:"0",timeBgColor:"rgb(0, 0, 0, 0)",timeSeparator:" ",durationColor:"#333333",disabledWidgetColor:"#555555",autoHide:"never",progressColor:"#06a94e",bufferColor:"#d7d7d7",height:42,opacity:1}}})),e.playing=!1,e.isLoadingVideo=!0,void e.player.play();var t=document.getElementById("recordedVideo");if(!e.loaded){e.isLoadingVideo=e.loaded=!0,t.innerHTML="";var r=document.createElement("source");r.src=e.recording.presignedContentUrl,r.type="video/mp4",t.appendChild(r),t.load()}e.playbackRate=1,t.playbackRate=e.playbackRate,t.play(),e.playing=!0},e.pause=function(){if(e.isIE10)e.player.stop(),e.playing=!1;else{var t=document.getElementById("recordedVideo");t.pause()}e.playing=!1},e.selectRecording=function(t){t!=e.recording&&(e.playing?(e.pause(),e.recording=t,i(function(){s(),i(function(){e.play()})})):(e.recording=t,i(function(){s()})),e.player&&(e.player.unload(),e.player=null))},e.fullScreen=function(){var e=document.getElementById("recordedVideo");screenfull.enabled&&screenfull.request(e)},e.goHome=function(){location.href="/"},e.getZIndex=function(){return e.loaded?6:0}}]).controller("SettingsCtrl",["$scope","$rootScope","$state","$stateParams","appProperties","baseStationService","devicesService","cameraSettingsService","friendsService","userService","servicePlanService",function(e,t,r,n,i,a,o,s,c,d,l){e.init=function(){e.noServisePlan=!0,e.onLoad=!1;var t=o.initDevices();t.then(function(){l.getPurchasedPlans().then(function(){e.noServisePlan=!e.getServicePlan(),e.onLoad=!0},function(){}),c.getFriends(),_.each(o.getBaseStations(),function(e){!e.modes&&e.properties&&e.properties.connectionState==i.AVAILABLE_STATE&&a.getBaseStationResource(e.deviceId,"modes")})},function(){})},e.scrollTopPosition=function(e){t.settingsOffsetTopPosition=e,t.$broadcast("settingsScrollingOn",null)},e.getBaseStations=function(){return _.filter(o.getBaseStations(),e.isOwnerBS)},e.isOwnerBS=function(e){return e.userRole==i.USER_ROLE_OWNER},e.getCameras=function(){return o.devices?o.getAllCameras():[]},e.getServicePlan=function(){return l.getServicePlan()},e.gotoCamera=function(e){(!e.properties||e.properties.connectionState)&&e.properties&&"unavailable"!=e.properties.connectionState&&r.go("settings.camera",{deviceId:e.deviceId})},e.isOwnCamera=function(e){return e.userId===e.owner.ownerId},e.isNonOwner=function(){return!d.paymentId},e.canSetPreferences=function(){return o.hasOwnDevices()},e.hasOwnCameras=function(){return e.getCameras()?e.getCameras().length>0&&_.reduce(e.getCameras(),function(e,t){return e||t.userId===t.owner.ownerId},!1):!1},e.hasServicePlan=function(){return!e.noServisePlan},e.getFriendsCount=function(){return c.friends?"("+c.friends.length+")":""},e.alertBS=function(e){return e.properties&&e.properties.connectionState==i.AVAILABLE_STATE&&e.properties.updateAvailable?!0:!1},e.alertEmail=function(){return"true"!=d.validEmail},e.alertFriends=function(){return c.friends&&_.findWhere(c.friends,{status:"EXPIRED"})},e.alertCamera=function(e){return e.properties&&e.properties.connectionState==i.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL}}]).controller("CameraSettingsCtrl",["$scope","$rootScope","$state","$stateParams","$timeout","cameraSettingsService","camerasService","devicesService","baseStationService","appProperties",function(e,t,r,n,i,a,o,s,c,d){e.nameRegExp=/^[a-zA-Z0-9\s~!@#$%^&*()_+=,./<>?;:\-\\\|\[\]\{\"\'\}]+$/,e.init=function(){if(e.changed=!1,e.bestVideo=d.CAMERA_SETTINGS_POWERSAVEMODE_BEST_VIDEO,e.optimized=d.CAMERA_SETTINGS_POWERSAVEMODE_OPTIMIZED,e.batteryLife=d.CAMERA_SETTINGS_POWERSAVEMODE_BATTERY_LIFE,e.takingSnapshot=null,e.$on(d.appEvents.SNAPSHOT_LOADED,function(t,r){r.deviceId==n.deviceId&&(i.cancel(e.takingSnapshot),e.takingSnapshot=null,e.camera.presignedFullFrameSnapshotUrl=s.getCameraById(n.deviceId).presignedFullFrameSnapshotUrl)}),n.deviceId&&(e.camera=angular.copy(s.getCameraById(n.deviceId)),e.camera&&(e.initialCameraName=e.camera.deviceName,e.initialCameraFlip=e.camera.properties.flip,e.initialPowerSaveMode=e.camera.properties.powerSaveMode,e.initialCameraZoomX1=e.camera.properties.zoom.topleftx,e.initialCameraZoomX2=e.camera.properties.zoom.bottomrightx)),e.camera)e.camera.presignedFullFrameSnapshotUrl||e.takeSnapshot(),e.selectPowerSaveMode(e.camera.properties.powerSaveMode);else{s.initDevices()}e.$on(d._RESOURCE_UPDATE_,function(){if(!e.camera||!e.camera.properties||!e.camera.properties.powerSaveMode){var t=s.getCameraById(n.deviceId);t&&t.properties&&t.properties.powerSaveMode&&(e.camera=angular.copy(t),e.selectPowerSaveMode(e.camera.properties.powerSaveMode),e.camera.presignedFullFrameSnapshotUrl||e.takeSnapshot(),e.initialCameraName=e.camera.deviceName,e.initialCameraFlip=e.camera.properties.flip,e.initialPowerSaveMode=e.camera.properties.powerSaveMode,e.initialCameraZoomX1=e.camera.properties.zoom.topleftx,e.initialCameraZoomX2=e.camera.properties.zoom.bottomrightx)}})},e.isLoading=function(){var t=s.getDeviceById(n.deviceId);if(t&&t.properties&&t.properties.connectionState==d.UNAVAILABLE_STATE&&r.go("settings"),e.camera){var i=s.getBaseStationById(e.camera.parentId);i&&"unavailable"==i.properties.connectionState&&r.go("settings")}return!e.camera||!e.camera.properties||!e.camera.properties.powerSaveMode};e.$on(d.appEvents.CAMERA_ERROR,function(e,r){t.$broadcast(d.appEvents.SHOW_ERROR,{data:r})});e.$on(d.appEvents.TAKE_SNAPSHOT,function(t,r){r==n.deviceId&&e.takeSnapshot()}),e.takeSnapshot=function(){i.cancel(e.takingSnapshot),e.takingSnapshot=null,o.getFullFrameSnapshot(n.deviceId,!0).then(function(){e.takingSnapshot=i(function(){e.takingSnapshot=null},2e4)})},e.isCameraAvailable=function(){var t=s.getCameraById(n.deviceId);return!e.cameraNameForm.$invalid&&t&&t.properties&&t.properties.connectionState&&t.properties.connectionState!=d.UNAVAILABLE_STATE},e.isChanged=function(){return e.camera?e.changed=e.initialCameraName!=e.camera.deviceName||e.initialCameraFlip!=e.camera.properties.flip||e.initialPowerSaveMode!=e.camera.properties.powerSaveMode||e.initialCameraZoomX1!=e.camera.properties.zoom.topleftx||e.initialCameraZoomX2!=e.camera.properties.zoom.bottomrightx:void 0},e.positionMode=function(){var e=s.getCameraById(n.deviceId);return e&&e.properties&&e.properties.connectionState==d.UNAVAILABLE_STATE&&r.go("settings"),a.isPositionMode(n.deviceId)},e.motionDetectionMode=function(){return e.camera&&e.camera.properties[d.CAMERA_SETTINGS_ACTIVITYSTATE]===d.CAMERA_SETTINGS_ACTIVITYSTATE_MOTION_DETECTION_MODE},e.selectPowerSaveMode=function(t){e.camera.properties.powerSaveMode=t},e.isSelected=function(t){return e.camera&&t==e.camera.properties.powerSaveMode},e.done=function(){if(e.isChanged()){var t=s.getCameraById(n.deviceId);if(t&&t.deviceName!=e.camera.deviceName){var i=c.renameDevice(e.camera);i.then(function(){t.deviceName=e.camera.deviceName})}e.camera.properties.mirror=e.camera.properties.flip;var o=a.updateSettings(e.camera.parentId,e.camera.deviceId,_.pick(e.camera.properties,d.CAMERA_SETTINGS_BRIGHTNESS,d.CAMERA_SETTINGS_ZOOM,d.CAMERA_SETTINGS_MIRROR,d.CAMERA_SETTINGS_FLIP,d.CAMERA_SETTINGS_POWERSAVEMODE));o.then(function(){}),r.go("settings")}},e.toggleInvertMode=function(){e.camera&&(e.camera.properties.flip=!e.camera.properties.flip)},e.togglePositionMode=function(){e.isCameraBusy()||r.go("settings.positionMode",{deviceId:e.camera.deviceId})},e.toggleMotionDetectionMode=function(){return void(e.isCameraBusy()||r.go("settings.motionTest",{deviceId:e.camera.deviceId}))},e.isCameraBusy=function(){return!e.camera||!e.camera.properties||e.camera.properties.connectionState==d.CAMERA_CONNECTION_STATE_BATTERY_CRITICAL||e.camera.properties[d.CAMERA_SETTINGS_ACTIVITYSTATE]==d.CAMERA_ACTIVITYSTATE_START_ALERT_STREAM||e.camera.properties[d.CAMERA_SETTINGS_ACTIVITYSTATE]==d.CAMERA_ACTIVITYSTATE_ALERT_STREAM_ACTIVE||e.camera.properties[d.CAMERA_SETTINGS_ACTIVITYSTATE]==d.CAMERA_ACTIVITYSTATE_ALERT_WATCH||e.camera.properties[d.CAMERA_SETTINGS_ACTIVITYSTATE]==d.CAMERA_ACTIVITYSTATE_FULLFRAMESNAPSHOT},e.isCameraIdle=function(){return e.camera&&e.camera.properties&&e.camera.properties[d.CAMERA_SETTINGS_ACTIVITYSTATE]==d.CAMERA_SETTINGS_ACTIVITYSTATE_IDLE},e.getFW=function(){var e=s.getCameraById(n.deviceId);return e&&e.properties&&e.properties.swVersion||""},e.getHW=function(){var e=s.getCameraById(n.deviceId);return e&&e.properties&&e.properties.hwVersion||""}}]).controller("PersonalInfoCtrl",["$scope","$rootScope","$q","$modal","$state","appProperties","userService","loginService","uiService",function(e,t,r,n,i,a,o,s,c){e.init=function(){e.loading=!0,e.password="",e.oldUserId=o.userName,o.getProfile().then(function(){e.personalInfoForm.password.$setPristine(),e.userId=e.initialUserID=e.oldUserId,e.firstName=e.initialFirstName=o.firstName,e.lastName=e.initialLastName=o.lastName,e.validEmail="true"==o.validEmail,e.modifyUserId=!1,e.modifyPassword=!1,e.modifyName=!1,e.loading=!1})},e.done=function(){if(e.isChanged()&&!e.personalInfoForm.$invalid){e.modifyUserId=e.personalInfoForm.userId.$dirty&&e.userId!=e.oldUserId,e.modifyPassword=e.personalInfoForm.newPassword.$dirty,e.modifyName=e.personalInfoForm.firstName.$dirty||e.personalInfoForm.lastName.$dirty,e.loading=!0;var n,i,c;e.modifyUserId&&(n=o.updateUserId(e.userId,e.password),n.then(function(){o.userName=e.userId,o.settings&&o.setUserName(e.userId)})),e.modifyPassword&&(i=s.updatePassword(e.password,e.newPassword).then(function(){o.settings&&o.setSettings(e.newPassword)})),e.modifyName&&(e.initialLastName=e.lastName,e.initialFirstName=e.firstName,e.personalInfoForm.firstName.$setPristine(),e.personalInfoForm.lastName.$setPristine(),c=o.updateName(e.firstName,e.lastName),c.then(function(){o.firstName=e.firstName,o.lastName=e.lastName})),r.all([n,i,c]).then(function(){e.loading=!1},function(r){e.loading=!1,t.$broadcast(a.appEvents.SHOW_ERROR,r)})}},e.isChanged=function(){return e.initialLastName!=e.lastName||e.initialFirstName!=e.firstName||e.initialUserID!=e.userId||e.personalInfoForm.password.$dirty&&e.personalInfoForm.password.$valid&&e.personalInfoForm.newPassword.$dirty&&e.personalInfoForm.newPassword.$valid&&e.personalInfoForm.confirmPassword.$dirty&&e.personalInfoForm.confirmPassword.$valid},e.confirmEmail=function(){e.confirmMessage="Send",e.message="Send email confirmation to "+o.userName+"?";var r=n.open({templateUrl:"partials/confirmDialog.html",controller:"ConfirmCtrl",scope:e,backdrop:!0});r.result.then(function(){o.confirmEmail().then(function(){c.info("A link to confirm your email address has been emailed to you.")},function(e){t.$broadcast(a.appEvents.SHOW_ERROR,e)})})}}]).controller("ClaimBaseStationCtrl",["$scope","$rootScope","$state","$log","$modal","setupService","devicesService","jsonService","servicePlanService","appProperties","userService",function(e,t,r,n,i,a,o,s,c,d,l){e.hasPaymentId=!1,e.init=function(){l.isLoggedIn()||(a.setupPending=!0),e.setupPending=a.setupPending;
var r=o.queryPresentDevices();r.then(function(){e.hasPaymentId=!l.paymentId,e.devices=o.presentDevices,e.devices&&e.devices.length>0&&(e.device=e.devices[0].hardwareId)},function(e){e&&t.$broadcast(d.appEvents.SHOW_ERROR,e)}),a.setupPending||c.getPurchasedPlans(),s.timeZones().then(function(t){e.timeZones=t.data;var r=new Date,n=new Date(r.getFullYear(),0,1).getTimezoneOffset(),i=new Date(r.getFullYear(),6,1).getTimezoneOffset(),a=Math.max(n,i),o=_.findWhere(d.timeZoneHash,{offset:a.toString()});e.timeZone=o?_.findWhere(e.timeZones,{id:o.id}):e.timeZones[0]})},e.cancel=function(){r.go(a.setupPending?"login":c.getServicePlan()?"settings.subscription":"settings")},e["continue"]=function(){var n=_.findWhere(e.devices,{hardwareId:e.device});if(a.isSetup||!a.setupPending)e.claimInProgress=!0,o.claimDevice(n._id,n.hardwareId,e.timeZone).then(function(){e.claimInProgress=!1,c.getServicePlan()?(o.getDevices(),r.go("settings.subscription")):(a.setupPending=!0,r.go("servicePlan"))},function(r){e.claimInProgress=!1,t.$broadcast(d.appEvents.SHOW_ERROR,r||"Error occurred.")});else{if(a.accountRegistered)throw"Unknown system setup state";a.selectedBaseStation=n,a.timeZone=angular.copy(e.timeZone),r.go("accountRegistration")}}}]).controller("AccountRegistrationCtrl",["$scope","$rootScope","$state","$q","$modal","$stateParams","$filter","$location","appProperties","setupService","devicesService","jsonService","urlService","userService","servicePlanService","pushHandlerService","localStorage","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,m,v,h){e.init=function(){if(d.accountRegistered||d.isSetup)return void r.go("cameras");var n=u.secretQuestions();n.then(function(t){e.secretQuestions=t.data,e.secretQuestion=e.secretQuestions[0],e.accountRegistrationForm.accountRegistration_secretQuestion.$setViewValue("")},function(e){e&&t.$broadcast(c.appEvents.SHOW_ERROR,e)})},e.displayTos=function(){e.viewMode=!1,i.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:f.getTermsUrl(),scope:e,backdrop:"static"}).result.then(function(t){e.agreeTos="ok"==t})},e.displayPrivacy=function(){i.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:f.getPolicyUrl(),scope:e,backdrop:"static"}).result.then(function(t){e.agreePrivacy="ok"==t})},e["continue"]=function(){if(!e.agreeTos)return e.agreeTosError=!0,!1;if(!e.agreePrivacy)return e.agreePrivacyError=!0,!1;e.loading=!0;var t={email:e.userId,password:e.password,firstName:e.firstName,lastName:e.lastName,secretQuestion:e.secretQuestion==e.secretQuestions[e.secretQuestions.length-1]?e.ownSecretQuestion:e.secretQuestion,secretAnswer:e.secretAnswer,phone:e.phone,agreeTos:e.agreeTos,agreePrivacyPolicy:e.agreePrivacy};d.timeZone&&(t.timeZone=d.timeZone);var i=g.register(t);i.then(function(){g.registerUserError||d.updateSetupState()},function(t){return e.loading=!1,e.registerError=t&&t.data?t.data.message:t,e.accountRegistrationForm.$setPristine(),n.reject(t)}).then(function(){if(d.updateSetupState(),v.setItem("isSetup","true"),d.isSetup){var e=l.getDevices();e.then(function(){m.init(),r.go("cameras")})}else r.go("servicePlan")})},e.checkEmail=function(){e.accountRegistrationForm.userId.$invalid||e.checkingEmailInner||(e.checkingEmail=e.checkingEmailInner=!0,e.pwdError=0,g.checkEmailUsage(e.userId).then(function(t){if(t.data.used&&t.data.arlo){e.confirmMessage=o("i18n")("activity_go_to_login"),e.message=o("i18n")("status_account_exist");var n=i.open({templateUrl:"partials/confirmDialog.html",controller:"ConfirmCtrl",scope:e,backdrop:!0});return e.checkingEmail=!1,void n.result.then(function(){r.go("login")})["finally"](function(){e.userId="",e.checkingEmailInner=!1})}e.ssoAccount=t.data.used&&!t.data.arlo,e.ssoAccount&&e.password?(e.pwdError=0,g.checkAccountUsage(e.userId,e.password).then(function(t){t.data&&t.data.firstName&&(e.firstName=t.data.firstName),t.data&&t.data.lastName&&(e.lastName=t.data.lastName)},function(t){e.pwdError=t.data.message})["finally"](function(){e.checkingEmail=e.checkingEmailInner=!1})):e.ssoAccount?(e.checkingEmail=!1,h.info(o("i18n")("error_username_exists"))["finally"](function(){e.checkingEmailInner=!1})):e.checkingEmail=e.checkingEmailInner=!1}))},e.goBack=function(){var e=s.absUrl(),t=e.toLowerCase().indexOf(c.registerTokenText);r.go(0>t?"claimBaseStation":"login")}}]).controller("SelectServicePlanCtrl",["$scope","$rootScope","$modal","$state","setupService","servicePlanService","billingFlowService","devicesService","appProperties",function(e,t,r,n,i,a,o,s,c){e.init=function(){o.pendingPlan=null,e.setupPending=i.setupPending,e.loadingMessage="Loading service plans...",e.loading=!0,e.servicePlanSelected=i.servicePlanSelected;var r=a.getOffersV1();r.then(function(r){e.$on("plan_selected",function(t,r){e.select(r)}),t.$broadcast("offers",r.data),e.loading=!1},function(r){t.$broadcast(c.appEvents.SHOW_ERROR,r),e.loading=!1})},e.select=function(t){return"paid"!=t.planType.toLowerCase()?void n.go("syncHardware"):(i.servicePlanSelected=!0,e.loadingMessage="",o.pendingPlan={setupPlan:t},void n.go("billingInformation"))},e.isBillingInProgress=function(){return o.inProgress}}]).controller("BillingInformationCtrl",["$scope","$rootScope","$state","$log","$filter","$timeout","appProperties","jsonService","setupService","servicePlanService","urlService","userService","billingFlowService","calendarNamesService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g){function p(){if(e.billingInfo=angular.copy(d.billingInfo.billing),d.billingInfo.creditCard.cardNumber){var t=d.billingInfo.creditCard;e.creditCard.cardNumber="************"+t.cardNumber,e.creditCard.expirationMonth=t.expirationMonth,e.creditCard.expirationYear=t.expirationYear,e.creditCard.cvv="***"}e.autoRenew=d.billingInfo.autoRenew,e.vatNumber=d.billingInfo.vatNumber,delete e.billingInfo.vatNumber,d.billingInfo.creditCard.cardNumber||(e.showRenew=!0),m()}function m(){s.countryCodes().then(function(t){e.countries=t.data,e.country=_.findWhere(e.countries,{code:u.countryCode||"US"}),e.isStates=!!e.country&&e.country.states,e.isStates&&s.stateCodes(e.country.statesName).then(function(t){e.countryStates=t.data,d.billingInfo&&(e.state=_.findWhere(e.countryStates,{code:d.billingInfo&&d.billingInfo.billing.state}))}),e.setVatPattern()})}function v(t){var r=t.data;if(r.hasOwnProperty("formReLoaded")){if(n.debug("Form of payment response reloaded"),r.params)if("0"==r.params.errors)n.debug("Setting formOfPaymentResponse"),e.formOfPaymentResponse=r.params;else{var a=h(r.params);if(a.length>=1){var o=parseInt(a[0]);e.errorMessage=i("i18n")("aria_directpost_error_"+o)}else e.errorMessage=i("i18n")("card_error");e.formOfPaymentResponse={error:!0}}else n.debug("Form of payment returned no params in message");e.$apply()}}function h(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&r.indexOf("error_code")>-1&&t.push(e[r]);return t}function S(){e.loading=!1,e.errorMessage=i("i18n")("billing_timeout_error")}e.init=function(){if(!Modernizr.postmessage)return void r.go("oldBrowser");e.setupPending=c.setupPending,window.addEventListener("message",v),e.vatNumber="";var n=(new Date).getFullYear();if(e.months=g.getCalendar().MONTH.slice(0),e.months.splice(0,0,"Month"),e.years=_.map(_.range(n,n+9),function(e){return e.toString()}),e.creditCard={expirationYear:e.years[0],expirationMonth:"0"},d.billingInfo&&!e.setupPending)p();else if(e.setupPending)e.billingInfo={firstName:"",lastName:"",companyName:"",address1:"",address2:"",city:"",state:"",postalCode:"",countryCode:""},e.autoRenew=!0,m();else{var i=d.getBilling();i.then(function(){p()},function(e){t.$broadcast(o.appEvents.SHOW_ERROR,e)})}e.isIE=navigator.userAgent.indexOf("Trident")>-1||null!=navigator.userAgent.match(/MSIE [6789]/)},e.vatRequired=function(){return e.country&&e.country.vat},e.zipPattern=function(){var t=e;return{test:function(e){return t.country&&("US"==t.country.code||"GB"==t.country.code)&&t.country.zip?new RegExp(t.country.zip).test(e):!0}}}(),e.setVatPattern=function(){e.country?e.vatRegExp=new RegExp(e.country.vat):e.billingInfo&&e.billingInfo.country&&(e.vatRegExp=new RegExp(e.billingInfo.country.vat))},e.getCountry=function(){return e.country?e.country.name:u.countryCode},e.vatChange=function(){e.vatError="",e.billingInformationForm.vatNumber.$setValidity("invalidvat",!0)},e["continue"]=function(){e.loading=!0,e.errorMessage=!1,e.billingInfo.countryCode=u.countryCode,e.isStates&&(e.billingInfo.state=e.state.code);var n={billing:e.billingInfo,autoRenew:e.autoRenew,vatNumber:e.vatNumber};e.billingError="",e.vatError="",d.modifyBilling(n).then(function(n){e.loading=!1;var i=n.data.data,s=document.getElementById("formOfPayment").contentWindow;if(e.cardInformationForm.$dirty){var d={sessionId:i.sessionId,clientNo:i.client_no,cardNumber:e.creditCard.cardNumber,expirationMonth:e.creditCard.expirationMonth,expirationYear:e.creditCard.expirationYear,cvv:e.creditCard.cvv,url:i.url};e.timeoutId&&a.cancel(e.timeoutId),e.isIE&&(e.timeoutId=a(S,8e4)),e.$watch("formOfPaymentResponse",function(){e.formOfPaymentResponse&&(e.loading=!1,e.formOfPaymentResponse.error?document.getElementById("formOfPayment").src=document.getElementById("formOfPayment").src:c.setupPending?f.pendingPlan&&f.processBillingEvent(f.pendingPlan.setupPlan?f.pendingPlan:{toPlanId:f.pendingPlan.toPlans}).then(function(){a.cancel(e.timeoutId),f.selectServicePending=!1,r.go("syncHardware")},function(t){a.cancel(e.timeoutId),t&&(e.errorMessage=angular.isString(t)?t:t.data.message)}):f.selectServicePending?f.processBillingEvent({toPlanId:f.pendingPlan.toPlans}).then(function(){a.cancel(e.timeoutId),f.selectServicePending=!1,r.go("settings.subscription")},function(n){a.cancel(e.timeoutId),f.selectServicePending=!1,angular.isString(n)&&t.$broadcast(o.appEvents.SHOW_ERROR,{data:{message:n}}),r.go("settings.plans")}):(a.cancel(e.timeoutId),r.go("settings.subscription")),e.formOfPaymentResponse=null)},!0),e.loading=!0,s.postMessage(d,l.staticAssetsUrl),e.cardInformationForm.$setPristine()}else c.setupPending?f.pendingPlan&&f.processBillingEvent(f.pendingPlan.setupPlan?f.pendingPlan:{toPlanId:f.pendingPlan.toPlans}).then(function(){f.selectServicePending=!1,r.go("syncHardware")},function(t){t&&(e.errorMessage=angular.isString(t)?t:t.data.message)}):r.go("settings.subscription");e.billingInformationForm.$setPristine()},function(r){e.loading=!1,r.data?8016==r.data.error?(e.vatError=r.data.message,e.billingInformationForm.vatNumber.$setValidity("invalidvat",!1)):e.billingError=r.data.message:t.$broadcast(o.appEvents.SHOW_ERROR,{data:{message:"Unknown error in modify billing occurred"}})})},e.isBillingInProgress=function(){return f.inProgress}}]).controller("ConfirmCtrl",["$scope","$modalInstance",function(e,t){e.confirmButton=e.confirmMessage,e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}]).controller("SyncHardwareCtrl",["$scope","$state","setupService","devicesService","calendarService","dayService","pushHandlerService","libraryService",function(e,t,r,n,i,a,o,s){e.init=function(){},e["continue"]=function(){r.setupPending&&(o.init(),r.setupPending=!1),r.hardwareSynced=!0,r.updateSetupState();var e=n.initDevices();e.then(function(){i.setDefaultMonth(),a.setDefaultDay(i.month),s.initialize(),t.go("cameras")})}}]).controller("FriendsCtrl",["$scope","$state","$q","friendsService","devicesService","servicePlanService",function(e,t,r,n,i,a){e.loading=!0,e.init=function(){var t=[i.initDevices(),n.getFriends(),a.getPurchasedPlans()];r.all(t).then(function(){e.friends=n.friends,e.maxAccounts=a.getServicePlan().maxAccounts;var t=a.getServicePlan();e.isBasic=t&&-1!=t.sharingExpiry&&null!=t.sharingExpiry,e.expired=!a.getServicePlan().sharing})["finally"](function(){e.loading=!1})},e.add=function(){t.go("settings.addFriend")},e.isDevices=function(){return i.devices&&i.devices.length>0&&e.maxAccounts&&(-1==e.maxAccounts||e.maxAccounts>e.friends.length)}}]).controller("EditFriendCtrl",["$scope","$state","$stateParams","$modal","$filter","appProperties","devicesService","friendsService","servicePlanService","uiService",function(e,t,r,n,i,a,o,s,c,d){function l(e,t){e.message="Are you sure you want to delete friend?",e.confirmButton=i("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.init=function(){if(e.noCameras=!1,r.email){if(e.friend=angular.copy(_.findWhere(s.friends,{email:r.email})),!e.friend)return void t.go("settings.friends");e.oldEmail=e.friend.email,e.editMode=!0}else e.friend={adminUser:!1},e.editMode=!1;o.initDevices().then(function(){e.cameras=o.getOwnCameras(),e.noCameras=e.oldEmail?!1:!e.cameras.length,e.selection={},e.selection.ids={},_.each(e.cameras,function(t){var r=_.findWhere(e.friend.devices,{deviceId:t.deviceId});e.selection.ids[t.deviceId]="undefined"!=typeof r}),e.editMode&&(e.initialFirstName=e.friend.firstName,e.initialLastName=e.friend.lastName,e.initialEmail=e.friend.email,e.initialSelectionIds=angular.copy(e.selection.ids),e.initialAdminUser=e.friend.adminUser)});var n=c.getServicePlan();n?e.isBasic=-1!=n.sharingExpiry&&null!=n.sharingExpiry:c.getPurchasedPlans().then(function(){var t=c.getServicePlan();e.isBasic=t&&-1!=t.sharingExpiry&&null!=t.sharingExpiry})},e.isChanged=function(){return e.editMode?angular.equals(e.initialSelectionIds,e.selection.ids)&&e.initialAdminUser==e.friend.adminUser&&e.initialFirstName==e.friend.firstName&&e.initialLastName==e.friend.lastName&&e.initialEmail==e.friend.email?void 0:e.deviceSelected():!0},e.noCamerasAlert=function(){e.infoMessage="You should select at least one camera.";var t=n.open({templateUrl:"partials/infoDialog.html",scope:e,backdrop:!0,resolve:{}});t.result},e.emailUnique=function(t){e.editFriendForm.firstName.$setViewValue(e.editFriendForm.firstName.$viewValue),e.editFriendForm.lastName.$setViewValue(e.editFriendForm.lastName.$viewValue);var r=_.findWhere(s.friends,{email:t});return e.editFriendForm.email.$error.email||!e.editMode&&r||e.editMode&&r&&r.email!=e.oldEmail?e.editFriendForm.email.$setValidity("unique",!1):e.editFriendForm.email.$setValidity("unique",!0)},e.done=function(r){if(r||e.isChanged()&&!e.editFriendForm.$invalid){e.loading=!0,e.friend.devices={},_.each(e.selection.ids,function(t,r){e.selection.ids[r]&&(e.friend.devices[r]=o.getDeviceById(r).deviceName)});var n;if(e.editMode){var a=angular.copy(e.friend);delete a.createdDate,delete a.status,n=r?s.addFriend(a)["finally"](function(){e.loading=!1}):s.editFriend(a)["finally"](function(){e.loading=!1})}else n=s.addFriend(e.friend)["finally"](function(){e.loading=!1,e.isBasic&&d.info(i("i18n")("marketing_label_warning_basic_friend_usage"))});n.then(function(){t.go("settings.friends")})}},e.deviceSelected=function(){return e.selection&&_.some(e.selection.ids,function(e){return e})},e.deleteFriend=function(){var r=n.open({templateUrl:"partials/confirmDialog.html",controller:l,scope:e,backdrop:!0,resolve:{}});r.result.then(function(){var r=s.deleteFriend(e.friend);r.then(function(){t.go("settings.friends")})})},l.$inject=["$scope","$modalInstance"],e.toggleCamera=function(t){e.selection.ids[t.deviceId]=!e.selection.ids[t.deviceId]},e.toggleAdminUser=function(){e.friend.adminUser=!e.friend.adminUser}}]).controller("ModesCtrl",["$scope","$state","$stateParams","scheduleValidationService","devicesService","baseStationService","appProperties","servicePlanService",function(e,t,r,n,i,a,o,s){e.init=function(){e.deviceId=decodeURIComponent(r.deviceId),i.initDevices().then(function(){var r=i.getBaseStationById(e.deviceId);r||t.go("settings"),r.modes||a.getBaseStationResource(e.deviceId,"modes")}),e.predicate="name"},e.isLoading=function(){var t=i.getBaseStationById(e.deviceId);return!t||!t.hasOwnProperty("modes")},e.getModes=function(){var r=i.getBaseStationById(e.deviceId);return r&&"unavailable"==r.properties.connectionState&&t.go("settings.baseStation",{baseStationId:r.deviceId}),r&&r.modes?r.modes:[]},e.getDeviceName=function(){var t=i.getBaseStationById(e.deviceId);return t?t.deviceName:""},e.canAddMode=function(){var t=s.getServicePlan(),r=t&&t.maxSmartHomeModes?t.maxSmartHomeModes:0;if(-1==r)return!0;var n=e.baseStation&&e.baseStation.modes?e.baseStation.modes.length:0;return r>n},e.add=function(){t.go("settings.addMode",{deviceId:e.deviceId})}}]).controller("EditModeCtrl",["$scope","$rootScope","$state","$stateParams","$modal","$filter","appProperties","schedulingService","scheduleValidationService","baseStationService","devicesService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u){function f(e,t){e.message="Are you sure you want to delete mode?",e.confirmButton=a("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}var g;e.nameRegExp=/^[a-zA-Z0-9\s~!@#$%^&*()_+=,./<>?;:\-\\\|\[\]\{\"\'\}]+$/,e.init=function(){e.rulesSelected=!1,e.changed=!1,e.baseStationId=decodeURIComponent(n.deviceId),n.modeId&&(g=decodeURIComponent(n.modeId),e.editMode=!0),l.initDevices().then(function(){var t=l.getBaseStationById(e.baseStationId);t||r.go("settings"),t.rules||(e.initialMode=angular.copy(e.getMode()),d.getBaseStationResource(e.baseStationId,"rules")),t.modes||d.getBaseStationResource(e.baseStationId,"modes"),g||(e.newMode=d.createDefaultMode()),e.initialMode=angular.copy(e.getMode())})},e.isLoading=function(){var t=l.getBaseStationById(e.baseStationId);return!t||!e.getMode()||!t.hasOwnProperty("rules")},e.getMode=function(){if(e.newMode)return e.newMode;if(e.mode)return e.initialMode||(e.initialMode=angular.copy(e.mode)),e.mode;var t=l.getBaseStationById(e.baseStationId);return t&&t.modes?(e.mode=angular.copy(_.findWhere(t.modes,{id:g})),e.mode):null},e.getRules=function(){var t=l.getBaseStationById(e.baseStationId),r=e.getMode();return t&&t.rules&&r?_.filter(t.rules,function(e){return _.contains(r.rules,e.id)}):[]},e.getAvailableRules=function(){var t=e.getMode(),n=l.getBaseStationById(e.baseStationId);n&&"unavailable"==n.properties.connectionState&&r.go("settings.baseStation",{baseStationId:n.deviceId});var i=t&&n&&n.rules?n.rules:[];return e.isLoading()?void 0:i},e.isRuleSelected=function(t){var r=e.getMode();return r?_.contains(r.rules,t.id):!1},e.isModeValid=function(t){if(e.isLoading())return!1;var t=e.getMode(),r=l.getBaseStationById(e.baseStationId);return _.findWhere(r.modes,{name:t.name.trim()})?t?c.validateMode(e.baseStationId,t):!1:t},e.deviceName=function(e){return l.getDeviceName(e)},e.deleteRule=function(t){e.getMode().rules=_.without(e.getMode().rules,t)},e.isChanged=function(){var t=l.getBaseStationById(e.baseStationId);return t&&e.getMode()&&(e.changed=e.initialMode.name!=e.getMode().name.trim()||!e.editMode&&e.getMode().name==a("i18n")("add_mode_label_title_new")||e.rulesSelected),e.changed},e.toggleSelectRule=function(t){if(e.isRuleSelected(t))e.deleteRule(t.id);else{p(t);var r=e.getMode();r.rules.push(t.id)}e.rulesSelected=!angular.equals(e.getMode().rules.sort(function(e,t){return e>t?1:-1}),e.initialMode.rules.sort(function(e,t){return e>t?1:-1}))};var p=function(t){var r=_.find(t.actions,function(e){return e.deviceId}).deviceId,n=e.getMode(),i=l.getBaseStationById(e.baseStationId);_.each(n.rules,function(n){var a=_.findWhere(i.rules,{id:n});a&&t.triggers[0].deviceId==a.triggers[0].deviceId&&_.findWhere(a.actions,{deviceId:r})&&e.deleteRule(a.id)})};e.selectRule=function(){if(e.newRuleId){var t=e.getMode();t.rules.push(e.newRuleId),e.newRuleId=""}},e.addRule=function(){r.go("settings.addModeRule",{baseStationId:e.baseStationId,modeId:g})},e.deleteMode=function(){var n=l.getBaseStationById(e.baseStationId);if(n.activeMode.id==g)return void u.info("Active mode could not be deleted");var a=i.open({templateUrl:"partials/confirmDialog.html",controller:f,scope:e,backdrop:!0,resolve:{}});a.result.then(function(){var i=d.deleteMode(e.baseStationId,g);i.then(null,function(e){t.$broadcast(o.appEvents.SHOW_ERROR,e?{data:e}:{data:{message:"Server returned null on delete mode request."}})}),n.modes=_.reject(n.modes,function(e){return e.id===g}),delete n.schedule,r.go("settings.modes",{deviceId:e.baseStationId})})},f.$inject=["$scope","$modalInstance"],e.done=function(){e.isChanged()&&(e.getMode().name=e.getMode().name.trim(),g?(d.setMode(e.baseStationId,e.getMode()),r.go("settings.modes",{deviceId:e.baseStationId})):(d.addMode(e.baseStationId,e.getMode()),r.go("settings.modes",{deviceId:e.baseStationId})))},e.isRuleAction=function(e,t){switch(t){case"email":return _.findWhere(e.actions,{type:"sendEmailAlert"});case"record":return _.findWhere(e.actions,{type:"recordVideo"})}}}]).controller("RulesCtrl",["$scope","$state","$stateParams","baseStationService","devicesService",function(e,t,r,n,i){e.init=function(){e.deviceId=decodeURIComponent(r.deviceId),i.initDevices().then(function(){var r=i.getBaseStationById(e.deviceId);return r?void n.getBaseStationResource(e.deviceId,"rules"):(t.go("settings"),!0)})},e.isLoading=function(){var t=i.getBaseStationById(e.deviceId);return!t||!t.hasOwnProperty("rules")},e.getRules=function(){var r=i.getBaseStationById(e.deviceId);return r&&"unavailable"==r.properties.connectionState&&t.go("settings.baseStation",{baseStationId:r.deviceId}),r&&r.rules?r.rules:[]},e.getDeviceName=function(){var t=i.getBaseStationById(e.deviceId);return t?t.deviceName:""}}]).controller("EditRuleCtrl",["$scope","$stateParams","$state","$modal","$log","$timeout","$filter","appProperties","userService","baseStationService","devicesService","scheduleValidationService","camerasService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){function g(e,t){e.message="Are you sure you want to delete rule?",e.confirmButton=o("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}var p,m,v,h;e.nameRegExp=/^[a-zA-Z0-9\s~!@#$%^&*()_+=,./<>?;:\-\\\|\[\]\{\"\'\}]+$/,e.getCName=function(e){return e.replace(/ /g,String.fromCharCode(160))},e.goBack=function(){return e.isEditAlerts?void(e.isEditAlerts=!1):void(v?r.go("settings.editMode",{deviceId:p,modeId:v}):r.go("settings.rules",{deviceId:p}))},e.isLoading=function(){var t=l.getBaseStationById(p);return!t||!e.getRule()},e.getOwnerEmail=function(){return c.userName},e.getRule=function(){if(e.newRule)return e.newRule;if(e.rule)return e.rule;var t=l.getBaseStationById(p);if(t&&t.rules){e.rule=angular.copy(_.findWhere(t.rules,{id:h})),e.rule.name.length>32&&(e.rule.name=e.rule.name.substring(0,32)),e.rule&&e.rule.actions[0]&&(!e.rule.actions[0].stopCondition||e.rule.actions[0].stopCondition.motionDetectionZone)&&(e.rule.actions[0].stopCondition={type:"timeout",timeout:10}),e.initialRule=angular.copy(e.rule);var r=_.find(e.rule.actions,function(e){return"sendEmailAlert"===e.type});return e.allAlertEmails=u.getAllEmails(),e.initialAlertEmails=[],r&&r.recipients&&(e.initialAlertEmails=angular.copy(r.recipients)),e.rule}return null},e.getCameras=function(){var e=_.filter(d.getAllCamerasOfBaseStation(p),function(e){return"provisioned"===e.state});return e||[]},e.init=function(){e.takingSnapshot=null,e.changed=!1,p=decodeURIComponent(t.baseStationId),t.ruleId&&(h=t.ruleId),l.initDevices().then(function(){m=l.getBaseStationById(p),m||r.go("settings"),m.rules||d.getBaseStationResource(p,"rules")}),e.actions=[{type:"recordVideo",description:"Record Video"}],h?e.editMode=!0:(e.newRule=d.createDefaultRule(),e.initialRule=angular.copy(d.createDefaultRule())),t.modeId&&(v=t.modeId)},e.isChanged=function(){return e.newRule&&!e.isLoading()?e.changed=e.isEditAlerts?e.changedAlertEmails.length||e.newAddedEmails:e.newAddedEmails||e.initialRule.name!=e.newRule.name.trim()||e.initialRule.triggers[0].deviceId!=e.newRule.triggers[0].deviceId||e.initialRule.triggers[0].sensitivity!=e.newRule.triggers[0].sensitivity||e.initialRule.actions[0].deviceId!=e.newRule.actions[0].deviceId||e.initialRule.actions[0].stopCondition.timeout!=e.newRule.actions[0].stopCondition.timeout:e.isLoading()?void 0:e.changed=e.isEditAlerts?e.changedAlertEmails.length||e.newAddedEmails:e.editAlertsUpdated||e.initialRule.name!=e.rule.name||e.initialRule.triggers[0].deviceId!=e.rule.triggers[0].deviceId||e.initialRule.triggers[0].sensitivity!=e.rule.triggers[0].sensitivity||e.initialRule.actions[0].deviceId!=e.rule.actions[0].deviceId||e.initialRule.actions[0].stopCondition.timeout!=e.rule.actions[0].stopCondition.timeout};e.isRuleValid=function(){var t=e.getRule(),n=l.getBaseStationById(p);return n&&"unavailable"==n.properties.connectionState&&r.go("settings.baseStation",{baseStationId:n.deviceId}),t&&n?u.validateRule(n.deviceId,t):!1},e.triggerChanged=function(t){t&&!e.getRule().actions[0].deviceId&&(e.getRule().actions[0].deviceId=t,e.deviceChanged(t))},e.deviceChanged=function(){},e.getDetector=function(t){if(!e.getRule()||!e.getRule().actions||!e.getRule().actions.length)return"";var t=e.getRule().actions[0].deviceId,r=l.getDeviceById(t);return r&&r.properties?r.properties.presignedSnapshotUrl:""},e.detectorSensitivity=function(e){var t=Math.floor(e/100*100);return isNaN(t)?50:t},e.cameraName=function(e){return l.getDeviceName(e)},e.done=function(){e.isEditAlerts&&!e.newRule&&(e.editAlertsUpdated=!angular.equals(e.alertEmails.sort(function(e,t){return e>t?1:-1}),e.initialAlertEmails.sort(function(e,t){return e>t?1:-1}))),e.changed&&(e.isEditAlerts?e.doneAlerts():e.doneRule())},e.doneRule=function(){if(u.fixRule(e.getRule()),"recordVideo"==e.getRule().actions[0].type?e.getRule().actions[0].stopCondition.deviceId=e.getRule().actions[0].deviceId:delete e.getRule().actions[0].stopCondition,h){{_.find(e.getRule().actions,function(e){return"sendEmailAlert"===e.type})}d.setRule(p,e.getRule())}else d.addRule(p,e.getRule());e.goBack()},e.editAlerts=function(){var t=e.alertsForm.newEmail;t.$setViewValue(""),t.$setPristine(),t.$render(),e.$watch(function(){return t.$viewValue.length},function(){t.$viewValue.length||(t.$setViewValue(""),t.$setPristine())});var r=_.find(e.getRule().actions,function(e){return"sendEmailAlert"===e.type});e.alertEmails=[],r&&r.recipients&&(e.alertEmails=angular.copy(r.recipients)),e.newAddedEmails=0,e.changedAlertEmails=[],e.allAlertEmails=u.getAllEmails(),e.isEditAlerts=!0},e.deleteRule=function(){var t=n.open({templateUrl:"partials/confirmDialog.html",controller:g,scope:e,backdrop:!0,resolve:{}});t.result.then(function(){h&&(d.deleteRule(p,h),m.rules=_.reject(m.rules,function(e){return e.id===h}),delete m.modes),e.goBack()})},g.$inject=["$scope","$modalInstance"],e.select=function(t){_.contains(e.alertEmails,t)?e.alertEmails=_.without(e.alertEmails,t):e.alertEmails.push(t),e.changedAlertEmails.length&&_.contains(e.changedAlertEmails,t)?_.contains(e.changedAlertEmails,t)&&(e.changedAlertEmails=_.without(e.changedAlertEmails,t)):e.changedAlertEmails.push(t)},e.addAlert=function(){function t(){e.newEmail=null,e.alertsForm.newEmail.$setViewValue(""),e.alertsForm.newEmail.$setPristine(),e.alertsForm.newEmail.$render()}if(!e.alertsForm.newEmail.$error.email){var r=e.newEmail.trim();if(r.toLowerCase()==e.getOwnerEmail().toLowerCase())return e.alertEmails.push(r),void t();_.find(e.allAlertEmails,function(e){return r.toLowerCase()==e.toLowerCase()})?e.alertEmails=_.union(e.alertEmails,r):(e.newAddedEmails++,e.alertEmails.push(r),e.allAlertEmails.push(r)),t()}},e.cancel=function(){e.isEditAlerts?e.isEditAlerts=!1:r.go("settings.editModeRule",{baseStationId:p,modeId:v,ruleId:h})},e.doneAlerts=function(){var t=_.find(e.getRule().actions,function(e){return"sendEmailAlert"===e.type});if(t&&!e.alertEmails.length){var r=e.getRule().actions.indexOf(t);e.getRule().actions.splice(r,1)}else e.alertEmails.length&&(t||(t=u.createDefaultEmailAction(),e.getRule().actions.push(t)),t.recipients=e.alertEmails);e.isEditAlerts=!1},e.isSelected=function(t){return _.contains(e.alertEmails,t)}}]).controller("FooterCtrl",["$scope","$rootScope","$window","$state","$stateParams","$modal","$filter","$timeout","appProperties","userService","calendarService","logoutService","dayService","libraryService","recordingsService","baseStationService","devicesService","uiService","billingFlowService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g,p,m,v,h,S){function y(e,t){e.confirmButton=o("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.init=function(t){e.listener=null,e.mode=t,e.showModes=!1,v.initDevices(),p.selectMode=!1,s(function(){var t=new ZeroClipboard(document.getElementById("copy-button"));t.on("ready",function(){t.on("aftercopy",function(){e.email=null})})});var n="Arlo is processing your request.",i="Are you sure you want to leave without finishing?";r.onbeforeunload=function(){return S.inProgress?n+"\n"+i:void 0}},e.canChangeMode=function(){return _.findWhere(v.getBaseStations(),{state:c.PROVISIONED_STATE})},e.canSelect=function(){var t=!v.isPureUser()&&(!p.selectMode||_.findWhere(p.recordings,{selected:!0}));return t||(e.email=!1),t},e.gotoCalendarView=function(){l.gotoCalendarView()},e.gotoLogout=function(){d.setFromLogout();var e=u.logout();e.then(function(){n.go("login")})},e.getRecording=function(){return p.current},e.isCurrentFavorite=function(){return p.isFavorite(e.getRecording())},e.onlyFavoriteSelected=function(){for(var t=0,r=0;r<p.recordings.length;r++)p.recordings[r].selected&&p.isFavorite(p.recordings[r])&&t++;var n=_.where(p.recordings,{selected:!0}).length==t;if(!p.selectMode){var i=e.getRecording();n=p.isFavorite(i)}return n},e.isFavorite=function(){if(p.selectMode){for(var t=!1,r=0;r<p.recordings.length;++r)if(t=t||p.recordings[r].selected,p.recordings[r].selected&&!p.isFavorite(p.recordings[r]))return!1;return t}return e.isCurrentFavorite()},e.favorite=function(){var r=new Array(p.recordings.length),n=!1;if(p.selectMode){for(var i=!e.isFavorite(),a=0;a<p.recordings.length;++a)p.recordings[a].selected&&(r[a]=i,n=!0);t.selectAllMode=!1}else{var o=p.recordings.indexOf(e.getRecording());r[o]=!p.isFavorite(e.getRecording()),n=!0}if(n){var s=p.favoriteRecordings(r,p.recordings);s.then(function(){p.selectMode?f.refreshData():p.toggleFavorite(e.getRecording())},function(){p.selectMode&&f.refreshData()})}},e.share=function(){if(e.email)return e.listener(),e.emailLoading=!1,void(e.email=!1);e.listener=e.$on(c.appEvents.BODY_CLICK,function(){e.email&&(e.emailLoading=!1,e.email=!1,e.listener())}),e.emailLoading=!0,e.email=null;var r=p.shareRecordings();r.then(function(t){e.email=t.data.email,e.link=t.data.copyLink||e.email.content.match(/https:\/\/.*arlo.*[\r\n]/g)[0]},function(e){e&&t.$broadcast(c.appEvents.SHOW_ERROR,e)})["finally"](function(){e.emailLoading=!1})},e.download=function(){if(p.selectMode){for(var r=0;r<p.recordings.length;++r)p.recordings[r].selected&&e.downloadLink(p.recordings[r]);t.selectAllMode=!1}else e.downloadLink(e.getRecording())},e.downloadLink=function(e){if(!Modernizr.adownload)return window.open(e.presignedContentUrl,"_blank"),!1;var t=document.createElementNS("http://www.w3.org/1999/xhtml","a");t.href=e.presignedContentUrl,t.download=e.reason+"."+e.contentType.split("/")[1],t.target="_blank";var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(r)},e.getRecordings=function(){return p.recordings&&e.favorites&&e.selectedCameras?_.filter(p.recordings,function(t){return("all"==e.favorites.value||"only"==e.favorites.value&&t.currentState==c.FAVORITE_STATE||"non"==e.favorites.value&&t.currentState!=c.FAVORITE_STATE)&&_.findWhere(e.selectedCameras,{deviceId:t.deviceId})}):[]},e["delete"]=function(){if(p.selectMode){if(this.onlyFavoriteSelected())return;var r=p.recordings,s=_.filter(r,function(e){return e.selected}),d=_.filter(s,function(e){return e.currentState==c.FAVORITE_STATE});if(s){e.message=o("i18n")("library_label_confirm_delete_media"),d&&(e.message+="<br/>"+o("i18n")("subscription_label_delete_all_unlocked_files_note"));var u=a.open({templateUrl:"partials/confirmDialog.html",controller:y,scope:e,backdrop:!0,resolve:{}});u.result.then(function(){var r=p.recycleRecordings(p.recordings),n=s.length-d.length;r.then(function(){var r=1==n?"1 file has been deleted.":n+" files have been deleted.";
h.info(r),f.refreshData(),t.selectAllMode=!1,n==e.getRecordings().length&&e.reloadCalendar(),v.getDevices()})})}}else{var g=e.getRecording();if(g.selected=!0,!p.isFavorite(g)){e.message=o("i18n")("library_label_confirm_delete_media");var u=a.open({templateUrl:"partials/confirmDialog.html",controller:y,scope:e,backdrop:!0,resolve:{}});u.result.then(function(){var t=p.recycleRecordings([g]);t.then(function(){var t="File has been deleted.",r=h.info(t);r.then(function(){var t=_.indexOf(p.recordings,p.current),r=_.indexOf(p.recordings,p.getNextContent(t,i)),a=_.indexOf(p.recordings,p.getPreviousContent(t,i));p.recordings.splice(t,1),p.persistRecordings(),g.recordingNumber!=r?e.$emit("recording-deleted",[t,r]):g.recordingNumber!=a?n.go("recording",{recordingNumber:a}):l.gotoCalendarView(),v.getDevices()})})})}}},y.$inject=["$scope","$modalInstance"],e.isVideo=function(){return e.getRecording().contentType==c.videoFormat},e.isRecordingMode=function(){return"recording"==e.mode||p.selectMode},e.sendEmail=function(){var t="mailto:?subject="+encodeURIComponent(e.email.subject)+"&body="+encodeURIComponent(e.email.content);e.email=null,window.location.href=t.length>2e3?t.substr(0,2e3):t},e.isFriendRecording=function(){if(p.selectMode)return!1;var t=_.findWhere(v.allDevices,{deviceId:e.getRecording().deviceId});return!t||t.userRole==c.USER_ROLE_USER}}]).controller("CalendarFilterCtrl",["$scope","$rootScope","$state","$filter","appProperties","calendarService","devicesService",function(e,t,r,n,i,a,o){e.init=function(){e.favoritesOptions=i.favoritesOptions,e.favorites=_.findWhere(i.favoritesOptions,{value:a.stateParams.favorites});var t=a.stateParams.cameraIds.split(",");t==i.CAMERAS_ALL_SELECTED&&(t=o.getAvailableCameraIds()),e.selectedCameras=_.filter(e.getCameras(),function(e){return-1!=t.indexOf(e.deviceId)})},e.getCameras=function(){return _.filter(o.allDevices,function(e){return e.deviceType==i.CAMERA_DEVICE_TYPE&&e.state==i.PROVISIONED_STATE||e.deviceType==i.CAMERA_DEVICE_TYPE&&e.mediaObjectCount})},e.favoritesChanged=function(t){e.favorites=t},e.camerasSelectionChanged=function(t){var r=e.selectedCameras.indexOf(t);r>-1?e.selectedCameras.splice(r,1):e.selectedCameras.push(t)},e.done=function(){a.stateParams.favorites=e.favorites.value,e.selectedCameras=n("orderBy")(e.selectedCameras,"deviceId"),a.stateParams.cameraIds=_.map(e.selectedCameras,function(e){return e.deviceId}).join(","),a.stateParams.cameraIds==o.getAvailableCameraIds()&&(a.stateParams.cameraIds=i.CAMERAS_ALL_SELECTED),a.gotoCalendarView()},e.isCameraSelected=function(t){return _.findWhere(e.selectedCameras,{deviceId:t})?!0:!1}}]).controller("RecycledDateCtrl",["$scope","$rootScope","$filter","$element","recordingsService",function(e,t,r,n,i){function a(){e.loading=!0,e.currentPage=1,o=_.where(i.recycled,{createdDate:e.createdDate}),e.pageCount=Math.ceil(o.length/d),s=o.slice(0,d)}var o,s,c,d=200;e.init=function(t,r){e.selectedAllRecycleRecordings=!1,e.expanded=!1,e.createdDate=t,e.promise.then(function(){r&&(e.expanded=!0,a())})["finally"](function(){e.loading=!1})},e.expand=function(){e.promise.then(function(){a()})["finally"](function(){e.loading=!1,e.expanded=!e.expanded})},e.getRecordings=function(){return s},e.nextPage=function(t){e.currentPage+=t,s=o.slice(d*(e.currentPage-1),d*e.currentPage),c=_.where(s,{selected:!0}),e.selectedAllRecycleRecordings=s.length==c.length?!0:!1},e.selectRecording=function(t){e.utcDate=i.recycled[t].utcCreatedDate,i.recycled[t].selected=!i.recycled[t].selected,c=_.where(s,{selected:!0}),e.selectedAllRecycleRecordings=c.length==s.length?!0:!1},e.toggleRecycleSelectAll=function(){e.selectedAllRecycleRecordings=!e.selectedAllRecycleRecordings,e.$emit(e.selectedAllRecycleRecordings?"selectAllRecycleRecordings":"unselectAllRecycleRecordings");for(var t=0;t<o.length;t++)o[t].selected=e.selectedAllRecycleRecordings?!0:!1}}]).controller("RecycledCtrl",["$scope","$rootScope","$filter","$stateParams","recordingsService","calendarService","dayService","appProperties","devicesService",function(e,t,r,n,i,a,o,s,c){e.init=function(){i.selectMode=!1,a.stateParams=angular.copy(n),o.day=a.stateParams.day,e.loading=!0,e.promise=i.getRecycleRecordings()["finally"](function(){e.getRecycleDates(),e.loading=!1}),t.$broadcast("recycleModeEnable")},e.getRecycleDates=function(){var t=i.recycled;e.dates=[];for(var r=0;r<t.length;r++)-1==_.indexOf(e.dates,t[r].createdDate)&&e.dates.push(t[r].createdDate)},e.restore=function(){var r=_.find(i.recycled,function(e){return e.selected});if(r){var n=i.restoreRecordings(i.recycled);n.then(function(){c.getDevices(),e.init(),e.reloadCalendar()},function(e){e&&t.$broadcast(s.appEvents.SHOW_ERROR,e)})}},e.gotoCalendarView=function(){e.$parent.selectMode=!1,e.reloadCalendar(),a.gotoCalendarView()},e.getSelectedCount=function(){return _.reduce(i.recycled,function(e,t){return t.selected&&e++,e},0)},e.isVideo=function(e){return e.contentType==s.videoFormat}}]).controller("AboutCtrl",["$scope","$modal","urlService",function(e,t,r){e.displayTos=function(){e.viewMode=!0,t.open({windowTemplateUrl:"partials/tosDialog.html",templateUrl:r.getTermsUrl(),scope:e,backdrop:!0})}}]).controller("CameraOrderCtrl",["$scope","$modal","$log","$state","$filter","appProperties","libraryService","devicesService","baseStationService","camerasService",function(e,t,r,n,i,a,o,s,c,d){function l(e,t){e.message=i("i18n")("camera_order_confirm_delete_camera").replace("{cameraName}",e.cameraName),e.confirmButton=i("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.init=function(){e.loading=!0,s.initDevices().then(function(){e.cameras=null,e.syncCameras=null,e.loading=!1,e.changed=!1,e.initialCamerasOrder="",_.forEach(e.getCameras(),function(t){e.initialCamerasOrder+=t.deviceId})})},e.$on("new_camera",function(){e.cameras=null}),e.getCameras=function(){return e.cameras?e.cameras:s.devices?(e.cameras=_.filter(angular.copy(s.devices),function(e){return e.deviceType==a.CAMERA_DEVICE_TYPE&&e.state==a.PROVISIONED_STATE}),e.sortDevices(),e.cameras):[]},e.isChanged=function(){return e.changed},e.compareSoortedDevices=function(){var t="";_.forEach(e.getCameras(),function(e){t+=e.deviceId}),e.changed=t!=e.initialCamerasOrder},e.getSyncCameras=function(){return e.syncCameras?e.syncCameras:s.devices?(e.syncCameras=_.filter(angular.copy(s.devices),function(e){return e.deviceType==a.CAMERA_DEVICE_TYPE&&e.state==a.SYNCED_STATE}),e.sortDevices(),e.syncCameras):[]},e.sortDevices=function(){e.cameras=i("orderBy")(e.cameras,"displayOrder")},e.done=function(){if(e.isChanged()){var t=d.setCameraOrder(e.cameras);t.then(function(){var e=s.getDevices();e.then(function(){n.go("settings")})})}},e.deleteCamera=function(n){e.cameraName=n.deviceName;var i=t.open({templateUrl:"partials/confirmDialog.html",controller:l,scope:e,backdrop:!0,resolve:{}});i.result.then(function(){var t=c.removeDevice(n.parentId,n.deviceId);t.then(function(){r.info("Camera have been deleted."),s.getDevices().then(function(){e.cameras=null});var t=s.getDeviceById(n.parentId);t&&t.state==a.PROVISIONED_STATE&&t.properties&&t.properties.connectionState==a.AVAILABLE_STATE&&(c.getBaseStationResource(n.parentId,"modes"),c.getBaseStationResource(n.parentId,"rules"))})})},l.$inject=["$scope","$modalInstance"]}]).controller("BaseStationCtrl",["$scope","$rootScope","$state","$stateParams","$modal","$q","$filter","appProperties","jsonService","baseStationService","devicesService","userService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){function g(e,t){e.message=o("i18n")("base_station_settings_confirm_restart").replace("{baseStationName}",l.getDeviceById(e.deviceId).deviceName),e.confirmButton=o("i18n")("base_station_settings_activity_restart"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}function p(e,t){e.message=o("i18n")("base_station_settings_confirm_deactivate").replace("{baseStationName}",l.getDeviceById(e.deviceId).deviceName),e.confirmButton=o("i18n")("base_station_settings_activity_deactivate"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.nameRegExp=/^[a-zA-Z0-9\s~!@#$%^&*()_+=,./<>?;:\-\\\|\[\]\{\"'\}]+$/,e.init=function(){e.changed=!1,e.deviceId=decodeURIComponent(n.baseStationId),l.initDevices().then(function(){m()})},e.$on(s.appEvents.BS_REBOOTED,function(t,r){var n=l.getDeviceById(r);n&&(n.properties.connectionState=s.UNAVAILABLE_STATE,_.each(_.where(l.devices,{parentId:e.deviceId}),function(e){e.properties.connectionState=s.UNAVAILABLE_STATE})),f.info("Base Station has been restarted")});var m=function(){return e.AFModes=[{id:0,value:o("i18n")("label_frequency_auto_value")},{id:1,value:o("i18n")("label_frequency_60")},{id:2,value:o("i18n")("label_frequency_50")}],e.baseStation=angular.copy(l.getBaseStationById(e.deviceId)),!e.baseStation||e.baseStation.state!=s.PROVISIONED_STATE&&e.baseStation.state!=s.SYNCED_STATE?void r.go("settings"):(e.baseStation.owner.ownerId!=u.userId?e.admin=!0:c.timeZones().then(function(t){e.timeZones=t.data;var r=0;if(e.baseStation.properties&&e.baseStation.properties.timeZone){if(e.timeZone=_.findWhere(e.timeZones,{id:e.baseStation.properties.timeZone}),e.baseStation=angular.copy(l.getBaseStationById(e.deviceId)),e.baseStation.properties.antiFlicker){var n=e.baseStation.properties.antiFlicker.mode,i=e.baseStation.properties.antiFlicker.autoDefault;e.AFMode=_.findWhere(e.AFModes,{id:n}),n||r||(e.AFMode.value=o("i18n")("label_frequency_auto").replace("{frequency}",_.findWhere(e.AFModes,{id:i}).value),r++)}e.initialAutoUpdateEnabled=e.baseStation.properties.autoUpdateEnabled,e.initialAFModeId=e.AFMode?e.AFMode.id:"",e.initialTimeZoneId=e.timeZone.id}e.$on(s._RESOURCE_UPDATE_,function(){if(e.baseStation=angular.copy(l.getBaseStationById(e.deviceId)),e.initialAutoUpdateEnabled=e.baseStation.properties.autoUpdateEnabled,e.baseStation.properties){if(e.timeZone=_.findWhere(e.timeZones,{id:e.baseStation.properties.timeZone}),e.baseStation.properties.antiFlicker){var t=e.baseStation.properties.antiFlicker.mode,n=e.baseStation.properties.antiFlicker.autoDefault;e.AFMode=_.findWhere(e.AFModes,{id:t}),t||r||(e.AFMode.value+=" ("+_.findWhere(e.AFModes,{id:n}).value+")",r++)}e.initialAFModeId=e.AFMode?e.AFMode.id:"",e.initialTimeZoneId=e.timeZone?e.timeZone.id:""}})}),void(e.baseStationName=e.baseStation.deviceName))};e.toggleAutoUpdate=function(){e.baseStation.properties.autoUpdateEnabled=!e.baseStation.properties.autoUpdateEnabled},e.isAntiFlickerAvailable=function(){return e.baseStation?e.baseStation.properties.antiFlicker:void 0},e.isBaseStationAvailable=function(){var t=l.getDeviceById(e.deviceId);return t&&t.properties&&t.properties.connectionState&&"available"==t.properties.connectionState?!0:(e.AFMode&&(e.AFMode=null),!1)},e.isBaseStationMotion=function(){if(l.devices){var t=!1;return _.each(l.devices,function(r){r.parentId!=e.deviceId||!r.properties||"startAlertStream"!=r.properties.activityState&&"alertStreamActive"!=r.properties.activityState||(t=!0)}),t}return!1},e.done=function(){if(e.isChanged()&&!e.cameraNameForm.name.$invalid){var t=d.renameDevice(e.baseStation);if(!e.admin&&e.isBaseStationAvailable()){var n=e.AFMode?d.setAntiFlickerMode(e.deviceId,e.AFMode.id):!0,i=d.setTimeZone(e.deviceId,e.timeZone),o=d.setAutoUpdate(e.deviceId,e.baseStation.properties.autoUpdateEnabled);a.all([t,n,i,o]).then(function(){l.getBaseStationById(e.deviceId).deviceName=e.baseStation.deviceName,d.getBaseStationResource(e.deviceId,"basestation")})}else t.then(function(){l.getBaseStationById(e.deviceId).deviceName=e.baseStation.deviceName});r.go("settings")}},e.isChanged=function(){if(!localStorage.fromLogout){var t=e.AFMode?e.AFMode.id!=e.initialAFModeId:!1;return l.getDeviceById(e.deviceId)&&"available"==l.getDeviceById(e.deviceId).properties.connectionState&&e.timeZone&&(e.changed=e.baseStationName!=e.baseStation.deviceName||e.initialAutoUpdateEnabled!=e.baseStation.properties.autoUpdateEnabled||e.initialTimeZoneId!=e.timeZone.id||t),l.getDeviceById(e.deviceId)&&"unavailable"==l.getDeviceById(e.deviceId).properties.connectionState&&(e.changed=e.baseStationName!=e.baseStation.deviceName),e.changed}},e.isLoading=function(){var t=l.getDeviceById(e.deviceId);return t&&t.state==s.SYNCED_STATE?!1:t&&t.properties.connectionState&&("available"==t.properties.connectionState&&e.timeZone||"unavailable"==t.properties.connectionState)?!1:!0},e.reboot=function(){var r=i.open({templateUrl:"partials/confirmDialog.html",controller:g,scope:e,backdrop:!0,resolve:{}});r.result.then(function(){d.restartBaseStation(e.deviceId).then(function(){},function(e){t.$broadcast(s.appEvents.SHOW_ERROR,e&&e.data&&e.data.message?e:{data:{message:"Base Station failed to restart."}})})})},g.$inject=["$scope","$modalInstance"],e.isBSRebooting=function(){return d.rebootingBS[e.deviceId]},e.deactivate=function(){var t=i.open({templateUrl:"partials/confirmDialog.html",controller:p,scope:e,backdrop:!0,resolve:{}});t.result.then(function(){var t=d.removeDevice(e.deviceId);t.then(function(){l.getDevices(),r.go("settings")})})},p.$inject=["$scope","$modalInstance"],e.gotoBSUpdate=function(){e.baseStation.properties.autoUpdateEnabled||r.go("settings.baseStation.update",{update:"update"})}}]).controller("BaseStationUpdateCtrl",["$scope","$rootScope","$state","$stateParams","$modal","$filter","$q","appProperties","jsonService","baseStationService","devicesService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u){e.init=function(){e.deviceId=decodeURIComponent(n.baseStationId);var t=l.getBaseStationById(e.deviceId);return t?void(e.$parent.update=!0):void e.back()},e.getUpdateAvailable=function(){var t=l.getBaseStationById(e.deviceId);return t&&"unavailable"==t.properties.connectionState&&r.go("settings.baseStation",{baseStationId:t.deviceId}),t.properties.updateAvailable},e.isBusy=function(){return _.some(l.devices,function(t){return t.deviceType==s.CAMERA_DEVICE_TYPE&&t.state==s.PROVISIONED_STATE&&t.parentId==e.deviceId&&t.properties&&t.properties.connectionState==s.AVAILABLE_STATE&&t.properties.activityState!=s.CAMERA_SETTINGS_ACTIVITYSTATE_IDLE?!0:!1})},e.updateClick=function(){var t=e.getUpdateAvailable().version;e.message=a("i18n")("manual_fw_update_confirm_update").replace("{fwVersion}",t),e.confirmMessage=a("i18n")("activity_label_update");var r=i.open({templateUrl:"partials/confirmDialog.html",controller:"ConfirmCtrl",scope:e,backdrop:!0,resolve:{}});r.result.then(function(){e.isBusy()?u.info(a("i18n")("base_station_error_4006")):(d.manualUpdate(e.deviceId,t),delete l.getBaseStationById(e.deviceId).properties.updateAvailable,u.info("Base Station upgrade has been started"))})},e.back=function(){e.$parent.update=!1,r.go("^")}}]).controller("SubscriptionCtrl",["$scope","$rootScope","$modal","$q","$state","$filter","appProperties","devicesService","baseStationService","recordingsService","servicePlanService","userService","billingFlowService","uiService",function(e,t,r,n,i,a,o,s,c,d,l,u,f,g){function p(e,t){e.message=a("i18n")("label_confirm_delete_unlocked_files"),e.confirmButton=a("i18n")("activity_delete"),e.confirm=function(){t.close()},e.cancelDialog=function(){t.dismiss("cancel")}}e.init=function(){f.selectServicePending=!1,e.planAmount="",e.storagePlanAmount="",e.updating=!0,e.loading=!0,e.notAccount=!window._ACCOUNT_;var r=[s.initDevices(),l.getPurchasedPlans(),l.getOffers(),l.getBilling()];n.all(r).then(function(){e.initValues(),e.updating=!1},function(r){e.updating=!1,t.$broadcast(o.appEvents.SHOW_ERROR,r)})["finally"](function(){e.loading=!1});var i=u.updateStorageQuota();i.then(function(){e.storageQuota=u.storageQuota}),i=d.getLibraryState()},e.$on(o.BILLING_EVENT,function(){e.init()}),e.initValues=function(){e.billingInfo=l.billingInfo,e.servicePlan=l.getServicePlan(),e.storageServicePlan=l.getStorageServicePlan(),e.cameras=_.where(s.devices,{deviceType:o.CAMERA_DEVICE_TYPE,userRole:"OWNER"});var t=e.servicePlan.maxCameras-e.cameras.length;e.offCameras=new Array(0>t?0:t),e.baseStations=_.where(s.getBaseStations(),{userRole:"OWNER"}),t=e.servicePlan.maxBaseStations-e.baseStations.length,e.offBaseStations=new Array(0>t?0:t);var r=l.isFreePlan(e.servicePlan);e.storage=e.servicePlan.maxStorage/o.ONE_MEGA,e.servicePlanExt=_.findWhere(l.servicePlans,{planId:e.servicePlan.planId}),e.servicePlanExt||(e.servicePlanExt=l.servicePlans[0]),e.freePlanId=_.find(l.servicePlans,function(e){return l.isFreePlan(e)}).planId,e.planAmount=r?"Free":("1"==e.servicePlan.term?"Monthly ":"12"==e.servicePlan.term?"Annual ":"")+e.servicePlan.planCurrencyAmount,e.storagePlanAmount=e.storageServicePlan&&("1"==e.storageServicePlan.term?"Monthly ":"12"==e.storageServicePlan.term?"Annual ":"")+e.storageServicePlan.planCurrencyAmount},e.cancelService=function(){f.processBillingEvent({cancel:!0}).then(function(){e.updating=!0,s.getDevices().then(function(){e.updating=!1,e.init()})},function(e){e&&t.$broadcast(o.appEvents.SHOW_ERROR,e)})},e.recycleBinEmpty=function(){if(d.libraryState){var e=_.findWhere(d.libraryState,{state:"new"});if(e)return 0===e.count;throw"No 'new' library state"}return!0},e.deleteAllFiles=function(){var t=r.open({templateUrl:"partials/confirmDialog.html",controller:p,scope:e,backdrop:!0,resolve:{}});t.result.then(function(){var t=d.deleteAllRecordings();t.then(function(){g.info("All unlocked recordings have been deleted"),s.getDevices(),d.getLibraryState();var t=u.updateStorageQuota();t.then(function(){e.storageQuota=u.storageQuota})})})},p.$inject=["$scope","$modalInstance"],e.isBillingInProgress=function(){return f.inProgress},e.isUpdateInProgress=function(){return e.updating},e.changeRenew=function(){e.updating=!0,l.getBilling().then(function(){l.changeRenew(e.billingInfo.autoRenew)["catch"](function(){e.billingInfo.autoRenew=!e.billingInfo.autoRenew})["finally"](function(){e.updating=!1})})}}]).controller("SubscriptionPlansCtrl",["$scope","$rootScope","$modal","$q","$state","$filter","$timeout","appProperties","servicePlanService","billingFlowService","devicesService","utilService",function(e,t,r,n,i,a,o,s,c,d,l,u){e.init=function(){d.pendingPlan=null,e.planAmount="",e.storagePlanAmount="",e.loading=!0;var r=[c.getPurchasedPlans(),c.getOffers(),c.getBilling()];n.all(r).then(function(){e.initValues()},function(e){t.$broadcast(s.appEvents.SHOW_ERROR,e)})["finally"](function(){e.loading=!1});var a=e.$on(s.BILLING_EVENT,function(){i.go("settings.subscription")});e.$on("$destroy",function(){a()})},e.initValues=function(){e.servicePlans=_.filter(c.servicePlans,function(e){return!c.isStoragePlan(e)}),e.servicePlan=c.getServicePlan(),e.selectPlan(e.servicePlan),e.storageServicePlan=c.getStorageServicePlan(),e.selectedStorage=e.storageServicePlan||{planId:0};var t=c.isFreePlan(e.servicePlan);e.storage=e.servicePlan.maxStorage/s.ONE_MEGA,e.servicePlanExt=_.findWhere(c.servicePlans,{planId:e.servicePlan.planId}),e.servicePlanExt||(e.servicePlanExt=c.servicePlans[0]),e.freePlanId=_.find(c.servicePlans,function(e){return c.isFreePlan(e)}).planId,e.planAmount=t?"Free":("1"==e.servicePlan.term?"Monthly ":"12"==e.servicePlan.term?"Annual ":"")+e.servicePlan.planCurrencyAmount,e.storagePlanAmount=e.storageServicePlan&&e.storageServicePlan.planId?("1"==e.storageServicePlan.term?"Monthly ":"12"==e.storageServicePlan.term?"Annual ":"")+e.storageServicePlan.planCurrencyAmount:""},e.isOldPlansSelected=function(){var t=[e.selectedPlan.planId];e.selectedStorage&&e.selectedStorage.planId&&t.push(e.selectedStorage.planId);var r=_.pluck(c.purchasedPlans,"planId");return r.length==t.length&&_.intersection(r,t).length==t.length?!0:void 0},e.changeService=function(){var r=[e.selectedPlan.planId];return e.selectedStorage&&e.selectedStorage.planId&&r.push(e.selectedStorage.planId),c.billingInfo.creditCard.cardNumber?void d.processBillingEvent({toPlanId:r}).then(function(){l.getDevices(),c.getPurchasedPlans(),i.go("settings.subscription")},function(e){return e&&e.data&&("8059"==e.data.error.toString()||"8060"==e.data.error.toString())?(i.go("settings.billingInformation"),void o(function(){t.$broadcast(s.appEvents.SHOW_ERROR,e)},1e3)):void(e&&t.$broadcast(s.appEvents.SHOW_ERROR,e.data?e:{data:{message:e}}))}):(d.selectServicePending=!0,d.pendingPlan={toPlans:r},void i.go("settings.billingInformation"))},e.isBillingInProgress=function(){return d.inProgress},e.selectPlan=function(t){e.selectedPlan=t,e.selectedStorage=null;var r=c.isFreePlan(t);e.storagePlans=_.filter(c.servicePlans,function(t){return c.isStoragePlan(t)&&(r||t.term==e.selectedPlan.term)})},e.selectStorage=function(t){e.selectedStorage=t},e.goBack=function(){e.isShowDetails?e.isShowDetails=!e.isShowDetails:i.go("settings.subscription")},e.showDetails=function(){if(e.isShowDetails=!0,u.gaSend(window._ACCOUNT_?"AcctMgr_Subscription_LearnMore_web":"Subscription_LearnMore_web"),!e.detailsHTML){var r=c.getOffersDetails();r.then(function(t){var r=t.data.html.match(/<\s*style[^>]*>.*?<\s*\/style>/)[0],n=t.data.html.match(/<\s*body[^>]*>(.*?)<\s*\/body>/)[1];e.detailsHTML=r+n},function(e){t.$broadcast(s.appEvents.SHOW_ERROR,e)})}}}]).controller("PreferencesCtrl",["$scope","$state","userService",function(e,t,r){e.init=function(){e.autoUpdate=!1,e.loading=!0,e.changed=!1;var t=r.updatePreferences();t.then(function(){e.preferences=r.getPreferences(),e.loading=!1,e.initialStorageEnabled=e.preferences.storage.enabled,e.initialAlertsStoragealert=e.preferences.alerts.storageAlert,e.initialToggleLowBattery=e.preferences.alerts.lowBatteryAlert,e.initialStorageAutoDelete=e.preferences.storage.autoDelete})},e.isChanged=function(){return e.preferences?e.changed=e.initialStorageEnabled!=e.preferences.storage.enabled||e.initialAlertsStoragealert!=e.preferences.alerts.storageAlert||e.initialToggleLowBattery!=e.preferences.alerts.lowBatteryAlert||e.initialStorageAutoDelete!=e.preferences.storage.autoDelete:void 0},e.done=function(){e.isChanged()&&(r.setPreferences(e.preferences),t.go("settings"))},e.toggleStorage=function(){e.preferences.storage.enabled=!e.preferences.storage.enabled},e.toggleStorageFull=function(){e.preferences.alerts.storageAlert=!e.preferences.alerts.storageAlert},e.toggleLowBattery=function(){e.preferences.alerts.lowBatteryAlert=!e.preferences.alerts.lowBatteryAlert},e.setAutoDelete=function(t){e.preferences.storage.autoDelete=t}}]).controller("AlertErrorCtrl",["$scope","$state","$timeout","appProperties",function(e,t,r,n){e.timeout=1e4,e.hidden2=!0,e.animation=!1,e.$on(n.appEvents.SHOW_ERROR,function(t,n){e.timeoutId&&clearTimeout(e.timeoutId),n&&n.data&&n.data.message&&(e.alertMessage=n.data.message,e.animation=!1,e.hidden2=!1,r(function(){e.animation=!0},0))}),e.$on(n.appEvents.HIDE_ERROR,function(){e.hide()}),e.$on(n.appEvents.BODY_CLICK,function(){e.hide()}),e.hide=function(){e.animation=!1,e.hidden2=!0},e.getType=function(){var e=t.current.name;return-1!=e.indexOf("settings")?window._ACCOUNT_?"settingsAccount":"settings":-1!=e.indexOf("claimBaseStation")||-1!=e.indexOf("accountRegistration")||-1!=e.indexOf("servicePlan")||-1!=e.indexOf("billingInformation")||-1!=e.indexOf("syncHardware")?"setup":-1!=e.indexOf("cameras")||-1!=e.indexOf("calendar")?"cameras":void 0}}]).controller("ShutdownCtrl",["$scope","gatewayPollingService","pushHandlerService",function(e,t,r){t.shutdown(),r.shutdown()}]).controller("motionTestCtrl",["$scope","$rootScope","$state","$stateParams","$filter","devicesService","cameraSettingsService",function(e,t,r,n,i,a,o){e.init=function(){var s=a.getCameraById(n.deviceId);return s?(e.percent=e.startPercent=s.properties.motionSetupModeSensitivity||80,o.updateSettings(s.parentId,s.deviceId,{motionSetupModeEnabled:!0,motionSetupModeSensitivity:e.percent}),e.offChangeStart=t.$on("$stateChangeStart",function(t,n,i,a){e.offChangeStart(),a.name==r.current.name&&o.updateSettings(s.parentId,s.deviceId,{motionSetupModeEnabled:!1})}),e.description=i("i18n")("label_motion_detection_test_description").replace("{cameraName}",e.getCameraName()).replace(/\n/g,"<br>"),e.camera=s,void e.$watch("camera.properties.motionSetupModeEnabled",function(){s.properties.motionSetupModeEnabled||o.updateSettings(e.camera.parentId,e.camera.deviceId,{motionSetupModeEnabled:!0})},!0)):void e.back()},e.back=function(){r.go("settings.camera",{deviceId:n.deviceId})},e.getCameraName=function(){return a.getDeviceName(n.deviceId)},e.sliderClick=function(t){var r=t.offsetX;if(!t.hasOwnProperty("offsetX"))var n=t.target||t.srcElement,i=n.getBoundingClientRect(),r=t.clientX-i.left;var a=100*(r-5)/angular.element(t.currentTarget).prop("offsetWidth");e.setPercent(a)},e.setPercent=function(t){e.percent=Math.round(t)||1},e.applySensivity=function(){var t=a.getCameraById(n.deviceId);t&&o.updateSettings(t.parentId,t.deviceId,{motionSetupModeSensitivity:e.percent,motionSetupModeEnabled:!0}),t.properties.motionSetupModeSensitivity=e.startPercent=e.percent}}]).controller("FooterModesCtrl",["$scope","$rootScope","$state","$modal","$filter","appProperties","userService","baseStationService","devicesService","uiService","scheduleValidationService","servicePlanService","calendarNamesService",function(e,t,r,n,i,a,o,s,c,d,l,u,f){function g(e){var t=m[Math.floor(e/v)].day;return t}function p(e,t){e.length||e.push({startTime:0,modeId:t[0].id}),e=_.sortBy(e,function(e){return e.startTime});var r=_.pluck(t,"id"),n=_.pluck(m,"day"),i=angular.copy(m),a=_.map(i,function(t){return t.schedule=_.chain(e).filter(function(e){return g(e.startTime)===t.day}).map(function(e){return e.color=h[_.indexOf(r,e.modeId)%h.length],e}).map(function(e){var r=_.indexOf(n,t.day)*v;return e.startTime-=r,e}).value(),t});return _.each(a,function(e,t){if(0===e.schedule.length){var r;r=0===t?_.find(angular.copy(a).reverse(),function(e){return e.schedule.length>0}):_.find(angular.copy(a).splice(0,t).reverse(),function(e){return e.schedule.length>0}),e.schedule[0]=r.schedule[r.schedule.length-1],e.schedule[0].startTime=0}}),_.map(a,function(e){if(!e.schedule.length||e.schedule[0].startTime){var t=0===_.indexOf(n,e.day)?6:_.indexOf(n,e.day)-1,i=a[t].schedule[a[t].schedule.length-1].modeId,o={startTime:0,modeId:i,color:h[_.indexOf(r,i)%h.length]};return e.schedule.unshift(o),e}}),a}var m=[{day:"Monday"},{day:"Tuesday"},{day:"Wednesday"},{day:"Thursday"},{day:"Friday"},{day:"Saturday"},{day:"Sunday"}],v=864e5,h=["#06a94e","#666666"],S=!1;e.init=function(){e.baseStation=null,e.devices=[],c.initDevices(!1).then(function(){e.updateModes()}),e.servicePlan=u.getServicePlan(),e.servicePlan||u.getPurchasedPlans().then(function(){e.servicePlan=u.getServicePlan()},function(e){t.$broadcast(a.appEvents.SHOW_ERROR,e)}),this.names=f.getCalendar()},e.$watch("baseStation.scheduleOn",function(){e.baseStation&&e.baseStation.hasOwnProperty("scheduleOn")&&S&&(S=!1)},!0),e.$watch("baseStation.activeMode",function(){e.baseStation&&e.baseStation.hasOwnProperty("activeMode")&&S&&(S=!1)},!0),e.isLoading=function(){var t=!1;return(!e.devices.length&&!e.deviceId||S||e.baseStation&&e.baseStation.userRole==a.USER_ROLE_OWNER&&!e.servicePlan)&&(t=!0),e.baseStation&&!e.baseStation.hasOwnProperty("scheduleOn")&&(t=!0),e.baseStation&&e.baseStation.hasOwnProperty("scheduleOn")&&!e.baseStation.scheduleOn&&!e.baseStation.hasOwnProperty("modes")&&(t=!0),e.baseStation&&e.baseStation.hasOwnProperty("scheduleOn")&&e.baseStation.scheduleOn&&!e.baseStation.hasOwnProperty("schedule")&&(t=!0),t&&e.baseStation&&e.baseStation.properties.connectionState==a.UNAVAILABLE_STATE?(e.init(),!1):t},e.isStateUnavailable=function(e){return!e.properties||!e.properties.hasOwnProperty("connectionState")},e.updateModes=function(){e.deviceId=null;var t=_.where(c.getBaseStations(),{state:a.PROVISIONED_STATE});t.length&&(1==t.length&&t[0].properties&&t[0].properties.connectionState==a.AVAILABLE_STATE?e.updateMode(t[0]):(e.modes=[],e.devices=t))},e.updateMode=function(t){e.baseStation=t,t&&(e.deviceId=t.deviceId,t.modes?e.modes=t.modes:s.getBaseStationResource(e.deviceId,"modes"),t.schedule||s.getBaseStationResource(e.deviceId,"schedule")),e.$on(a._RESOURCE_UPDATE_,function(){if(e.deviceId){var t=c.getBaseStationById(e.deviceId);t&&t.modes&&(e.modes=t.modes)}})},e.isBaseStationOffline=function(){return e.baseStation&&e.baseStation.properties&&"unavailable"==e.baseStation.properties.connectionState},e.selectMode=function(t){if(t.id!=e.getActiveMode().id){var r={};S=!0,r[a.DEVICE_SETTINGS_ACTIVE]=t.id,s.setActiveMode(e.deviceId,r)}},e.selectBS=function(t){t.properties&&"available"==t.properties.connectionState&&(e.scheduleChanged=!1,e.devices=[],e.updateMode(t))},e.getActiveMode=function(){return c.getBaseStationById(e.deviceId).activeMode},e.toggleScheduleOn=function(){var t=e.baseStation,r={};r[a.DEVICE_SETTINGS_ACTIVE]=t.scheduleOn?!1:!0,S=!0,e.daySchedules=null;var n=s.toggleScheduleOn(t.deviceId,r);n.then(function(){})},e.isScheduleOn=function(){return s.isScheduleOn(e.baseStation)},e.getDaySchedule=function(){if(e.daySchedules)return e.daySchedules;var t=c.getBaseStationById(e.deviceId);return y(t)?(e.scheduleChanged=!1,e.daySchedules=p(angular.copy(t.schedule),t.modes),e.origSchedules=angular.copy(e.daySchedules),e.modes=t.modes,e.daySchedules):null},e.isScheduleChanged=function(){if(e.scheduleChanged)return!0;if(e.daySchedules)for(var t=0;t<e.daySchedules.length;t++){if(e.daySchedules[t].schedule.length!=e.origSchedules[t].schedule.length)return e.scheduleChanged=!0,!0;for(var r=0;r<e.daySchedules[t].schedule.length;r++)if(e.daySchedules[t].schedule[r].modeId!=e.origSchedules[t].schedule[r].modeId||e.daySchedules[t].schedule[r].startTime!=e.origSchedules[t].schedule[r].startTime)return e.scheduleChanged=!0,!0}},e.isScheduleAvailable=function(){return e.baseStation?"ADMIN"==e.baseStation.userRole||e.servicePlan&&e.servicePlan.schedule:!1};var y=function(e){return e&&e.schedule&&e.modes?_.uniq(_.pluck(e.schedule,"modeId")).length<=e.modes.length:!1};e.setColor=function(e){return{"background-color":h[e%h.length]}},e.saveSchedule=function(){var t=angular.copy(e.daySchedules),r=_.map(t,function(e,t){return e.schedule=_.map(e.schedule,function(e){return e.startTime+=24*t*60*60*1e3,_.omit(e,"color")}),e.schedule});r=_.flatten(r),l.validateSchedule(r)&&(s.setSchedule(e.deviceId,r),e.origSchedules=angular.copy(e.daySchedules),e.scheduleChanged=!1)}}]).controller("ModalNotifyCtrl",["$scope","$rootScope","$timeout","userService",function(e,t,r,n){e.posY=e.settingsOffsetTopPosition||0,e.popupDisable=null,null===n.calendarSessionPopup&&n.setCalendarSessionPopup(!0),null===n.rulesSessionPopup&&n.setRulesSessionPopup(!0),"false"===n.calendarClientPopup&&n.setCalendarSessionPopup(!1),"false"===n.rulesClientPopup&&n.setRulesSessionPopup(!1),e.isPopupEnable=e.$parent.libraryMode?n.calendarSessionPopup:n.rulesSessionPopup;var i,a,o;e.$on("settingsScrollingOn",function(){e.posY=e.settingsOffsetTopPosition;for(var t=0;t<i.length;t++)a[t].style.top=e.deltaY+i[t].offsetTop-e.posY+"px"}),e.getArrows=function(){return o?o:(i=document.getElementsByClassName("modal-arrowicon-rules"),a=document.getElementsByClassName("overlay-arrow-icon"),i.length&&r(function(){e.deltaY=44,o=[];for(var t=0;2>t;t++)o.push({posY:e.deltaY+i[t].offsetTop+e.posY+"px"})},100),null)},e.rulesNotifyHide=function(){e.$parent.libraryMode?(e.popupDisable?n.setCalendarClientPopup(!1):"",n.setCalendarSessionPopup(!1)):(e.popupDisable?n.setRulesClientPopup(!1):"",n.setRulesSessionPopup(!1)),e.isPopupEnable=!1}}]),angular.module("arloApp.filters",[]).filter("interpolate",["version",function(e){return function(t){return String(t).replace(/\%VERSION\%/gm,e)}}]).filter("monthText",["calendarNamesService",function(e){return function(t){if(!t)return"";var r=new Number(t.substring(4))-1,n=e.getCalendar().MONTH[r]+", "+t.substring(0,4);return n}}]).filter("dayText",["calendarNamesService",function(e){return function(t){var r=new Number(t.substring(4,6))-1,n=e.getCalendar().MONTH[r]+" "+t.substring(6)+", "+t.substring(0,4);return n}}]).filter("secToString",function(){return function(e){function t(e){return(10>e?"0":"")+e}var r=Math.floor(e%60),n=Math.floor(e/3600),i=Math.floor((e-3600*n)/60);
return t(n)+":"+t(i)+":"+t(r)}}).filter("ownDevices",function(){return function(e){return _.reduce(e,function(e,t){return t.userId===t.owner.ownerId&&e.push(t.parentId),e},[])}}).filter("favorites",["libraryService","routeService","dayService","recordingsService",function(e,t,r,n){return function(e,i){if("undefined"!=e&&null!=e){for(var a=[],o=0;o<e.length;o++){var s=e[o];i.favorites&&"all"!=i.favorites.value?"only"==i.favorites.value&&n.isFavorite(s)?a.push(s):"non"!=i.favorites.value||n.isFavorite(s)||a.push(s):a.push(s)}return t.currentDayRoute=t.getDayRoute(r.day),a}}}]).filter("recycled",["libraryService","routeService","dayService",function(){return function(e){if("undefined"!=e&&null!=e){for(var t=[],r=0;r<e.length;r++){var n=e[r];n.recycle||t.push(n)}return t}}}]).filter("toUTC",function(){return function(e){return e+6e4*(new Date).getTimezoneOffset()}}).filter("toBSTime",function(){return function(e,t){try{return e?e+6e4*((new Date).getTimezoneOffset()-new timezoneJS.Date(e,t).getTimezoneOffset()):""}catch(r){return e}}}).filter("motionLevel",["appProperties","camerasService",function(e,t){return function(r){return r&&t.isCameraOnline(r)&&r.properties.activityState!=e.CAMERA_SETTINGS_ACTIVITYSTATE_ACTIVESTREAM?t.isMotionActive(r)?e.CSS_CAMERA_MOTION_ACTIVE:t.isCameraArmed(r)?e.CSS_CAMERA_MOTION_ARMED:e.CSS_CAMERA_MOTION_DISABLED:e.CSS_CAMERA_MOTION_DISABLED}}]).filter("batteryLevel",["appProperties",function(){return function(e){var t;return t=e&&e.properties&&e.properties.hasOwnProperty("batteryLevel")?e.properties.batteryLevel:100,t>60?"3":t>15?"2":t>0?"1":"0"}}]).filter("signalLevel",function(){return function(e){var t;return t=e&&e.properties&&e.properties.signalStrength?-1==e.properties.signalStrength?1:e.properties.signalStrength:4}}).filter("brightLevel",function(){return function(e){if(e&&e.properties.brightness){if(e.properties.brightness<0)return 0;if(e.properties.brightness>0)return 2}return 1}}).filter("planAmount",["servicePlanService",function(e){return function(t){return e.isFreePlan(t)?"Free":("1"==t.term?"Monthly ":"12"==t.term?"Annual ":"")+(t.planCurrencyAmount||t.amount)}}]).filter("storageSize",function(){return function(e){if(0==e)return 0;var t=1024,r=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],n=Math.floor(Math.log(e)/Math.log(t));return e/Math.pow(t,n)+" "+r[n]}}),angular.module("arloApp.directives",[]).directive("scheduleHours",["$window","$timeout","calendarNamesService",function(e,t,r){return{link:function(n,i){function a(){s.height=i[0].offsetHeight;for(var e=1;24>e;e++){var t,r=Math.ceil(e*s.height/24);11>=e?t=e+" "+o[0]:12==e?t=e+" "+o[1]:e>12&&(t=e-12+" "+o[1]),c.fillText(t,20,r+1),c.moveTo(65,r-1),c.lineTo(70,r-1),c.stroke()}}var o=r.getCalendar().AMPMS,s=i[0],c=s.getContext("2d");c.fillStyle="#fff",c.fillRect(0,0,70,720),c.font="12px MorebiRounded-Regular, Arial",c.strokeStyle="#ccc",c.lineWidth=1;var d=angular.element(e);n.$watch(function(){return{w:d[0].innerWidth+"-"+d[0].innerHeight}},function(){a()},!0),n.$watch("baseStation.scheduleOn",function(e){e&&t(a,100)},!0),d.bind("resize",function(){n.$apply()})}}}]).directive("mode",[function(){var e=function(e){(e.originalEvent||e).dataTransfer.effectAllowed="move";var t={modeId:e.currentTarget.getAttribute("mode-id")};try{e.dataTransfer.setData("text/plain",JSON.stringify(t))}catch(r){e.dataTransfer.setData("text",JSON.stringify(t))}},t=function(e){e.preventDefault()};return{restrict:"A",link:function(r,n){n.bind("dragstart",e),n.bind("dragend",t)}}}]).directive("daySchedule",["$window","$log","$timeout","calendarNamesService",function(e,t,r,n){return{restrict:"A",scope:{daySchedule:"=",modes:"="},link:function(i,a){function o(e,t,r,n){for(var a,o,s=0,l=0;l<i.daySchedule.schedule.length;l++){if(o=i.daySchedule.schedule.length===l+1?w.height:c(i.daySchedule.schedule[l+1].startTime),t>=s&&o>t){a=l;break}s=o}var u=(s+o)/2,f=P[_.indexOf(O,n)%P.length];u>t?a&&i.daySchedule.schedule[a-1].modeId===n?i.daySchedule.schedule[a].startTime=d(u):(i.daySchedule.schedule[a].startTime=d(u),i.daySchedule.schedule.push({modeId:n,startTime:d(s),color:f})):a!==i.daySchedule.schedule.length-1&&i.daySchedule.schedule[a+1].modeId===n?i.daySchedule.schedule[a+1].startTime=d(u):i.daySchedule.schedule.push({modeId:n,startTime:d(u),color:f}),i.daySchedule.schedule=_.sortBy(i.daySchedule.schedule,function(e){return e.startTime})}function s(e,t){for(var r,n=0,a=0;a<i.daySchedule.schedule.length;a++){if(r=i.daySchedule.schedule.length===a+1?w.height:c(i.daySchedule.schedule[a+1].startTime),t>=n&&r>t)return i.daySchedule.schedule[a].modeId;n=r}}function c(e){var t=w.height;return Math.floor(e*t/C)}function d(e){var t=w.height;return 0>e?0:Math.floor(e*C/t)}function l(){w.width=a.parent()[0].offsetWidth,w.height=a.parent()[0].offsetHeight;for(var e,t=0,r=0,n=w.width,o=0;o<i.daySchedule.schedule.length;o++)e=i.daySchedule.schedule.length===o+1?w.height:c(i.daySchedule.schedule[o+1].startTime),R.beginPath(),R.fillStyle=i.daySchedule.schedule[o].color,R.fillRect(t,r,n,e),r=e,R.stroke();R.strokeStyle="#ccc";for(var s=1;24>s;s++){var l=Math.ceil(s*w.height/24);R.beginPath(),R.moveTo(0,l-1),R.lineTo(w.width,l-1),R.lineWidth=1,R.stroke()}R.font="bold 12px MorebiRounded-Regular, Arial",R.fillStyle="white";for(var f,g,p,m,v=8,h=8,o=0;o<i.daySchedule.schedule.length;o++){if(i.daySchedule.schedule.length==o+1){var S=c(i.daySchedule.schedule[o].startTime);g=Math.floor(0==o?w.height/2:S+(w.height-S)/2),p=i.daySchedule.schedule[o].startTime,m=d(w.height)}else g=Math.floor(c(i.daySchedule.schedule[o+1].startTime+i.daySchedule.schedule[o].startTime)/2),p=i.daySchedule.schedule[o].startTime,m=i.daySchedule.schedule[o+1].startTime;g-c(i.daySchedule.schedule[o].startTime)>10&&R.fillText(u(p)+" - "+u(m-6e4),h,g),f=g+=20,g-c(i.daySchedule.schedule[o].startTime)>40&&R.fillText(_.findWhere(i.modes,{id:i.daySchedule.schedule[o].modeId}).name,v,f),R.stroke()}R.strokeStyle="#000",R.lineWidth=6;for(var o=1;o<i.daySchedule.schedule.length;o++)r=e=c(i.daySchedule.schedule[o].startTime),R.beginPath(),R.moveTo(t,r),R.lineTo(n,e),R.stroke()}function u(e){e=Math.floor(e/6e4);var t="";return 0==e?t="12"+A[0]:e>0&&720>e?t=Math.floor(e/60)+":"+(10>e%60?"0"+e%60:e%60)+A[0]:e>=720&&780>e?t="12:"+(10>e%60?"0"+e%60:e%60)+A[1]:e>=780&&1440>e?t=Math.floor(e/60)-12+":"+(10>e%60?"0"+e%60:e%60)+A[1]:1440==e&&(t="12"+A[1]),t}function f(e){e&&(i.daySchedule.schedule=_.without(i.daySchedule.schedule,e));var t=[];_.each(i.daySchedule.schedule,function(e,r){(0==r||t[t.length-1].modeId!==e.modeId)&&t.push(e)}),i.daySchedule.schedule=t,l()}function g(e,t){for(var r=1;r<i.daySchedule.schedule.length;r++){var n=c(i.daySchedule.schedule[r].startTime)-3,a=c(i.daySchedule.schedule[r].startTime)+3;if(t>n&&a>t)return!0}return!1}function p(e){for(var t=1;t<i.daySchedule.schedule.length;t++){var r=c(i.daySchedule.schedule[t].startTime)-3,n=c(i.daySchedule.schedule[t].startTime)+3;if(e>r&&n>e)return c(i.daySchedule.schedule[t-1].startTime)}}function m(e){for(var t=1;t<i.daySchedule.schedule.length;t++){var r=c(i.daySchedule.schedule[t].startTime)-3,n=c(i.daySchedule.schedule[t].startTime)+3;if(e>r&&n>e)return t===i.daySchedule.schedule.length-1?w.height:c(i.daySchedule.schedule[t+1].startTime)}}function v(e){var t=_.find(i.daySchedule.schedule,function(t){return t.startTime<d(3+e)&&t.startTime>d(e-3)}),r=_.indexOf(i.daySchedule.schedule,t);return i.daySchedule.schedule[r-1]}function h(e){var t=_.find(i.daySchedule.schedule,function(t){return t.startTime<d(e+3)&&t.startTime>d(e-3)}),r=_.indexOf(i.daySchedule.schedule,t);return i.daySchedule.schedule[r]}function S(e){var t=e.target||e.srcElement,r=t.getBoundingClientRect(),n=e.clientX-r.left;return n}function y(e){var t=e.target||e.srcElement,r=t.getBoundingClientRect(),n=e.clientY-r.top;return n}var I,E,T,b,A=n.getCalendar().AMPMS,C=864e5,w=a[0],R=w.getContext("2d"),P=["#06a94e","#666666"],O=_.pluck(i.modes,"id"),M=!1,D=!1,N=!1,$=angular.element(e);i.$watch(function(){return{w:$[0].innerWidth+"-"+$[0].innerHeight}},function(){r(l,0)},!0),i.$watch("$parent.$parent.baseStation.scheduleOn",function(e){e&&r(l,0)},!0),$.bind("resize",function(){i.$apply()}),a.bind("dragenter",function(){return!1}),a.bind("dragover",function(e){return e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.dataTransfer.dropEffect="move",!1}),a.bind("drop",function(e){e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation();var r,n=S(e),a=y(e);try{r=JSON.parse(e.dataTransfer.getData("text/plain"))}catch(c){r=JSON.parse(e.dataTransfer.getData("text"))}if(r&&r.modeId){var d=r.modeId,l=s(n,a);return d!==l&&(t.debug("schedule before modifying:"+JSON.stringify(i.daySchedule)),o(n,a,l,d),f(),t.debug("schedule modified:"+JSON.stringify(i.daySchedule))),!1}}),a.on("mousemove",function(e){var t=S(e),r=y(e);if(g(t,r)||M){if(a.addClass("separator"),M)return r>I+3&&E-3>r?(b.startTime=d(r),D?(i.daySchedule.schedule.push(T),i.daySchedule.schedule=_.sortBy(i.daySchedule.schedule,function(e){return e.startTime}),D=!1):N&&(i.daySchedule.schedule.push(b),i.daySchedule.schedule=_.sortBy(i.daySchedule.schedule,function(e){return e.startTime}),N=!1)):I+3>=r&&!D?(b.startTime=d(I),i.daySchedule.schedule=_.without(i.daySchedule.schedule,T),D=!0):r>=E-3&&!N&&(b.startTime=d(E),i.daySchedule.schedule=_.without(i.daySchedule.schedule,b),N=!0),l(),e.preventDefault(),!1}else a.removeClass("separator")}),a.on("mousedown",function(e){var t=S(e),r=y(e);return g(t,r)?(M=!0,T=v(r),b=h(r),D=!1,N=!1,I=p(r),E=m(r),e.preventDefault(),!1):void 0}),angular.element(document.body).on("mouseup",function(e){if(M){{S(e),y(e)}M=!1,T&&b&&(T.startTime==b.startTime&&b.startTime==d(I)&&f(T),T.startTime==b.startTime&&b.startTime==d(E)&&f(b))}})}}}]).directive("brightness",["$window",function(){return{restrict:"A",scope:{widgetX:"@",imageUrl:"@",brightness:"="},link:function(e,t){function r(){n()}function n(){s.src&&(a.setAttribute("width",d),a.setAttribute("height",c),i(50))}function i(e){if(a.width>0&&a.height>0){for(var t=o.getImageData(0,0,a.width,a.height),r=t.data,n=0;n<r.length;n+=4)r[n]+=e,r[n+1]+=e,r[n+2]+=e;o.putImageData(t,0,0),o.drawImage(s,0,0,d,c)}}var a=t[0],o=a.getContext("2d"),s=new Image;s.src=e.imageUrl,s.addEventListener("load",r);var c,d=Math.round(e.widgetX);c=s.height&&s.width?Math.round(s.height*(e.widgetX/s.width)):9*e.widgetX/16,e.$watch("imageUrl",function(){return e.imageUrl?(s.src=e.imageUrl,void r()):void(s.src=null)})}}}]).directive("invert",["$window",function(){return{restrict:"A",scope:{widgetX:"@",imageUrl:"@",flip:"=",mirror:"="},link:function(e,t){function r(){n()}function n(){s.src&&(e.flip?(a.setAttribute("width",d),a.setAttribute("height",c),o.drawImage(s,0,0,d,c),i()):(a.setAttribute("width",d),a.setAttribute("height",c),o.drawImage(s,0,0,d,c)))}function i(){o.save(),o.translate(d/2,c/2),o.rotate(Math.PI),o.drawImage(s,-d/2,-c/2,d,c),o.restore()}var a=t[0],o=a.getContext("2d"),s=new Image;s.src=e.imageUrl,s.addEventListener("load",r);var c,d=Math.round(e.widgetX);c=s.height&&s.width?Math.round(s.height*(e.widgetX/s.width)):9*e.widgetX/16,e.$watch("imageUrl",function(){return e.imageUrl?(s.src=e.imageUrl,void r()):void(s.src=null)}),t.on("click",function(){e.flip=e.flip?!1:!0,e.mirror=e.flip,n()})}}}]).directive("zoomDisplay",["$window","$log","$rootScope","appProperties",function(e,t,r,n){return{restrict:"A",scope:{imageUrl:"@",tlX:"=",tlY:"=",brX:"=",brY:"=",widgetRule:"=",cameraId:"="},link:function(i,a){function o(e,t){b&&T&&(N=1,$=1,N=b/_,$=T/C,e.tlX=Math.floor(t.tlX*N),e.tlY=Math.floor(t.tlY*$),e.brX=Math.floor(t.brX*N),e.brY=Math.floor(t.brY*$))}function s(e,t,r,n){i.widgetRule?(i.tlX=Math.floor(e/N),i.tlY=Math.floor(t/$),i.brX=Math.floor(r/N),i.brY=Math.floor(n/$)):(i.tlX=16*Math.floor(e/N/16),i.tlY=9*Math.floor(t/$/9),i.brX=16*Math.floor(r/N/16),i.brY=9*Math.floor(n/$/9))}function c(){I(U.tlX,U.tlY,U.brX,U.brY)}function d(e){if(e.offsetX)return e.offsetX;var t=e.layerX;return t}function l(e){if(e.offsetY)return e.offsetY;var t=e.layerY;return t}function u(){var e=U.tlX+H.dx,t=U.tlY+H.dy,r=U.brX+H.dx,n=U.brY+H.dy;p(e,t,r,n)&&(s(e,t,r,n),U.tlX=e,U.tlY=t,U.brX=r,U.brY=n,c())}function f(){var e=U.tlX,t=U.tlY,r=U.brX,n=U.brY;J?(e+=H.dx,t+=H.dy):(r+=H.dx,n+=H.dy),p(e,t,r,n)&&g(e,t,r,n)&&(s(e,t,r,n),U.tlX=e,U.tlY=t,U.brX=r,U.brY=n,c())}function g(e,t,r,n){e/=N,t/=$,r/=N,n/=$;var a=r-e>=(i.widgetRule?M:w)&&P>=r-e&&n-t>=(i.widgetRule?M:R)&&O>=n-t;return a}function p(e,t,r,n){if(0>e||0>t)return!1;var i=Math.round(D.height*(b/D.width));return r>b||n>i?!1:!0}function m(e,t){return y(e,U.tlX,U.brX)&&y(t,U.tlY,U.brY)&&!v(e,t)}function v(e,t){return h(e,t)||S(e,t)}function h(e,t){return y(e,U.tlX,U.tlX+A)&&y(t,U.tlY,U.tlY+A)}function S(e,t){return y(e,U.brX-A,U.brX)&&y(t,U.brY-A,U.brY)}function y(e,t,r){return e>=t&&r>=e}function I(e,t,r,n){if(D.src){E.setAttribute("width",b),E.setAttribute("height",T);var i=E.getContext("2d");i.globalAlpha=.2,i.drawImage(D,0,0,b,T),i.globalAlpha=1,i.lineWidth=3,i.strokeStyle="#06a94e",i.beginPath(),i.moveTo(e,t),i.lineTo(r,t),i.lineTo(r,n),i.lineTo(e,n),i.closePath(),i.stroke(),i.save(),i.clip(),i.drawImage(D,0,0,b,T),i.restore(),i.fillStyle="#0f6d35",i.fillRect(e,t,A,A),i.fillRect(r-A,n-A,A,A)}}var E,T,b,A=16,C=720,_=1280,w=384,R=216,P=1280,O=720,M=144,D=new Image;D.src=i.imageUrl||"/img2/camera_thumb.png",E=a[0];var N,$,U={tlX:null,tlY:null,brX:null,brY:null},B=!0;i.brX>P&&(i.brX=1280),i.brY>O&&(i.brY=720),D.addEventListener("load",function(){o(U,i),c()}),D.addEventListener("error",function(){t.debug("error loading full frame snapshot"),D.src&&r.$broadcast(n.appEvents.TAKE_SNAPSHOT,i.cameraId),D.src="/img2/camera_thumb.png"}),i.$watch("tlX",function(){"undefined"!=typeof i.tlX&&B&&(i.brX>P&&(i.brX=1280),i.brY>O&&(i.brY=720),o(U,i),c(),B=!1)}),i.$watch("imageUrl",function(){D.src=i.imageUrl||"/img2/camera_thumb.png",t.debug("calling drawInitialImage from watch imageUrl handler"),"undefined"!=typeof i.tlX&&(o(U,i),c())});var V=angular.element(e);i.$watch(function(){return{w:V[0].innerWidth}},function(){b=a.parent()[0].offsetWidth,T=Math.round(9*b/16),o(U,i),c()},!0),V.bind("resize",function(){i.$apply()});var k=null,x=null,L=null,F=null,H={dx:0,dy:0},Y=!1,W=!1,J=!1;a.on("mousedown",function(e){e.preventDefault(),k=d(e),x=l(e),m(k,x)?Y=!0:v(k,x)&&(W=!0,J=h(k,x))}),a.on("dblclick",function(e){e.preventDefault(),i.tlX=0,i.tlY=0,i.brX=P,i.brY=O,o(U,i),c()}),a.on("mousemove",function(e){(Y||W)&&(L=d(e),F=l(e),H.dx=L-k,H.dy=F-x,k=L,x=F,W?(i.widgetRule||(H.dy=9*H.dx/16),f()):Y&&u())}),angular.element(document.body).on("mouseup",function(){(Y||W)&&(Y=!1,W=!1)})}}}]).directive("defaultImage",["$log",function(e){var t={link:function(t,r,n){r.bind("error",function(){e.warn("default image set on error"),angular.element(this).attr("src",n.defaultImage)})}};return t}]).directive("passwordVerify",[function(){return{require:"ngModel",scope:{passwordVerify:"="},link:function(e,t,r,n){e.ctrl=n,e.$watch("passwordVerify+ctrl.$viewValue",function(t){(t||""==t)&&n.$setValidity("newPasswordVerify",(e.passwordVerify||"")==e.ctrl.$viewValue)})}}}]).directive("cardNumber",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,n){var i=function(e){var t=e&&e.match(/^[\d]{16}$/);if(t){var r=e.split(""),i=r.pop();r=r.reverse();var a=_.reduce(r,function(e,t,r){return(r+1)%2&&(t*=2,t=t>9?t-9:t),e+=parseInt(t)},0);t=(10-a%10)%10===parseInt(i)}return n.$setValidity("cardNumber",t),e},a=function(e){var t=e&&e.match(/^[\d]{16}$/);if(t){var r=e.split(""),i=r.pop();r=r.reverse();var a=_.reduce(r,function(e,t,r){return(r+1)%2&&(t*=2,t=t>9?t-9:t),e+=parseInt(t)},0);t=(10-a%10)%10===parseInt(i)}return n.$setValidity("cardNumber",t),e};n.$parsers.unshift(i),n.$formatters.unshift(a)}}}).directive("cardCvv",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,n){var i=function(e){var t=e&&e.match(/^[\d]{3,4}$/);return n.$setValidity("cardCvv",t),e},a=function(e){var t=e&&e.match(/^[\d]{3,4}$/);return n.$setValidity("cardCvv",t),e};n.$parsers.unshift(i),n.$formatters.unshift(a)}}}).directive("cardExpiration",[function(){return{require:"ngModel",scope:{monthVerify:"="},link:function(e,t,r,n){e.$watch(function(){var t;return(e.monthVerify||n.$viewValue)&&(t=e.monthVerify+"_"+n.$viewValue),t},function(){var t=n.$viewValue;if(!t||n.$error.required||e.$parent.cardInformationForm.cc_exp_mm.$error.required||"0"==e.monthVerify)return n.$setValidity("cardExpiration",!0),n.$viewValue;var r=t.match(/^[\d]{4}$/);if(r){var i=new Date,a=i.getUTCMonth()+1,o=i.getUTCFullYear(),s=parseInt(e.monthVerify);r=100*n.$viewValue+s>=100*o+a}return r||e.$parent.cardInformationForm.cc_exp_mm.$setViewValue(e.$parent.cardInformationForm.cc_exp_mm.$viewValue),e.$parent.cardInformationForm.cc_exp_mm.$setValidity("cardExpiration",r),n.$viewValue})}}}]).directive("emailUsed",["$timeout","userService",function(e,t){return{restrict:"A",require:"ngModel",link:function(r,n,i,a){var o;return r.$watch(function(){return a.$modelValue},function(r){return e.cancel(o),!r||a.$error.email||a.$error.emailArlo||r==i.emailUsed?void a.$setValidity("used",!0):void(o=e(function(){t.checkEmailUsage(r).then(function(e){return a.$setValidity("used",a.$pristine||!e.data.arlo)},function(){return a.$setValidity("used",!0)})},400))})}}}]).directive("emailUnknown",["$timeout","userService",function(e,t){return{restrict:"A",require:"ngModel",link:function(r,n,i,a){var o;return r.$watch(function(){return a.$modelValue},function(r){return e.cancel(o),!r||a.$error.email?void a.$setValidity("unknown",!0):void(o=e(function(){t.checkEmailUsage(r).then(function(e){return a.$setValidity("unknown",e.data.data.used)},function(){return a.$setValidity("unknown",!0)})},400))})}}}]).directive("friendUnique",["$timeout","friendsService",function(e,t){return{restrict:"A",require:"ngModel",link:function(e,r,n,i){return e.$watch(function(){return i.$modelValue},function(e){if(!e||i.$error.email)return void i.$setValidity("unique",!0);var r=_.findWhere(t.friends,{email:e});return r?i.$setValidity("unique",!1):i.$setValidity("unique",!0)})}}}]).directive("toggle",[function(){return{restrict:"A",scope:{model:"="},link:function(e){e.$watch("model.value",function(){e.selected=e.model.value===e.$id?"active":""}),e.toggleMe=function(){e.model.value=e.$id}}}}]).directive("autoFillFix",[function(){return function(e,t,r){t.prop("method","POST"),r.ngSubmit&&setTimeout(function(){t.unbind("submit").bind("submit",function(n){n.preventDefault(),t.find("input").triggerHandler("change"),e.$apply(r.ngSubmit)})},0)}}]).directive("empty",[function(){return function(e,t){e.$watch(function(){return t.val().length?t.removeClass("empty"):t.addClass("empty")},!0)}}]).directive("sliderDrag",["$document",function(e){return function(t,r,n){function i(e){var t;t=e.pageX<c?0:e.pageX>d?100:100*(e.pageX-c)/(d-c),l.setSliderPosition&&(l.setSliderPosition(t),l.$apply()),l.setPercent&&(l.setPercent(t,n.sliderDrag),l.$apply())}function a(){e.unbind("mousemove",i),e.unbind("mouseup",a),e.unbind("mouseleave",a)}var o=0,s=0,c=0,d=0,l=t;r.on("mousedown",function(t){t.preventDefault();var n=r.parent()[0].offsetWidth-20,l=parseFloat(r.css("left"));c=t.pageX-l*n/100,d=c+n,o=t.pageX-s,e.on("mousemove",i),e.on("mouseup",a),e.on("mouseleave",a)})}}]).directive("recordingVideo",["$document","$timeout","$filter",function(){return function(e,t){t.on("timeupdate",function(){"$apply"!=e.$root.$$phase&&e.$apply(function(){e.time=t[0].currentTime,e.timePercent=t[0].duration?100*(t[0].currentTime/t[0].duration):0})}),t.on("ended",function(){t[0].pause(),e.$apply(function(){e.playing=!1})}),t.on("loadedmetadata",function(){e.$apply(function(){e.time=0,e.duration=t[0].duration,e.timePercent=0,e.isLoadingVideo=!1,e.play()})})}}]).directive("recordingBox",["$window","$timeout",function(e,t){return{link:function(r,n,i){function a(){var e=o[0].innerHeight,t=e-(i.hasOwnProperty("recordingShared")?160:274);n.css("height",t+"px"),n.css("width",1.7778*t+"px")}var o=angular.element(e);r.$watch(function(){return{w:o[0].innerHeight}},function(){a()},!0),o.bind("resize",function(){r.$apply()}),t(a)}}}]).directive("requiredTip",["$filter",function(){return{replace:!0,restrict:"E",template:"<div class='required-tip'>{{'label_required_fields' | i18n}}</div>"}}]).directive("cameraThumbnail",["$document","$timeout",function(){return function(e,t){t.on("error",function(){t[0].src="/img2/camera_thumb.png"})}}]).directive("cameraZoom",["$document","$timeout","appProperties",function(e,t){return function(r,n,i){function a(e){S=f+100*(e.screenX-l)/n[0].clientWidth/m,y=g+100*(e.screenY-u)/n[0].clientHeight/m,d()}function o(e){Math.abs(e.screenX-l)<3&&Math.abs(e.screenY-u)<3&&r.$apply(function(){r.playing?r.pause():r.play()})}function s(){n.removeClass("arlo-move"),e.unbind("mousemove",a),e.unbind("mouseup",s),e.unbind("mouseleave",s)}function c(){var e=50*(m-1)/m;-e>S?S=-e:S>e&&(S=e),-e>y?y=-e:y>e&&(y=e)}function d(){c();var e="scale("+m+") translate(";e+=S+"%,",e+=y+"%)",p.css("transform",e)}var l,u,f,g,p,m=1,v=.2,h=10,S=0,y=0;t(function(){p=angular.element(document.getElementById(i.cameraZoom)),d()}),n.on("wheel",function(e){e.preventDefault();var t=e.deltaY||e.detail||e.wheelDelta,r=t/Math.abs(t);m=r>0?m+v:m-v,1>m?m=1:m>h?m=h:d()}),n.on("mousedown",function(t){l=t.screenX,u=t.screenY,1!=m&&(n.addClass("arlo-move"),t.preventDefault(),f=S,g=y,e.on("mousemove",a),e.on("mouseup",s),e.on("mouseleave",s))}),n.on("click",o)}}]).directive("sortable",["$document","$timeout","$log","$filter",function(e,t,r,n){return{restrict:"A",require:"?ngModel",scope:{ngModel:"="},link:function(e,r,i,a){e.$watch("ngModel",function(e){e&&e.length>1&&t(function(){r.updateSortable()},100)},!0);var o=r.sortable();o.on("sortupdate",function(t,r){e.$apply(function(){var t=n("orderBy")(a.$modelValue,"displayOrder");if(r.oldIndex<r.newIndex){t[r.oldIndex].displayOrder=r.newIndex+1;for(var i=r.oldIndex+1;i<r.newIndex+1;i++)t[i].displayOrder=i}else if(r.oldIndex>r.newIndex){t[r.oldIndex].displayOrder=r.newIndex+1;for(var i=r.newIndex;i<r.oldIndex;i++)t[i].displayOrder=i+2}e.$parent.sortDevices(),e.$parent.compareSoortedDevices()})})}}}]).directive("recordTimer",function(){return{restrict:"A",require:"ngModel",scope:{model:"=ngModel"},link:function(e,t,r){function n(){e.millis=new Date-e.startTime;var t=e.millis%1e3;i(),e.timeoutId=setTimeout(function(){n(),e.$digest()},e.interval-t)}function i(){var r=Math.floor(e.millis/1e3),n=Math.floor(r%60),i=Math.floor(r/3600),a=Math.floor((r-3600*i)/60),o=10>n?"0"+n:n,s=10>a?"0"+a:a,c=10>i?"0"+i:i;t.text(c+":"+s+":"+o)}e.isRunning=!1,e.interval=1e3,e.start=function(){e.startTime=new Date,n(),e.isRunning=!0},e.stop=function(){e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=null,e.isRunning=!1},t.bind("$destroy",function(){e.stop()}),e.$parent.$watch(r.ngModel,function(t){!e.isRunning&&t?e.start():e.isRunning&&!t&&e.stop()},!0)}}}).directive("bodyEvents",["$rootScope","appProperties",function(e,t){return function(r,n){n.on("click",function(r){e.$broadcast(t.appEvents.BODY_CLICK,r)})}}]).directive("scrollTop",["$rootScope","$uiViewScroll","appProperties",function(e,t,r){return function(n,i){e.$on(r.appEvents.SCROLL_TOP,function(){t(i)})}}]).directive("emailArlo",function(){return{restrict:"A",require:"ngModel",link:function(e,t,r,n){var i=/^(?!.{191})[\w!#$%&'*+/=?`{|}~^-]+(?:\.[\w!#$%&'*+/=?`{|}~^-]+)*@?(?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,6}$/,a=function(e){var t=e&&e.match(i);return n.$setValidity("emailArlo",t),e},o=function(e){var t=e&&e.match(i);return n.$setValidity("emailArlo",t),e};n.$parsers.unshift(a),n.$formatters.unshift(o)}}}).directive("selectRecording",function(){return function(e,t){t.on("click",function(){e.$parent.selectRecording(e.recording.recordingNumber),e.recording.selected?t.addClass("vlist-preview-selected"):t.removeClass("vlist-preview-selected"),e.$parent.$apply()})}}).directive("selectAllRecordings",["$rootScope",function(e){return function(t,r){e.$on("selectAllRecordings",function(){for(var e=t.$parent.getRecordings(),n=0;n<e.length;n++)t.$parent.isFriendRecording(e[n])||r.children().children().eq(n).addClass("vlist-preview-selected")})}}]).directive("selectAllRecycleRecordings",function(){return function(e,t){e.$on("selectAllRecycleRecordings",function(){t.children().children().children().addClass("vlist-preview-selected")})}}).directive("unselectAllRecycleRecordings",function(){return function(e,t){e.$on("unselectAllRecycleRecordings",function(){t.children().children().children().removeClass("vlist-preview-selected")})}}).directive("recycleModeTrigger",function(){return function(e){e.$on("recycleModeEnable",function(){e.recycleModeEnable=!0}),e.$on("recycleModeDisable",function(){e.recycleModeEnable=!1})}}).directive("footerButtons",["$timeout","$filter",function(e,t){return{restrict:"A",link:function(e,r,n){function i(e,t){var r=i.canvas||(i.canvas=document.createElement("canvas")),n=r.getContext("2d");n.font=t||"12px MorebiRounded-Regular, Arial";var a=n.measureText(e);return Math.ceil(a.width)}function a(){var e=_.max(n.hasOwnProperty("selectBar")?[i(t("i18n")("select_bar_label_favorite")),i(t("i18n")("select_bar_label_share")),i(t("i18n")("select_bar_label_download")),i(t("i18n")("select_bar_label_delete")),30]:[i(t("i18n")("navigation_label_mode")),i(t("i18n")("navigation_label_cameras")),i(t("i18n")("navigation_label_library")),i(t("i18n")("navigation_label_settings")),30]);_.each(r.children(),function(t){angular.element(t.children[0]).css("width",e+"px")})}e.$on("localizeResourcesUpdated",function(){a()}),a()}}}]).directive("scrollPosition",["$document",function(){return function(e,t){t.on("scroll",function(t){e.scrollTopPosition(t.target.scrollTop)})}}]).directive("offers",["$rootScope","$filter",function(e){return{restrict:"A",link:function(t,r){t.$on("offers",function(t,n){r.html(n);var i=r.find("a");_.each(i,function(t){var r=t.href;if(-1!=r.indexOf("planId")){var n=r.split("?")[1].split("&"),i={};_.each(n,function(e){var t=e.split("=");i[t[0]]=t[1]}),angular.element(t).on("click",function(t){e.$broadcast("plan_selected",i),t.preventDefault()}),t.href=""}})})}}}]).directive("sharedPlayer",["$window","$timeout",function(e,t){return{link:function(r,n){function i(){var e=o.clientHeight,t=o.clientWidth;if(e>t)return n.css("width",""),void n.css("margin-left","");if(t=.7*t,e-=88,t/e>16/9){var r=16*e/9-10;r=r>220?r:220,n.css("width",r+"px"),n.css("margin-left",t-r-1+"px")}else n.css("width",""),n.css("margin-left","")}var a=angular.element(e),o=n.parent()[0];r.$watch(function(){return{w:""+a[0].innerHeight+a[0].innerWidth}},function(){i()},!0),a.bind("resize",function(){r.$apply()}),t(i,500)}}}]).directive("noSpace",function(){return{require:"ngModel",link:function(e,t,r,n){n.$parsers.push(function(e){var t=e.replace(/^[\s\u00A0u2028u2029]+/g,"");return t!=e&&(n.$setViewValue(t),n.$render()),t})}}});